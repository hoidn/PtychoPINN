============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.9.1+cu128
rootdir: /home/ollie/Documents/tmp/PtychoPINN
configfile: pyproject.toml
testpaths: tests
plugins: typeguard-2.13.3, anyio-4.9.0
collecting ... collected 569 items / 568 deselected / 2 skipped / 1 selected

tests/test_integration_workflow.py::TestFullWorkflow::test_train_save_load_infer_cycle FAILED [100%]

=================================== FAILURES ===================================
______________ TestFullWorkflow.test_train_save_load_infer_cycle _______________

self = <tests.test_integration_workflow.TestFullWorkflow testMethod=test_train_save_load_infer_cycle>

    def test_train_save_load_infer_cycle(self):
        """
        Tests the complete train -> save -> load -> infer workflow.
        This is the ultimate validation of the model save/restore cycle as it
        simulates a real user workflow across separate processes.
        """
        # --- 1. Define Paths ---
        data_file = project_root / "ptycho" / "datasets" / "Run1084_recon3_postPC_shrunk_3.npz"
        training_output_dir = self.output_path / "training_outputs"
        inference_output_dir = self.output_path / "lcls_output"
    
        # --- 2. Training Step ---
        print("--- Running Training Step (subprocess) ---")
        train_command = [
            sys.executable, str(project_root / "scripts" / "training" / "train.py"),
            "--train_data_file", str(data_file),
            "--test_data_file", str(data_file),
            "--output_dir", str(training_output_dir),
            "--nepochs", "2",
            "--n_images", "64",
            "--gridsize", "1", # Explicitly set for clarity
            "--quiet"
        ]
    
        train_result = subprocess.run(train_command, capture_output=True, text=True)
    
>       self.assertEqual(train_result.returncode, 0,
                         f"Training script failed with stdout:\n{train_result.stdout}\nstderr:\n{train_result.stderr}")
E       AssertionError: 1 != 0 : Training script failed with stdout:
E       2026-01-15 17:55:27,473 - INFO - Configuration setup complete
E       2026-01-15 17:55:27,473 - INFO - Final configuration: TrainingConfig(model=ModelConfig(N=64, gridsize=1, n_filters_scale=2, model_type='pinn', amp_activation='sigmoid', object_big=True, probe_big=True, probe_mask=False, pad_object=True, probe_scale=4.0, gaussian_smoothing_sigma=0.0), train_data_file=PosixPath('/home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz'), test_data_file=PosixPath('/home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz'), batch_size=16, nepochs=2, mae_weight=0.0, nll_weight=1.0, realspace_mae_weight=0.0, realspace_weight=0.0, nphotons=1000000000.0, n_groups=64, n_images=64, n_subsample=None, subsample_seed=None, neighbor_count=4, enable_oversampling=False, neighbor_pool_size=None, positions_provided=True, probe_trainable=False, intensity_scale_trainable=True, output_dir=PosixPath('/tmp/tmpwl5r68j3/training_outputs'), sequential_sampling=False, backend='tensorflow', torch_loss_mode='poisson')
E       2026-01-15 17:55:27,473 - INFO - Legacy mode: using 64 groups (gridsize=1)
E       2026-01-15 17:55:27,473 - INFO - Starting training with n_subsample=64, n_groups=64, stitching=disabled
E       2026-01-15 17:55:27,473 - INFO - Loading data from /home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz with n_images=64, n_subsample=64
E       2026-01-15 17:55:27,490 - INFO - Independent sampling: subsampling 64 images from 1087 total
E       2026-01-15 17:55:27,490 - INFO - Randomly subsampled 64 images
E       diff3d shape: (64, 64, 64)
E       probeGuess shape: (64, 64)
E       scan_index shape: (64,)
E       objectGuess shape: (227, 226)
E       xcoords shape: (64,)
E       ycoords shape: (64,)
E       xcoords_start shape: (64,)
E       ycoords_start shape: (64,)
E       2026-01-15 17:55:27,506 - INFO - Loading data from /home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz with n_images=None, n_subsample=None
E       2026-01-15 17:55:27,522 - INFO - Using full dataset of 1087 images
E       diff3d shape: (1087, 64, 64)
E       probeGuess shape: (64, 64)
E       scan_index shape: (1087,)
E       objectGuess shape: (227, 226)
E       xcoords shape: (1087,)
E       ycoords shape: (1087,)
E       xcoords_start shape: (1087,)
E       ycoords_start shape: (1087,)
E       2026-01-15 17:55:27,532 - INFO - Loaded test data from /home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz
E       2026-01-15 17:55:27,532 - INFO - Backend dispatcher: params.cfg synchronized with TrainingConfig (backend=tensorflow)
E       2026-01-15 17:55:27,532 - INFO - Backend dispatcher: routing to TensorFlow workflow (ptycho.workflows.components)
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] generate_grouped_data called with: nsamples=64, n_points=64, C=1, K=4
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Parameters: gridsize=1, N=64, sequential_sampling=False
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Oversampling flags: enable_oversampling=False, neighbor_pool_size=None, effective_K=4
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Oversampling check: nsamples > n_points = 64 > 64 = False
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Oversampling check: C > 1 = 1 > 1 = False
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] needs_oversampling = False
E       DEBUG: nsamples: 64, gridsize: 1 (using efficient random sample-then-group strategy)
E       2026-01-15 17:55:27,533 - INFO - Using efficient random sampling strategy for gridsize=1
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Taking efficient branch: standard sample-then-group
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] _generate_groups_efficiently called with: nsamples=64, K=4, C=1
E       2026-01-15 17:55:27,533 - INFO - Generating 64 groups efficiently from 64 points (K=4, C=1)
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Standard case: using 64 groups from 64 points
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Using all 64 points as seeds (no sampling needed)
E       2026-01-15 17:55:27,533 - INFO - Using all 64 points as seeds
E       2026-01-15 17:55:27,533 - INFO - Using seed indices directly for C=1 (gridsize=1) - no neighbor search needed
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] _generate_groups_efficiently completed: generated 64 groups
E       2026-01-15 17:55:27,533 - INFO - Successfully generated 64 groups with shape (64, 1)
E       2026-01-15 17:55:27,533 - INFO - [OVERSAMPLING DEBUG] Generated 64 groups in total
E       2026-01-15 17:55:27,533 - INFO - Generated 64 groups efficiently
E       INFO: 'Y' array not found. Generating ground truth patches from 'objectGuess' as a fallback.
E       neighbor-sampled diffraction shape (64, 64, 64, 1)
E       2026-01-15 17:55:28,864 - INFO - create_ptycho_data_container: increased max_position_jitter from 10 to 157 (required canvas=221, max|offset|=78.189)
E       loader: using provided ground truth patches.
E       INFO: None
E       <PtychoDataContainer X=(64, 64, 64, 1) mean=0.383 Y_I=(64, 64, 64, 1) mean=0.782 Y_phi=(64, 64, 64, 1) mean=-0.027 coords_nominal=(64, 1, 2, 1) mean=0.000 coords_true=(64, 1, 2, 1) mean=0.000 probe=(64, 64) mean_amplitude=0.322 norm_Y_I=<scalar> nn_indices=(64, 1) global_offsets=(64, 1, 2, 1) local_offsets=(64, 1, 2, 1)>
E       2026-01-15 17:55:29,160 - INFO - [OVERSAMPLING DEBUG] generate_grouped_data called with: nsamples=64, n_points=1087, C=1, K=4
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Parameters: gridsize=1, N=64, sequential_sampling=False
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Oversampling flags: enable_oversampling=False, neighbor_pool_size=None, effective_K=4
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Oversampling check: nsamples > n_points = 64 > 1087 = False
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Oversampling check: C > 1 = 1 > 1 = False
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] needs_oversampling = False
E       DEBUG: nsamples: 64, gridsize: 1 (using efficient random sample-then-group strategy)
E       2026-01-15 17:55:29,161 - INFO - Using efficient random sampling strategy for gridsize=1
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Taking efficient branch: standard sample-then-group
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] _generate_groups_efficiently called with: nsamples=64, K=4, C=1
E       2026-01-15 17:55:29,161 - INFO - Generating 64 groups efficiently from 1087 points (K=4, C=1)
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Standard case: using 64 groups from 1087 points
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Randomly sampled 64 seed points
E       2026-01-15 17:55:29,161 - INFO - Sampled 64 seed points from 1087 total points
E       2026-01-15 17:55:29,161 - INFO - Using seed indices directly for C=1 (gridsize=1) - no neighbor search needed
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] _generate_groups_efficiently completed: generated 64 groups
E       2026-01-15 17:55:29,161 - INFO - Successfully generated 64 groups with shape (64, 1)
E       2026-01-15 17:55:29,161 - INFO - [OVERSAMPLING DEBUG] Generated 64 groups in total
E       2026-01-15 17:55:29,161 - INFO - Generated 64 groups efficiently
E       INFO: 'Y' array not found. Generating ground truth patches from 'objectGuess' as a fallback.
E       neighbor-sampled diffraction shape (64, 64, 64, 1)
E       2026-01-15 17:55:29,463 - INFO - create_ptycho_data_container: increased max_position_jitter from 157 to 159 (required canvas=223, max|offset|=79.107)
E       loader: using provided ground truth patches.
E       INFO: None
E       <PtychoDataContainer X=(64, 64, 64, 1) mean=0.384 Y_I=(64, 64, 64, 1) mean=0.777 Y_phi=(64, 64, 64, 1) mean=-0.046 coords_nominal=(64, 1, 2, 1) mean=0.000 coords_true=(64, 1, 2, 1) mean=0.000 probe=(64, 64) mean_amplitude=0.322 norm_Y_I=<scalar> nn_indices=(64, 1) global_offsets=(64, 1, 2, 1) local_offsets=(64, 1, 2, 1)>
E       DEBUG: Setting probe to tf.Tensor(
E       [[[-0.00399459+8.81725922e-03j]
E         [ 0.00787074+1.04518672e-02j]
E         [-0.01909852+2.85197329e-03j]
E         ...
E         [-0.00430549-1.44718047e-02j]
E         [ 0.00670903+2.63100304e-02j]
E         [-0.01938361-6.67245360e-03j]]
E       
E        [[ 0.00921909+5.32836141e-03j]
E         [ 0.00422684-1.61591489e-02j]
E         [-0.00324812+1.62756350e-02j]
E         ...
E         [-0.00462818-2.68168072e-03j]
E         [ 0.01194528-6.69307355e-03j]
E         [ 0.0090712 -3.79238278e-03j]]
E       
E        [[ 0.0029482 -1.10371104e-02j]
E         [-0.01489174+5.26464824e-03j]
E         [-0.00083129+1.31990444e-02j]
E         ...
E         [ 0.00208769+1.68677475e-02j]
E         [ 0.00556216-3.03630810e-02j]
E         [ 0.01604221+1.45274084e-02j]]
E       
E        ...
E       
E        [[ 0.01654117+3.83263193e-02j]
E         [-0.01336122+7.02320365e-04j]
E         [-0.00380601-8.65837932e-03j]
E         ...
E         [ 0.01785212+2.66705058e-03j]
E         [-0.01791506+7.16461660e-03j]
E         [ 0.01052329-2.80616116e-02j]]
E       
E        [[-0.02582748-2.17778888e-05j]
E         [ 0.0098637 -3.15875164e-03j]
E         [-0.0156169 +2.47947779e-02j]
E         ...
E         [-0.01378679-1.89308310e-03j]
E         [ 0.00439025-1.43125653e-02j]
E         [ 0.02400579-1.19637549e-02j]]
E       
E        [[-0.00013256-1.32157737e-02j]
E         [ 0.03951043+1.84629709e-02j]
E         [-0.00848375+3.90608120e-03j]
E         ...
E         [-0.00414446+2.40438167e-04j]
E         [ 0.01858319+1.01260375e-02j]
E         [ 0.01299333+1.25071155e-02j]]], shape=(64, 64, 1), dtype=complex64) in params
E       DEBUG: Setting intensity_scale to 988.21173 in params
E       DEBUG: Setting probe to tf.Tensor(
E       [[[-0.00399459+8.81725922e-03j]
E         [ 0.00787074+1.04518672e-02j]
E         [-0.01909852+2.85197329e-03j]
E         ...
E         [-0.00430549-1.44718047e-02j]
E         [ 0.00670903+2.63100304e-02j]
E         [-0.01938361-6.67245360e-03j]]
E       
E        [[ 0.00921909+5.32836141e-03j]
E         [ 0.00422684-1.61591489e-02j]
E         [-0.00324812+1.62756350e-02j]
E         ...
E         [-0.00462818-2.68168072e-03j]
E         [ 0.01194528-6.69307355e-03j]
E         [ 0.0090712 -3.79238278e-03j]]
E       
E        [[ 0.0029482 -1.10371104e-02j]
E         [-0.01489174+5.26464824e-03j]
E         [-0.00083129+1.31990444e-02j]
E         ...
E         [ 0.00208769+1.68677475e-02j]
E         [ 0.00556216-3.03630810e-02j]
E         [ 0.01604221+1.45274084e-02j]]
E       
E        ...
E       
E        [[ 0.01654117+3.83263193e-02j]
E         [-0.01336122+7.02320365e-04j]
E         [-0.00380601-8.65837932e-03j]
E         ...
E         [ 0.01785212+2.66705058e-03j]
E         [-0.01791506+7.16461660e-03j]
E         [ 0.01052329-2.80616116e-02j]]
E       
E        [[-0.02582748-2.17778888e-05j]
E         [ 0.0098637 -3.15875164e-03j]
E         [-0.0156169 +2.47947779e-02j]
E         ...
E         [-0.01378679-1.89308310e-03j]
E         [ 0.00439025-1.43125653e-02j]
E         [ 0.02400579-1.19637549e-02j]]
E       
E        [[-0.00013256-1.32157737e-02j]
E         [ 0.03951043+1.84629709e-02j]
E         [-0.00848375+3.90608120e-03j]
E         ...
E         [-0.00414446+2.40438167e-04j]
E         [ 0.01858319+1.01260375e-02j]
E         [ 0.01299333+1.25071155e-02j]]], shape=(64, 64, 1), dtype=complex64) in params
E       Current Parameters:
E       --------------------
E       N: 64
E       amp_activation: sigmoid
E       backend: tensorflow
E       batch_size: 16
E       bigN: 64
E       big_gridsize: 10
E       data_source: generic
E       debug: True
E       default_probe_scale: 0.7
E       enable_oversampling: False
E       gaussian_smoothing_sigma: 0.0
E       gridsize: 1
E       h5_path: wts.h5
E       intensity_scale: 988.2117309570312
E       intensity_scale.trainable: True
E       label: 
E       mae_weight: 0.0
E       max_position_jitter: 159
E       model_type: pinn
E       n_filters_scale: 2
E       n_groups: 64
E       n_images: 64
E       neighbor_count: 4
E       nepochs: 2
E       nimgs_test: 3
E       nimgs_train: 9
E       nll_weight: 1.0
E       nphotons: 1000000000.0
E       npseed: 42
E       object.big: True
E       offset: 4
E       outer_offset_test: None
E       outer_offset_train: None
E       output_prefix: /tmp/tmpwl5r68j3/training_outputs
E       pad_object: True
E       positions.provided: True
E       probe:
E         shape: (64, 64, 1)
E         mean: -0.016-0.002j
E         std: 0.666
E         min: -3.769-0.236j
E         max: 2.823-0.116j
E       probe.big: True
E       probe.mask: False
E       probe.trainable: False
E       probe_scale: 4.0
E       realspace_mae_weight: 0.0
E       realspace_weight: 0.0
E       sequential_sampling: False
E       set_phi: False
E       sim_jitter_scale: 0.0
E       size: 392
E       test_data_file_path: /home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz
E       torch_loss_mode: poisson
E       train_data_file_path: /home/ollie/Documents/tmp/PtychoPINN/ptycho/datasets/Run1084_recon3_postPC_shrunk_3.npz
E       tv_weight: 0.0
E       use_xla_translate: True
E       DEBUG _flat_to_channel: gridsize from global params: 1
E       DEBUG _flat_to_channel: N from global params: 64
E       DEBUG _flat_to_channel: input shape=(64, 64, 64, 1), reshaping to (-1, 1, 64, 64)
E       Epoch 1/2
E       DEBUG _flat_to_channel: gridsize from global params: 1
E       DEBUG _flat_to_channel: N from parameter: 223
E       DEBUG _flat_to_channel: input shape=(None, 222, 222, 1), reshaping to (-1, 1, 223, 223)
E       DEBUG _flat_to_channel: gridsize from global params: 1
E       DEBUG _flat_to_channel: N from parameter: 223
E       DEBUG _flat_to_channel: input shape=(None, 222, 222, 1), reshaping to (-1, 1, 223, 223)
E       DEBUG _flat_to_channel: gridsize from global params: 1
E       DEBUG _flat_to_channel: N from parameter: 223
E       DEBUG _flat_to_channel: input shape=(None, 222, 222, 1), reshaping to (-1, 1, 223, 223)
E       DEBUG _flat_to_channel: gridsize from global params: 1
E       DEBUG _flat_to_channel: N from parameter: 223
E       DEBUG _flat_to_channel: input shape=(None, 222, 222, 1), reshaping to (-1, 1, 223, 223)
E       2026-01-15 17:55:31,011 - ERROR - An error occurred during execution: Exception encountered when calling ProbeIllumination.call().
E       
E       [1mDimensions must be equal, but are 64 and 65 for '{{node functional_1/probe_illumination_1/mul}} = Mul[T=DT_COMPLEX64](functional_1/probe_illumination_1/ReadVariableOp, functional_1/padded_objs_with_offsets_1/strided_slice_9)' with input shapes: [1,64,64,1], [?,65,65,1].[0m
E       
E       Arguments received by ProbeIllumination.call():
E         â€¢ inputs=['tf.Tensor(shape=(None, 65, 65, 1), dtype=complex64)']
E       
E       stderr:
E       2026-01-15 17:55:24.815456: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
E       WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E       E0000 00:00:1768528524.826376 2559018 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
E       E0000 00:00:1768528524.829946 2559018 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
E       W0000 00:00:1768528524.839231 2559018 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E       W0000 00:00:1768528524.839243 2559018 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E       W0000 00:00:1768528524.839245 2559018 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E       W0000 00:00:1768528524.839246 2559018 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E       I0000 00:00:1768528527.636399 2559018 gpu_process_state.cc:208] Using CUDA malloc Async allocator for GPU: 0
E       I0000 00:00:1768528527.637729 2559018 gpu_device.cc:2019] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 21970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 3090, pci bus id: 0000:04:00.0, compute capability: 8.6
E       WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E       I0000 00:00:1768528528.390800 2559018 service.cc:152] XLA service 0x48f8ace0 initialized for platform CUDA (this does not guarantee that XLA will be used). Devices:
E       I0000 00:00:1768528528.390820 2559018 service.cc:160]   StreamExecutor device (0): NVIDIA GeForce RTX 3090, Compute Capability 8.6
E       I0000 00:00:1768528528.427685 2559018 cuda_dnn.cc:529] Loaded cuDNN version 91002
E       I0000 00:00:1768528528.562063 2559018 device_compiler.h:188] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.
E       Traceback (most recent call last):
E         File "/home/ollie/Documents/tmp/PtychoPINN/scripts/training/train.py", line 440, in <module>
E           main()
E         File "/home/ollie/Documents/tmp/PtychoPINN/scripts/training/train.py", line 419, in main
E           recon_amp, recon_phase, results = run_cdi_example_with_backend(
E                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/workflows/backend_selector.py", line 141, in run_cdi_example_with_backend
E           recon_amp, recon_phase, results = tf_components.run_cdi_example(
E                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/workflows/components.py", line 913, in run_cdi_example
E           train_results = train_cdi_model(train_data, test_data, config)
E                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/workflows/components.py", line 793, in train_cdi_model
E           results = train_pinn.train_eval(PtychoDataset(train_container, test_container))
E                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/train_pinn.py", line 98, in train_eval
E           model_instance, history = train(ptycho_dataset.train_data)
E                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/train_pinn.py", line 94, in train
E           return model_instance, model.train(nepochs, train_data, model_instance=model_instance)
E                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/model.py", line 674, in train
E           history = model_instance.fit(
E                     ^^^^^^^^^^^^^^^^^^^
E         File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/keras/src/utils/traceback_utils.py", line 122, in error_handler
E           raise e.with_traceback(filtered_tb) from None
E         File "/home/ollie/Documents/tmp/PtychoPINN/ptycho/model.py", line 215, in call
E           illuminated = self.w * x
E                         ~~~~~~~^~~
E       ValueError: Exception encountered when calling ProbeIllumination.call().
E       
E       [1mDimensions must be equal, but are 64 and 65 for '{{node functional_1/probe_illumination_1/mul}} = Mul[T=DT_COMPLEX64](functional_1/probe_illumination_1/ReadVariableOp, functional_1/padded_objs_with_offsets_1/strided_slice_9)' with input shapes: [1,64,64,1], [?,65,65,1].[0m
E       
E       Arguments received by ProbeIllumination.call():
E         â€¢ inputs=['tf.Tensor(shape=(None, 65, 65, 1), dtype=complex64)']

tests/test_integration_workflow.py:56: AssertionError
----------------------------- Captured stdout call -----------------------------

Created temporary directory for test run: /tmp/tmpwl5r68j3
--- Running Training Step (subprocess) ---
Cleaned up temporary directory: /tmp/tmpwl5r68j3
=============================== warnings summary ===============================
../../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/tensorflow_addons/utils/tfa_eol_msg.py:23
  /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/tensorflow_addons/utils/tfa_eol_msg.py:23: UserWarning: 
  
  TensorFlow Addons (TFA) has ended development and introduction of new features.
  TFA has entered a minimal maintenance and release mode until a planned end of life in May 2024.
  Please modify downstream libraries to take dependencies from other repositories in our TensorFlow community (e.g. Keras, Keras-CV, and Keras-NLP). 
  
  For more information see: https://github.com/tensorflow/addons/issues/2807 
  
    warnings.warn(

../../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/tensorflow_addons/utils/ensure_tf_install.py:53
  /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/tensorflow_addons/utils/ensure_tf_install.py:53: UserWarning: Tensorflow Addons supports using Python ops for all Tensorflow versions above or equal to 2.13.0 and strictly below 2.16.0 (nightly versions are not supported). 
   The versions of TensorFlow you are currently using is 2.19.0 and is not supported. 
  Some things might work, some things might not.
  If you were to encounter a bug, do not file an issue.
  If you want to make sure you're using a tested and supported configuration, either change the TensorFlow version or the TensorFlow Addons's version. 
  You can find the compatibility matrix in TensorFlow Addon's readme:
  https://github.com/tensorflow/addons
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
SKIPPED [1] tests/test_benchmark_throughput.py:11: scripts/benchmark_inference_throughput.py not found. This is a pre-existing broken test dependency. Add to fix_plan.md for future resolution.
SKIPPED [1] tests/test_run_baseline.py:4: tests/test_utilities.py not found. This is a pre-existing broken test dependency. Add to fix_plan.md for future resolution.
FAILED tests/test_integration_workflow.py::TestFullWorkflow::test_train_save_load_infer_cycle
========== 1 failed, 2 skipped, 568 deselected, 2 warnings in 12.63s ===========
