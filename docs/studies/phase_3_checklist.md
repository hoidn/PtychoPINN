### **Agent Implementation Checklist: Phase 3: Implement Results Aggregation and Visualization**

**Overall Goal for this Phase:** To create tools for collecting metrics from multiple runs and generating comparative visualizations.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[D]` | **Why:** To load the necessary context and technical specifications before coding. <br> **Docs:** `docs/studies/plan_model_generalization.md`, `scripts/studies/run_generalization_study.sh` (completed in Phase 2). <br> **APIs:** `pandas.read_csv`, `matplotlib.pyplot`, `numpy.log2`, `pathlib.Path.glob`.
| 0.B | **Identify Target Files for Modification/Creation**| `[D]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `scripts/studies/aggregate_and_plot_results.py (Create)`.
| **Section 1: CSV Parsing and Data Collection**
| 1.A | **Implement directory traversal and CSV discovery**| `[D]` | **Why:** To find all comparison_metrics.csv files from multi-run outputs. <br> **How:** Use `pathlib.Path.glob("*/comparison_metrics.csv")` to find all CSV files in subdirectories, extract training size from directory names (e.g., "train_512" -> 512). <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 1.B | **Create CSV parsing function**                    | `[D]` | **Why:** To extract metrics data from each comparison run. <br> **How:** Use `pandas.read_csv()` to load each CSV, validate required columns exist (`psnr_phase`, `psnr_amp`, `frc50_phase`, `frc50_amp`, `mae_phase`, `mae_amp`, `mse_phase`, `mse_amp`), handle missing data gracefully. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 1.C | **Implement data aggregation logic**              | `[D]` | **Why:** To combine metrics from all runs into a single dataset for plotting. <br> **How:** Create a DataFrame with columns: `train_size`, `model_type` (pinn/baseline), `metric_value`. Include error handling for missing files or malformed data. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| **Section 2: Configurable Plotting System**
| 2.A | **Add command-line argument parsing**             | `[D]` | **Why:** To make the script configurable for different metrics and data components. <br> **How:** Use `argparse` to support `--metric` (psnr, frc50, mae, mse), `--part` (phase, amp), `--output` (plot filename), `--title` (custom plot title). Include validation and helpful error messages. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 2.B | **Implement logarithmic X-axis scaling**          | `[D]` | **Why:** To properly visualize training set sizes that span orders of magnitude. <br> **How:** Use `matplotlib.pyplot.xscale('log', base=2)` for base-2 logarithmic scaling. Set appropriate tick marks and labels for common training sizes (256, 512, 1024, 2048, 4096, 8192). <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 2.C | **Create publication-ready plot formatting**      | `[D]` | **Why:** To generate professional-quality visualizations suitable for papers or presentations. <br> **How:** Set figure size (10x6 inches), use clear labels, add grid, include legend distinguishing PtychoPINN vs Baseline. Use different colors/markers for each model type. Save as high-DPI PNG (300 DPI). <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| **Section 3: Data Export and Summary Generation**
| 3.A | **Implement aggregated results CSV export**       | `[D]` | **Why:** To provide raw data for further analysis or custom plotting. <br> **How:** Save the aggregated DataFrame to `results.csv` with columns: `train_size`, `model_type`, `metric_name`, `metric_value`. Include metadata header with generation timestamp and parameters used. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 3.B | **Add data validation and quality checks**        | `[D]` | **Why:** To catch and report issues with input data that could lead to misleading results. <br> **How:** Check for: missing comparison files, incomplete training runs, suspicious metric values (e.g., negative PSNR), mismatched training sizes. Report warnings but continue processing valid data. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| **Section 4: Error Handling and Robustness**
| 4.A | **Add comprehensive error handling**              | `[D]` | **Why:** To handle real-world scenarios where runs may fail or produce partial results. <br> **How:** Use try-catch blocks around file operations, provide informative error messages, implement graceful degradation (skip failed runs, continue with available data). Log all issues to console with timestamps. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 4.B | **Implement input validation**                    | `[D]` | **Why:** To provide clear feedback when script is used incorrectly. <br> **How:** Validate that input directory exists, contains expected subdirectory structure, has at least one valid comparison_metrics.csv file. Check that requested metric/part combinations are available in the data. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| **Section 5: Testing & Integration**
| 5.A | **Test with mock data structure**                 | `[D]` | **Why:** To verify the script works correctly before running on real experimental data. <br> **How:** Create test directory structure with 2-3 mock `comparison_metrics.csv` files, run script with different metric/part combinations, verify plot generation and CSV export work correctly. <br> **File:** Test execution.
| 5.B | **Integration test with run_generalization_study.sh** | `[D]` | **Why:** To verify the complete end-to-end workflow functions properly. <br> **How:** Run `run_generalization_study.sh` with small training sizes, then use `aggregate_and_plot_results.py` to process the outputs. Verify that the aggregation script is called correctly at the end of the study script. <br> **File:** Integration test.
| **Section 6: Documentation & Finalization**
| 6.A | **Add comprehensive usage documentation**          | `[D]` | **Why:** To provide clear instructions for users running generalization studies. <br> **How:** Add detailed docstring with usage examples, parameter descriptions, expected input/output formats. Include examples for common use cases (PSNR phase comparison, FRC amplitude comparison). <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.
| 6.B | **Make script executable and perform final test** | `[D]` | **Why:** To ensure the script is ready for production use. <br> **How:** Run `chmod +x scripts/studies/aggregate_and_plot_results.py`, perform final end-to-end test with realistic data sizes, verify all output files are generated correctly. <br> **File:** `scripts/studies/aggregate_and_plot_results.py`.