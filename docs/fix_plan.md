# PtychoPINN Fix Plan Ledger (Condensed)

**Last Updated:** 2026-01-20 (ORCH-AGENT-DISPATCH plan drafted)
**Active Focus:** ORCH-AGENT-DISPATCH-001 — plan drafted

---

**Housekeeping Notes:**
- Full ledger snapshot archived at `docs/archive/2026-01-13_fix_plan_archive.md`
- Full Attempts History archived in `docs/fix_plan_archive.md` (snapshot 2026-01-06)
- Earlier snapshots: `docs/archive/2025-11-06_fix_plan_archive.md`, `docs/archive/2025-10-17_fix_plan_archive.md`, `docs/archive/2025-10-20_fix_plan_archive.md`
- Each initiative has a working plan at `plans/active/<ID>/implementation.md` and reports under `plans/active/<ID>/reports/`

---

## Active / Pending Initiatives

### [DEBUG-SIM-LINES-DOSE-001] Isolate sim_lines_4x vs dose_experiments discrepancy
- Depends on: None
- Priority: **Critical** (Highest Priority)
- Status: in_progress — Phase C verification (C2 ideal scenarios)
- Owner/Date: Codex/2026-01-13
- Working Plan: `plans/active/DEBUG-SIM-LINES-DOSE-001/implementation.md`
- Summary: `plans/active/DEBUG-SIM-LINES-DOSE-001/summary.md`
- Reports Hub: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/`
- Spec Owner: `docs/specs/spec-ptycho-workflow.md`
- Test Strategy: `plans/active/DEBUG-SIM-LINES-DOSE-001/test_strategy.md`
- Goals:
  - Identify whether the sim_lines_4x failure stems from a core regression, nongrid pipeline differences, or a workflow/config mismatch.
  - Produce a minimal repro that isolates grid vs nongrid and probe normalization effects.
  - Apply a targeted fix and verify success via visual inspection if metrics are unavailable.
- Exit Criteria:
  - A/B results captured for grid vs nongrid, probe normalization, and grouping parameters.
  - Root-cause statement with evidence (logs + params snapshot + artifacts).
  - Targeted fix or workflow change applied, with recon success and no NaNs.
  - Visual inspection success gate satisfied if metrics are unavailable.
- Attempts History:
  - *2026-01-13T000000Z:* Drafted phased debugging plan, summary, and test strategy. Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/implementation.md`, `plans/active/DEBUG-SIM-LINES-DOSE-001/summary.md`, `plans/active/DEBUG-SIM-LINES-DOSE-001/test_strategy.md`.
  - *2026-01-15T235900Z:* Reactivated focus, set Phase A evidence capture Do Now, and opened new artifacts hub. Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-15T235900Z/`.
  - *2026-01-16T000353Z:* Reframed Phase A A0/A1/A3 handoff to build `collect_sim_lines_4x_params.py`, inventory `dose_experiments` defaults, and run the pipeline import smoke test. Artifacts hub: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T000353Z/`.
  - *2026-01-16T002700Z:* Implemented `scripts/tools/collect_sim_lines_4x_params.py` (metadata-only snapshot CLI), captured the JSON snapshot, recorded the legacy `dose_experiments` tree + parameter script, and reran the sim_lines pipeline import smoke test. Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v` (pass). Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T000353Z/{sim_lines_4x_params_snapshot.json,dose_experiments_tree.txt,dose_experiments_param_scan.md,pytest_sim_lines_pipeline_import.log}`. Next Actions: Compare sim_lines snapshot vs dose_experiments defaults (Phase A4) and plan the differential experiments.
  - *2026-01-16T003217Z:* Reviewed the captured artifacts, ticked A1/A3 in the plan, and authored the A4 comparison Do Now plus new artifacts hub (`plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T003217Z/`) so Ralph can implement the diff script with fresh pytest evidence.
  - *2026-01-16T013500Z:* Implemented `bin/compare_sim_lines_params.py`, generated the Markdown + JSON diff artifacts for all four scenarios, and reran the synthetic helpers CLI smoke test to guard imports.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v` (pass)
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T003217Z/{comparison_draft.md,comparison_diff.json,pytest_sim_lines_pipeline_import.log}`
    - Next Actions: Use the diff to scope the Phase B differential experiments (grid vs nongrid, probe normalization) or flag gaps if additional parameters need capture.
  - *2026-01-16T020000Z:* Reviewed the comparison diff, marked Phase A4 complete in the working plan, and scoped Phase B1 instrumentation to capture grouping stats for both the legacy (dose_experiments) and sim_lines parameter regimes. Created new artifacts hub `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T020000Z/` for the upcoming grouping summaries and refreshed the Do Now with the bin script plan plus pytest guard.
  - *2026-01-16T005400Z:* Added `bin/grouping_summary.py` under the initiative, captured grouping summaries for the SIM-LINES defaults and the legacy gridsize=2 dose constraints (including failure diagnostics), and reran the synthetic helpers CLI smoke guard.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v`
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T020000Z/{grouping_sim_lines_default.json,grouping_sim_lines_default.md,grouping_dose_experiments_legacy.json,grouping_dose_experiments_legacy.md,pytest_sim_lines_pipeline_import.log}`
    - Next Actions: Mine the grouping stats to plan the remainder of Phase B (probe normalization and grouping differentials) or flag if additional parameter overrides are required.
  - *2026-01-16T031700Z:* Implemented the plan-local `probe_normalization_report.py` CLI plus `plans/.../bin/__init__.py`, generated JSON/Markdown stats for gs1/gs2 × custom/ideal probes, captured the CLI log, and reran the synthetic helpers CLI smoke test.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v`
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T031500Z/{probe_stats_gs1_custom.json,probe_stats_gs1_custom.md,probe_stats_gs1_ideal.json,probe_stats_gs1_ideal.md,probe_stats_gs2_custom.json,probe_stats_gs2_custom.md,probe_stats_gs2_ideal.json,probe_stats_gs2_ideal.md,probe_normalization_cli.log,pytest_sim_lines_pipeline_import.log}`
    - Next Actions: Compare the legacy vs sim_lines probe stats to decide if normalization explains the reconstruction gap or if grouping/reassembly experiments must proceed (Phase B3/B4).
  - *2026-01-16T041700Z:* Supervisor review confirmed the probe stats are numerically identical (max delta ≈5e-7), so normalization is no longer a suspect. Scoped Phase B3 to extend `bin/grouping_summary.py` with per-axis offset stats + nn-index ranges and to capture three runs (gs1 default, gs2 default, gs2 neighbor-count=1) plus the CLI smoke guard under `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T041700Z/`.
  - *2026-01-16T043500Z:* Extended `bin/grouping_summary.py` with overall mean/std reporting plus per-axis coordinate stats (when the penultimate dimension is 2) and nn-index min/max telemetry, regenerated the gs1 default, gs2 default, and gs2 `neighbor-count=1` grouping summaries, and archived the combined CLI + pytest logs under the Phase B3 hub.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v`
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T041700Z/{grouping_gs1_custom_default.json,grouping_gs1_custom_default.md,grouping_gs2_custom_default.json,grouping_gs2_custom_default.md,grouping_gs2_custom_neighbor1.json,grouping_gs2_custom_neighbor1.md,grouping_cli.log,pytest_sim_lines_pipeline_import.log}`
    - Next Actions: Analyze the richer per-axis telemetry to decide whether B4 needs additional grouping probes or if we can pivot directly to the reassembly experiments.
  - *2026-01-16T050500Z:* Reviewed the B3 telemetry (coords offsets up to ~382 px on gs2) and compared it against the legacy padded-size math (`get_padded_size()` ≈ 78 px when `offset` remains 4 and `max_position_jitter` remains 10), confirming reassembly canvas under-allocation is the likely regression. Scoped Phase B4 around a `reassembly_limits_report.py` helper that contrasts observed offsets vs padded-size requirements and runs a sum-preservation probe via `reassemble_whole_object()`. Opened artifacts hub `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T050500Z/` for the next evidence batch and refreshed the Do Now accordingly.
  - *2026-01-16T053600Z:* Added `bin/reassembly_limits_report.py`, generated JSON/Markdown + CLI evidence for `gs1_custom` and `gs2_custom`, and proved that the observed max offsets (~382 px) demand canvases ≥828–831 px while the legacy padded size stays at 74/78 px (loss fractions ≥94%). Pytest guard reran clean.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v` (pass)
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T050500Z/{reassembly_cli.log,reassembly_gs1_custom.json,reassembly_gs1_custom.md,reassembly_gs2_custom.json,reassembly_gs2_custom.md,pytest_sim_lines_pipeline_import.log}`
    - Next Actions: Feed the reassembly deltas into Phase C to patch `get_padded_size()`/canvas sizing or open a dedicated backlog item if the fix crosses initiatives.
  - *2026-01-16T060156Z:* Supervisor planning loop to pivot into Phase C: mined the B4 telemetry, marked Phase B complete in the implementation plan, and scoped C1 around updating `create_ptycho_data_container()` (plus a targeted pytest) so grouped offsets automatically expand `max_position_jitter`/padded size before training/inference. Refreshed `plans/active/DEBUG-SIM-LINES-DOSE-001/{implementation.md,summary.md}` and `input.md` with the new Do Now, no new production artifacts yet. Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T060156Z/`.
  - *2026-01-20T011212Z:* Implemented `_update_max_position_jitter_from_offsets()` with padded-size parity handling, wired it into `create_ptycho_data_container`, and updated `reassembly_limits_report.py` to apply the helper while basing the required canvas on `coords_offsets`. Added the regression pytest, refreshed test docs, and confirmed SIM-LINES reassembly telemetry now reports `fits_canvas=True` with zero loss for gs1/gs2 custom runs.
    - Metrics: `ruff check ptycho/workflows/components.py plans/active/DEBUG-SIM-LINES-DOSE-001/bin/reassembly_limits_report.py tests/test_workflow_components.py`, `pytest --collect-only tests/test_workflow_components.py -q`, `pytest tests/test_workflow_components.py::TestCreatePtychoDataContainer::test_updates_max_position_jitter -v`, `pytest -v -m integration`
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-16T060900Z/{git_diff.txt,ruff_check.log,pytest_collect_workflow_components.log,pytest_workflow_components.log,pytest_integration.log,reassembly_cli.log,reassembly_gs1_custom.json,reassembly_gs1_custom.md,reassembly_gs2_custom.json,reassembly_gs2_custom.md}`
    - Next Actions: Run the Phase C2 gs1/gs2 ideal telemetry (if required) or proceed to the inference smoke validation once the padded-size update is accepted.
  - *2026-01-20T041420Z:* Reviewed the C1 landing evidence, marked the checklist entries complete, and queued Phase C2 handoff to rerun the gs1_ideal + gs2_ideal scenarios with the jitter fix. Do Now captures end-to-end runs, NaN/canvas inspection, and manual visual checks with artifacts staged under `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-20T041420Z/`.
  - *2026-01-20T052730Z:* Prepared the Phase C2 supervisor loop (this turn) with a fresh artifacts hub, scoped a plan-local runner (`bin/run_phase_c2_scenario.py`) to capture amplitude/phase arrays + NaN stats, and refreshed `input.md` with commands for gs1_ideal + gs2_ideal runs plus reassembly telemetry.
  - *2026-01-20T052010Z:* Implemented the Phase C2 runner (`bin/run_phase_c2_scenario.py`) with CLI arg overrides, stats PNG generation, and run_metadata tracking, then executed the gs1_ideal (512 images/256 groups/`batch_size=8`) and gs2_ideal (256 base images/128 groups/`batch_size=4`) scenarios. Archived amplitude/phase `.npy`, PNGs, stats JSON, CLI logs, updated reassembly telemetry for both scenarios, and re-ran the synthetic helpers CLI smoke pytest selector.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v`
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-20T061530Z/{gs1_ideal_runner.log,gs2_ideal_runner.log,gs1_ideal/inference_outputs/*,gs2_ideal/inference_outputs/*,gs1_ideal_notes.md,gs2_ideal_notes.md,reassembly_cli.log,reassembly_gs1_ideal.json,reassembly_gs2_ideal.json,pytest_cli_smoke.log}`
    - Notes: gs1 needed reduced group_count to avoid NaNs; both reassembly JSONs report `fits_canvas=true` with jitter-expanded padded sizes.
  - *2026-01-20T062804Z:* Reviewed the Phase C2 evidence, confirmed the jitter-driven padded size passes (`fits_canvas=true`, 0 NaNs) on both ideal scenarios, and logged a follow-up checklist (C2b) to bake the reduced-load profile (gs1: 512/256/8, gs2: 256/128/4) into `run_phase_c2_scenario.py` so reruns no longer depend on manual CLI overrides. New hub and telemetry updates will accompany that rerun.
  - *2026-01-20T061530Z:* Current loop — revisited the C2 scope, updated the working plan/status to Phase C verification, opened artifacts hub `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-20T061530Z/`, and drafted the Do Now for implementing `bin/run_phase_c2_scenario.py`, running gs1_ideal + gs2_ideal with PNG/NaN evidence, rerunning the reassembly telemetry, and guarding the flow with the synthetic helpers CLI pytest selector.
  - *2026-01-20T063500Z:* Baked the `gs1_ideal`/`gs2_ideal` “stable profiles” directly into `run_phase_c2_scenario.py`, reran both scenarios under the new artifacts hub, refreshed the manual inspection notes + reassembly telemetry, and re-ran the synthetic helpers CLI smoke guard.
    - Metrics: `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py::test_sim_lines_pipeline_import_smoke -v`
    - Artifacts: `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-20T063500Z/{gs1_ideal_runner.log,gs2_ideal_runner.log,gs*_ideal/inference_outputs/*,gs*_ideal_notes.md,reassembly_cli.log,reassembly_gs1_ideal.json,reassembly_gs2_ideal.json,pytest_cli_smoke.log}`
    - Notes: run_metadata now records the baked overrides (base_total_images/group_count/batch_size/neighbor_count) without CLI hacks; `gs2_ideal` stayed healthy with `fits_canvas=true`, while `gs1_ideal` still collapses to NaNs despite the reduced profile, so the NaN root cause remains open even though the workload knobs are fixed in-code.
  - *2026-01-20T071800Z:* Logged the gs1 vs gs2 divergence after the stable-profile reruns, marked C2b complete in the working plan, and scoped Phase C3 around instrumenting `run_phase_c2_scenario.py` to persist per-epoch training history and NaN detection. Reserved artifacts hub `plans/active/DEBUG-SIM-LINES-DOSE-001/reports/2026-01-20T071800Z/` for the telemetry reruns (gs1_ideal + gs2_ideal), refreshed `input.md`, and prepped the new Do Now with the pytest guard plus reassembly CLI instructions.

### [FIX-DEVICE-TOGGLE-001] Remove CPU/GPU toggle (GPU-only execution)
- Depends on: None
- Priority: High
- Status: pending
- Owner/Date: Codex/2026-01-20
- Working Plan: `plans/active/FIX-DEVICE-TOGGLE-001/implementation.md`
- Summary: `plans/active/FIX-DEVICE-TOGGLE-001/summary.md`
- Reports Hub: `plans/active/FIX-DEVICE-TOGGLE-001/reports/`
- Spec Owner: `specs/ptychodus_api_spec.md`
- Test Strategy: `plans/active/FIX-DEVICE-TOGGLE-001/test_strategy.md`
- Goals:
  - Remove GPU/CPU toggles from PyTorch CLI + execution config.
  - Enforce GPU-only runtime with actionable errors on missing CUDA.
  - Align specs/docs/tests with GPU-only contract.
- Exit Criteria:
  - CLI no longer exposes `--device`, `--accelerator`, `--torch-accelerator`.
  - Execution config defaults to GPU-only values; no CPU fallback.
  - Spec/doc updates merged; tests updated with passing pytest logs archived.
- Attempts History:
  - *2026-01-20:* Drafted implementation plan, test strategy, and summary. Artifacts: `plans/active/FIX-DEVICE-TOGGLE-001/{implementation.md,test_strategy.md,summary.md}`.

### [REFACTOR-MEMOIZE-CORE-001] Move RawData memoization decorator into core module
- Depends on: None
- Priority: Low
- Status: done — Phase C docs/tests landed; ready for archive after a short soak
- Owner/Date: TBD/2026-01-13
- Working Plan: `plans/active/REFACTOR-MEMOIZE-CORE-001/implementation.md`
- Summary: `plans/active/REFACTOR-MEMOIZE-CORE-001/summary.md`
- Reports Hub: `plans/active/REFACTOR-MEMOIZE-CORE-001/reports/`
- Spec Owner: `docs/architecture.md`
- Test Strategy: Inline test annotations (refactor only; reuse existing tests)
- Goals:
  - Move `memoize_raw_data` from `scripts/simulation/cache_utils.py` into a core module under `ptycho/`.
  - Preserve cache hashing and default cache paths used by synthetic helpers.
  - Keep script imports working via direct update or a thin shim.
- Exit Criteria:
  - Core module provides `memoize_raw_data` with unchanged behavior.
  - Synthetic helpers use the core module; shim or removal completed without regressions.
  - Existing synthetic helper tests pass and logs archived.
- Attempts History:
  - *2026-01-13T202358Z:* Drafted implementation plan and initialized initiative summary. Artifacts: `plans/active/REFACTOR-MEMOIZE-CORE-001/implementation.md`, `plans/active/REFACTOR-MEMOIZE-CORE-001/summary.md`.
  - *2026-01-15T225850Z:* Phase A inventory + compatibility design completed; handed off Phase B move/shim work with pytest coverage instructions. Artifacts: `plans/active/REFACTOR-MEMOIZE-CORE-001/reports/2026-01-15T225850Z/`
  - *2026-01-15T231710Z:* Added `ptycho/cache.py` with the memoize helpers, updated synthetic_helpers to import it, and converted `scripts/simulation/cache_utils.py` into a DeprecationWarning shim. Tests: `pytest tests/scripts/test_synthetic_helpers.py::test_simulate_nongrid_seeded -v`, `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py -v`. Artifacts: `plans/active/REFACTOR-MEMOIZE-CORE-001/reports/2026-01-15T225850Z/`
  - *2026-01-15T232107Z:* Confirmed Phase B landed in commit `d29efc91` and staged Phase C cleanup: refresh docs (`docs/index.md`, `scripts/simulation/README.md`), rerun the two synthetic helper selectors, and archive logs under `plans/active/REFACTOR-MEMOIZE-CORE-001/reports/2026-01-15T232107Z/`.
  - *2026-01-15T233050Z:* Documented the new `ptycho/cache.py` core helper in `docs/index.md`, refreshed `scripts/simulation/README.md` with cache-root/override guidance, and captured the required pytest evidence (`pytest --collect-only tests/scripts/test_synthetic_helpers.py -q`, `pytest tests/scripts/test_synthetic_helpers.py::test_simulate_nongrid_seeded -v`, `pytest tests/scripts/test_synthetic_helpers_cli_smoke.py -v`). Artifacts: `plans/active/REFACTOR-MEMOIZE-CORE-001/reports/2026-01-15T232107Z/pytest_collect.log`, `.../pytest_synthetic_helpers.log`, `.../pytest_cli_smoke.log`.
  - *2026-01-15T233622Z:* Verified Phase C evidence (docs updated, selectors rerun), checked plan checkboxes, and logged completion so the initiative can be archived after the soak window. Artifacts: `plans/active/REFACTOR-MEMOIZE-CORE-001/reports/2026-01-15T232107Z/`, `plans/active/REFACTOR-MEMOIZE-CORE-001/implementation.md`

### [PARALLEL-API-INFERENCE] Programmatic TF/PyTorch API parity
- Depends on: None
- Priority: Medium
- Status: pending — paused while DEBUG-SIM-LINES-DOSE-001 is active
- Owner/Date: TBD/2026-01-09
- Working Plan: `plans/active/PARALLEL-API-INFERENCE/plan.md`
- Summary: `plans/active/PARALLEL-API-INFERENCE/summary.md`
- Reports Hub: `plans/active/PARALLEL-API-INFERENCE/reports/`
- Spec Owner: `specs/ptychodus_api_spec.md`
- Test Strategy: `tests/scripts/test_tf_inference_helper.py`, `tests/scripts/test_api_demo.py`
- Goals:
  - Provide a single programmatic entry point that can train + infer via TensorFlow or PyTorch without shell wrappers.
  - Extract reusable TensorFlow inference helper so `_run_tf_inference_and_reconstruct()` mirrors the PyTorch helper.
  - Update `scripts/pytorch_api_demo.py` to exercise both backends and add smoke tests.
- Exit Criteria:
  - `_run_tf_inference_and_reconstruct()` helper exposed (done) and consumed by new programmatic flows.
  - `scripts/pytorch_api_demo.py` drives both backends, uses core helpers (TF + PyTorch), and captures outputs under `tmp/api_demo/<backend>/`.
  - `tests/scripts/test_api_demo.py` exercises imports/signatures plus marked slow end-to-end runs for both backends; helper tests continue to pass.
- Attempts History:
  - *2026-01-09T010000Z:* Completed exploration + extraction design for TF helper. Artifacts: `plans/active/PARALLEL-API-INFERENCE/reports/2026-01-09T010000Z/extraction_design.md`.
  - *2026-01-09T020000Z:* Implemented `_run_tf_inference_and_reconstruct()` and `extract_ground_truth()`, deprecated `perform_inference`, and added 7 regression tests + integration workflow run (all green). Artifacts: `plans/active/PARALLEL-API-INFERENCE/reports/2026-01-09T020000Z/`.
  - *2026-01-09T030000Z:* Reviewed Task 1 results and scoped Task 2-3 (demo script + smoke test). Artifacts: `plans/active/PARALLEL-API-INFERENCE/reports/2026-01-09T030000Z/`.
  - *2026-01-15T225312Z:* Added initial smoke tests for `scripts/pytorch_api_demo.py` (import + signature) and reran TF helper regression suite; slow execution tests still deselected pending demo parity. Artifacts: `plans/active/PARALLEL-API-INFERENCE/reports/2026-01-15T225312Z/pytest_collect.log`, `pytest_tf_helper_regression.log`, `pytest_api_demo.log`.

### [ORCH-ROUTER-001] Router prompt + orchestration dispatch layer
- Depends on: None
- Priority: Medium
- Status: done — Phase C verification complete (ready for archive)
- Owner/Date: Codex/2026-01-20
- Working Plan: `plans/active/ORCH-ROUTER-001/implementation.md`
- Summary: `plans/active/ORCH-ROUTER-001/summary.md`
- Reports Hub: `.artifacts/orch-router-001/`
- Spec Owner: `scripts/orchestration/README.md`
- Test Strategy: `plans/active/ORCH-ROUTER-001/test_strategy.md`
- Goals:
  - Add a router loop with deterministic routing + optional prompt override.
  - Preserve sync semantics while enforcing allowlist and crash behavior.
- Exit Criteria:
  - Deterministic routing + router override verified.
  - Allowlist and failure behavior documented and tested.
  - Logging/state annotations captured as specified in the plan.
- Attempts History:
  - *2026-01-20T011707Z:* Drafted implementation plan, test strategy, and summary. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,test_strategy.md,summary.md}`.
  - *2026-01-20T012145Z:* Refined the plan to locate the routing function in `scripts/orchestration/router.py`, document YAML-as-parameters-only, and clarify review cadence/state.json decisions. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,summary.md}`.
  - *2026-01-20T012303Z:* Clarified routing contract to use review cadence every N iterations with actor gating and router precedence, and constrained state.json persistence to the last selected prompt only. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,summary.md}`.
  - *2026-01-20T012542Z:* Drafted the Phase A routing contract artifact and marked A0-A2 complete in the plan (routing contract + state.json field + test strategy linkage). Artifacts: `plans/active/ORCH-ROUTER-001/{routing_contract.md,implementation.md,summary.md}`.
  - *2026-01-20T012735Z:* Expanded plan documentation steps to include docs/index.md updates in Phase A/C. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,summary.md}`.
  - *2026-01-20T012912Z:* Addressed plan conformance issues: added missing context priming fields, clarified router override source, and made state.json persistence/log archival requirements explicit. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,summary.md}`.
  - *2026-01-20T013928Z:* Implemented deterministic router entrypoint + wrapper, added pytest coverage, and updated test registry docs.
    - Metrics: `ruff check scripts/orchestration/router.py tests/tools/test_orchestration_router.py`, `pytest --collect-only tests/tools/test_orchestration_router.py -v`, `pytest tests/tools/test_orchestration_router.py -v`
    - Artifacts: `.artifacts/orch-router-001/{ruff_check.log,pytest_collect_router.log,pytest_router.log}`
  - *2026-01-20T015442Z:* Implemented router prompt overrides, config wiring, logging + `last_prompt` state annotation, and documented router behavior in the orchestration README/index while expanding router tests.
    - Metrics: `ruff check scripts/orchestration/router.py scripts/orchestration/config.py scripts/orchestration/state.py scripts/orchestration/loop.py scripts/orchestration/supervisor.py tests/tools/test_orchestration_router.py`, `pytest --collect-only tests/tools/test_orchestration_router.py -v`, `pytest tests/tools/test_orchestration_router.py -v`
    - Artifacts: `.artifacts/orch-router-001/{ruff_check.log,pytest_collect_router.log,pytest_router.log}`
  - *2026-01-20T020234Z:* Added router mode config (`router_first`/`router_only`), router-only enforcement, router prompt template, and documented mode precedence; expanded router tests for mode selection and router-only gating.
    - Metrics: `ruff check scripts/orchestration/router.py scripts/orchestration/config.py scripts/orchestration/state.py scripts/orchestration/loop.py scripts/orchestration/supervisor.py tests/tools/test_orchestration_router.py`, `pytest --collect-only tests/tools/test_orchestration_router.py -v`, `pytest tests/tools/test_orchestration_router.py -v`
    - Artifacts: `.artifacts/orch-router-001/{ruff_check.log,pytest_collect_router.log,pytest_router.log}`
  - *2026-01-20T020954Z:* Relocated router tests into the orchestration submodule, removed the main-repo test entry, and updated testing docs to reference the submodule selector.
    - Metrics: `ruff check scripts/orchestration/tests/test_router.py`, `pytest --collect-only scripts/orchestration/tests/test_router.py -v`, `pytest scripts/orchestration/tests/test_router.py -v`
    - Artifacts: `.artifacts/orch-router-001/{ruff_check.log,pytest_collect_router.log,pytest_router.log}`
  - *2026-01-20T023143Z:* Added loss gating to the long integration test by extracting final intensity_scaler_inv_loss metrics, writing train_metrics.json, and failing when val_intensity_scaler_inv_loss > 50 (no long integration run yet).
    - Artifacts: `.artifacts/orch-router-001/2026-01-20_integration_loss_gate_note.md`
  - *2026-01-20T023226Z:* Ran the long integration test with loss gating; val_intensity_scaler_inv_loss=38.9062 (<= 50) and train_metrics.json recorded.
    - Metrics: `RUN_LONG_INTEGRATION=1 INTEGRATION_OUTPUT_DIR=.artifacts/integration_manual_1000_512/2026-01-20T023226Z/output pytest tests/test_integration_manual_1000_512.py -v`
    - Artifacts: `.artifacts/integration_manual_1000_512/2026-01-20T023226Z/{pytest_manual_1000_512_run.log,output/train_metrics.json,output/train.log,output/inference.log}`
  - *2026-01-20T013743Z:* Added Phase B checklist item to create `prompts/router.md` with a strict single-line output contract. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,summary.md}`.
  - *2026-01-20T015415Z:* Added Phase D for router-first/router-only mode support, with config + tests + doc updates and exit criteria coverage. Artifacts: `plans/active/ORCH-ROUTER-001/{implementation.md,summary.md}`.

### [ORCH-ORCHESTRATOR-001] Combined orchestrator entrypoint + shared runner refactor
- Depends on: ORCH-ROUTER-001 (router selection logic)
- Priority: Medium
- Status: in_progress — Phase C complete; full-suite regression gate pending
- Owner/Date: user+Codex/2026-01-20
- Working Plan: `plans/active/ORCH-ORCHESTRATOR-001/implementation.md`
- Summary: `plans/active/ORCH-ORCHESTRATOR-001/summary.md`
- Reports Hub: `plans/active/ORCH-ORCHESTRATOR-001/reports/`
- Spec Owner: `scripts/orchestration/README.md`
- Test Strategy: `plans/active/ORCH-ORCHESTRATOR-001/test_strategy.md`
- Goals:
  - Add a single orchestrator entrypoint that can run supervisor/main prompts via router selection.
  - Refactor shared logic out of supervisor/loop to reuse runner utilities.
  - Preserve sync-via-git semantics and logging conventions.
- Exit Criteria:
  - Combined mode executes supervisor/main in sequence with router cadence.
  - Sync-via-git role mode respects expected_actor and state handoff semantics.
  - Review cadence runs once per iteration in combined mode.
  - Orchestrator tests pass and docs updated.
- Attempts History:
  - *2026-01-20T025735Z:* Drafted minimal design + implementation plan + test strategy. Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/{design.md,implementation.md,test_strategy.md}`.
  - *2026-01-20T032058Z:* Implemented shared runner + combined orchestrator + wrapper, refactored supervisor/loop to use runner utilities, added combined-mode tests, and updated orchestration docs/test registries.
    - Metrics: `ruff check scripts/orchestration/runner.py scripts/orchestration/orchestrator.py scripts/orchestration/supervisor.py scripts/orchestration/loop.py scripts/orchestration/tests/test_orchestrator.py`, `pytest --collect-only scripts/orchestration/tests/test_orchestrator.py -v`, `pytest scripts/orchestration/tests/test_orchestrator.py -v`
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/reports/2026-01-20T032058Z/{ruff_check.log,pytest_collect_orchestrator.log,pytest_orchestrator.log}`
    - Next Actions: decide whether to run the broader regression suite to satisfy the full-suite exit criterion.
  - *2026-01-20T032929Z:* Added coverage for galph-only router override and router-disabled behavior, refreshed plan evidence links, and reran the orchestrator tests.
    - Metrics: `ruff check scripts/orchestration/tests/test_orchestrator.py`, `pytest --collect-only scripts/orchestration/tests/test_orchestrator.py -v`, `pytest scripts/orchestration/tests/test_orchestrator.py -v`
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/reports/2026-01-20T032929Z/{ruff_check.log,pytest_collect_orchestrator.log,pytest_orchestrator.log}`
    - Next Actions: decide whether to run the broader regression suite to satisfy the full-suite exit criterion.
  - *2026-01-20T034106Z:* Debugged combined-mode error handling (non-data-contract issue): validated config expectation for `logs_dir`, isolated `run_combined_iteration` prompt-selection failures, added failing tests for missing prompt/router_only output, and implemented failure stamping + logging plus role-mode prompt override forwarding.
    - Metrics: `ruff check scripts/orchestration/orchestrator.py scripts/orchestration/tests/test_orchestrator.py`, `pytest --collect-only scripts/orchestration/tests/test_orchestrator.py -v`, `pytest scripts/orchestration/tests/test_orchestrator.py -v`
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/reports/2026-01-20T034106Z/{ruff_check.log,pytest_collect_orchestrator.log,pytest_orchestrator.log,summary.md}`
    - Next Actions: decide whether to run the broader regression suite to satisfy the full-suite exit criterion.
  - *2026-01-20T034858Z:* Added role-mode guard/forwarding tests (role required, sync required, prompt env forwarding) and refreshed test registry.
    - Metrics: `ruff check scripts/orchestration/tests/test_orchestrator.py`, `pytest --collect-only scripts/orchestration/tests/test_orchestrator.py -v`, `pytest scripts/orchestration/tests/test_orchestrator.py -v`
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/reports/2026-01-20T034858Z/{ruff_check.log,pytest_collect_orchestrator.log,pytest_orchestrator.log,summary.md}`
    - Next Actions: decide whether to run the broader regression suite to satisfy the full-suite exit criterion.
  - *2026-01-20T050619Z:* Updated the plan to add Phase D combined-mode auto-commit (local-only, dry-run/no-git) and expanded the test strategy for new auto-commit coverage.
    - Metrics: N/A — planning update only
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/{implementation.md,test_strategy.md,summary.md}`
  - *2026-01-20T051859Z:* Implemented combined auto-commit helpers + flags, wired best-effort auto-commit after galph/ralph, added Phase D tests, and updated orchestration/testing docs.
    - Metrics: `pytest --collect-only scripts/orchestration/tests/test_orchestrator.py -v`, `pytest scripts/orchestration/tests/test_orchestrator.py -v`
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/reports/2026-01-20T051859Z/{pytest_collect_orchestrator.log,pytest_orchestrator.log}`
  - *2026-01-20T052323Z:* Ran integration marker gate for combined auto-commit changes.
    - Metrics: `pytest -v -m integration` (1 passed, 3 skipped)
    - Artifacts: `plans/active/ORCH-ORCHESTRATOR-001/reports/2026-01-20T052323Z/pytest_integration.log`

### [ORCH-AGENT-DISPATCH-001] Per-role/per-prompt agent dispatch (codex vs claude)
- Depends on: ORCH-ORCHESTRATOR-001 (combined mode baseline)
- Priority: Medium
- Status: pending — plan drafted
- Owner/Date: Codex/2026-01-20
- Working Plan: `plans/active/ORCH-AGENT-DISPATCH-001/implementation.md`
- Summary: `plans/active/ORCH-AGENT-DISPATCH-001/summary.md`
- Reports Hub: `plans/active/ORCH-AGENT-DISPATCH-001/reports/`
- Spec Owner: `scripts/orchestration/README.md`
- Test Strategy: `plans/active/ORCH-AGENT-DISPATCH-001/test_strategy.md`
- Goals:
  - Allow selecting different agent CLIs by role or prompt (ex: codex for supervisor.md, claude for main.md).
  - Preserve default behavior when no agent mapping is configured.
  - Make combined mode resolve agent per selected prompt with explicit logging.
- Exit Criteria:
  - Agent resolution precedence implemented and documented.
  - Combined mode uses router-selected prompt to resolve agent.
  - Tests pass and orchestration docs/test registry updated with evidence.
- Attempts History:
  - *2026-01-20T053513Z:* Drafted implementation plan, summary, and test strategy for agent dispatch. Artifacts: `plans/active/ORCH-AGENT-DISPATCH-001/{implementation.md,summary.md,test_strategy.md}`.
