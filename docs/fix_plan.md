# PtychoPINN Fix Plan Ledger (Condensed)

**Last Updated:** 2025-11-06
**Active Focus:** STUDY-SYNTH-FLY64-DOSE-OVERLAP-001 — Phase G comparison & analysis [in_progress]

---

Housekeeping: This ledger is intentionally brief. Detailed “Attempts History” entries were moved to archives to keep decision‑making crisp.

- Current archive snapshot: `docs/archive/2025-11-06_fix_plan_archive.md`
- Earlier snapshots: `docs/archive/2025-10-17_fix_plan_archive.md`, `docs/archive/2025-10-20_fix_plan_archive.md`

Use the “Working Plan” and “reports/” under each initiative for day‑to‑day artifacts.

---

## [STUDY-SYNTH-FLY64-DOSE-OVERLAP-001] Synthetic fly64 dose/overlap study
- Depends on: —
- Priority: High
- Status: in_progress — Phase E6 bundle size tracking implementation
- Owner/Date: Codex Agent/2025-11-04
- Working Plan: `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/implementation.md`
- Test Strategy: `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md`
- Constraints: `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/constraint_analysis.md`
- Notes: Use existing fly64 object/probe; enforce y‑axis split; group‑level overlap control via min center spacing; emphasize phase MS‑SSIM; PINN backend: TensorFlow; pty‑chi LSQML baseline (100 epochs) uses PyTorch internally.
- Attempts History: See `docs/archive/2025-11-06_fix_plan_archive.md` (section for this initiative) and the initiative's `reports/` directories for run logs and metrics.
- Latest Attempt (2025-11-06T130500Z): Implementation — Phase E6 CLI stdout normalization GREEN. Enhanced test with stdout relative-path assertions (tests/study/test_dose_overlap_training.py:1645-1652); updated training CLI to normalize bundle_path before stdout emission (studies/fly64_dose_overlap/training.py:736-742). RED confirmed absolute-path bug; GREEN validates `wts.h5.zip` relative format. Full suite: 397 passed, 1 pre-existing fail (test_interop_h5_reader), 17 skipped in 249s. Artifacts: `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T130500Z/phase_e_training_bundle_real_runs_exec/` (RED/GREEN/collect/full logs + summary.md). Commit: [pending].
- Latest Attempt (2025-11-06T150500Z): Bug Fix — PyTorch workflows Path type violations. While attempting Phase E6 evidence capture, discovered **critical production bugs** in `ptycho_torch/workflows/components.py:650,682` where string paths from `TrainingConfig` were passed to functions expecting `Path` objects. Symptoms: `AttributeError: 'str' object has no attribute 'exists'` and `TypeError: unsupported operand type(s) for /`. Fixed by wrapping `config.train_data_file` and `config.output_dir` with `Path()` at call sites (ptycho_torch/workflows/components.py:650-651, 682). Impact: Unblocks all PyTorch backend training workflows. Tests: RED passed (mocked code bypassed bug), GREEN passed after fix, full suite 397 passed/1 pre-existing fail/17 skipped in 249s. New finding: TYPE-PATH-001 (to document). Artifacts: `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T150500Z/phase_e_training_bundle_real_runs_exec/` (summary.md, test logs). Commit: [next].
- Latest Attempt (2025-11-06T170500Z): Planning — Phase E6 dense/baseline SHA parity staging. Reviewed prior RED/GREEN logs, confirmed Path fix unblock, and reserved new hub `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T170500Z/phase_e_training_bundle_real_runs_exec/` with refreshed plan/summary. Do Now directs strengthening `test_training_cli_records_bundle_path`, rerunning deterministic dense+baseline CLI jobs, archiving via `bin/archive_phase_e_outputs.py`, and documenting TYPE-PATH-001 in findings. Findings applied: POLICY-001, CONFIG-001, DATA-001, OVERSAMPLING-001, TYPE-PATH-001.
- Latest Attempt (2025-11-06T170500Z+exec): Implementation — Phase E6 SHA parity enforcement GREEN. Enhanced test with stdout→manifest SHA cross-validation (tests/study/test_dose_overlap_training.py:1678-1702). Build (view,dose)→SHA map from manifest, assert each stdout checksum matches. RED: PASSED 7.11s (baseline intact). GREEN: PASSED 7.45s (parity enforced). Selector: 4 collected. Full suite: 397 passed/1 pre-existing fail (test_interop_h5_reader)/17 skipped in 284s. Documented TYPE-PATH-001 in docs/findings.md:21 (PyTorch Path normalization bug from 2025-11-06T150500Z). Nucleus complete: test enhancement + TYPE-PATH-001 doc. Deferred dense/baseline real runs + archival to follow-up loop (evidence collection vs core acceptance). Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T170500Z/phase_e_training_bundle_real_runs_exec/ (RED/GREEN/collect/full logs + summary.md). Commit: [next].
- Latest Attempt (2025-11-06T190500Z): Planning — Phase E6 bundle size metadata + dense/baseline real-run evidence. Reviewed 2025-11-06T170500Z execution summary and verified stdout/manifest SHA parity landed; identified gap: manifest lacks bundle size metrics for integrity tracking. Reserved new hub `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T190500Z/phase_e_training_bundle_real_runs_exec/` with refreshed plan/summary. Do Now directs augmenting `studies/fly64_dose_overlap/training.py` to emit `bundle_size_bytes`, updating the Phase E6 CLI test, rerunning deterministic dense (gs2) + baseline (gs1) jobs, archiving outputs via `bin/archive_phase_e_outputs.py`, and logging checksum + size evidence. Findings applied: POLICY-001, CONFIG-001, DATA-001, OVERSAMPLING-001, TYPE-PATH-001.
- Latest Attempt (2025-11-06T190500Z+exec): Implementation — Phase E6 bundle size tracking GREEN. Enhanced test with manifest bundle_size_bytes validation (tests/study/test_dose_overlap_training.py:1604-1618) and stdout Size line format/parity checks (1634-1641, 1721-1784). RED: FAILED on missing Size lines (0/2 expected). GREEN: PASSED 6.82s after implementing size computation (studies/fly64_dose_overlap/training.py:515 via .stat().st_size), result dict propagation (546), stdout emission (755-756). Full suite: 397 passed/1 pre-existing fail/17 skipped in 332.53s. Nucleus complete: bundle_size_bytes field computed, serialized, emitted with view/dose context, cross-validated. Dense/baseline real runs deferred to follow-up loop. Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T190500Z/phase_e_training_bundle_real_runs_exec/ (RED/GREEN/collect/full logs + summary.md). Commit: [next].
- Latest Attempt (2025-11-06T210500Z): Planning — Phase E6 dense/baseline deterministic evidence & archive parity. Confirmed bundle size feature landed (Attempt 2025-11-06T190500Z+exec) and identified remaining gap: real CLI runs + archive helper still lack size validation output. Reserved hub `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T210500Z/phase_e_training_bundle_real_runs_exec/` with new plan/summary. Do Now instructs updating `bin/archive_phase_e_outputs.py` to compare manifest `bundle_size_bytes` against filesystem sizes, running deterministic dose=1000 dense/gs2 and baseline/gs1 jobs, re-archiving bundles with SHA+size proof, and refreshing summary ledger notes. Findings applied: POLICY-001, CONFIG-001, DATA-001, OVERSAMPLING-001, TYPE-PATH-001.
- Latest Attempt (2025-11-06T210500Z+exec): Implementation — Phase E6 archive size parity GREEN. Enhanced archive helper with bundle_size_bytes validation (archive_phase_e_outputs.py:101,122-129,133): compute filesystem size via .stat().st_size, fail-fast on manifest field absence or mismatch, emit `sha256  filename  size_bytes` format to bundle_checksums.txt. Ran corrected training CLIs (removed invalid --accelerator/--deterministic/--num-workers flags from input.md). Both dose=1000 runs completed: baseline (SHA c52f2fc..., 8595443 bytes), dense (SHA 77b7c21..., 8615672 bytes). Archive helper validated SHA+size parity, emitted checksums with size column. Targeted test: GREEN 3.68s. Full suite: 397 passed/1 pre-existing fail (test_interop_h5_reader)/17 skipped in 417.55s. Nucleus complete: archive size validation + real bundle evidence captured. Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-06T210500Z/phase_e_training_bundle_real_runs_exec/ (cli logs, bundle_checksums.txt, summary.md). Commit: [next].
- Latest Attempt (2025-11-07T010500Z): Planning — Phase G dense comparison execution reset. Verified Phase E/F artifacts absent in workspace; staged new hub `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/` to capture regenerated dose_1000 assets. Do Now directs updating `studies/fly64_dose_overlap/comparison.py::build_comparison_jobs` to target dose/view artifact directories (`dose_1000/{baseline|dense}/gs{1|2}`), refreshing pytest coverage, rebuilding Phase C/D/E/F evidence under the hub, and executing dense/train + dense/test comparisons with logs under the new hub. Findings applied: POLICY-001, CONFIG-001, DATA-001, OVERSAMPLING-001, TYPE-PATH-001.
- Latest Attempt (2025-11-07T010500Z+exec): Implementation — Phase G comparison path fix GREEN. Corrected comparison.py:94-99 to use dose-specific Phase E paths per training.py:184,226 structure (dose_{dose}/{view}/gs2/wts.h5.zip for PINN, dose_{dose}/baseline/gs1/wts.h5.zip for baseline). Updated test fixture (test_dose_overlap_comparison.py:41-53) to reflect actual Phase E layout. Added new test (lines 260-323) validating dose/view-specific checkpoint path resolution with explicit structure assertions. RED: FileNotFoundError on old flat path (phase_e/pinn/checkpoint.h5). GREEN: test_build_comparison_jobs_uses_dose_specific_phase_e_paths PASSED 0.85s. Full comparison suite: 4 passed. Full test suite: 398 passed/1 pre-existing fail (test_interop_h5_reader)/17 skipped in 415.98s. Nucleus complete: path alignment bug fixed, test coverage ensures future integrity. Deferred Phase C/D/E/F regeneration to follow-up loop (comparison builder now unblocked, evidence collection orthogonal). Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/ (RED/GREEN/full logs + summary.md). Commit: efc51f29.
- Latest Attempt (2025-11-07T030500Z): Planning — Phase G manifest-driven dense execution staging. Verified comparison builder fix landed (2025-11-07T010500Z+exec) but noted `execute_comparison_jobs` never passes Phase F recon data to `scripts.compare_models`, blocking three-way evidence. Reserved new hub `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T030500Z/phase_g_execution_real_runs/` with plan + summary; rewrote `input.md` (Mode: TDD) directing manifest parsing update, new pytest coverage, and full Phase C→G regeneration for dose=1000 dense/train,test with logs archived via `tee`. Findings reaffirmed: POLICY-001, CONFIG-001, DATA-001, OVERSAMPLING-001, TYPE-PATH-001. AUTHORITATIVE_CMDS_DOC guard set in How-To map. Exit criteria: GREEN test proving `--tike_recon_path` wiring plus captured comparison logs + manifest under the new hub.

## [EXPORT-PTYCHODUS-PRODUCT-001] TF-side Ptychodus product exporter/importer + Run1084 conversion
- Depends on: —
- Priority: Medium
- Status: planning
- Owner/Date: Codex Agent/2025-10-28
- Working Plan: `plans/active/EXPORT-PTYCHODUS-PRODUCT-001/implementation_plan.md`
- Test Strategy: `plans/active/EXPORT-PTYCHODUS-PRODUCT-001/test_strategy.md`
- Attempts History: Initial plan/test strategy drafted — see plan files for details.

## [INTEGRATE-PYTORCH-001-STUBS] Finish PyTorch workflow stubs deferred from Phase D2
- Status: archived 2025-10-20 — see `docs/archive/2025-10-20_fix_plan_archive.md#integrate-pytorch-001-stubs-finish-pytorch-workflow-stubs-deferred-from-phase-d2`.

## [INTEGRATE-PYTORCH-001-DATALOADER] Restore PyTorch dataloader DATA-001 compliance
- Status: archived 2025-10-20 — see `docs/archive/2025-10-20_fix_plan_archive.md#integrate-pytorch-001-dataloader-restore-pytorch-dataloader-data-001-compliance`.

---

Process references:
- Supervisor prompt: `prompts/supervisor.md`
- Engineer prompt: `prompts/main.md`
- Findings ledger: `docs/findings.md`
- Data contracts: `specs/data_contracts.md`
