2025-07-22 17:24:07,298 - INFO - Configuration: phase_align_method='plane', frc_sigma=0.0
2025-07-22 17:24:07,298 - INFO - Registration: enabled
2025-07-22 17:24:07,298 - INFO - NPZ output: raw=enabled, aligned=enabled
2025-07-22 17:24:07,298 - INFO - Loading test data from probe_study_data/ideal_test_converted.npz...
2025-07-22 17:24:07,298 - INFO - Loading data from probe_study_data/ideal_test_converted.npz with n_images=None
2025-07-22 17:24:07,340 - INFO - Using grouping-aware subsampling for gridsize=2: passing full dataset for group-first sampling
2025-07-22 17:24:07,340 - INFO - diff3d shape: (1000, 64, 64)
2025-07-22 17:24:07,340 - INFO - probeGuess shape: (64, 64)
2025-07-22 17:24:07,340 - INFO - scan_index shape: (1000,)
2025-07-22 17:24:07,340 - INFO - objectGuess shape: (224, 224)
2025-07-22 17:24:07,340 - INFO - xcoords shape: (1000,)
2025-07-22 17:24:07,340 - INFO - ycoords shape: (1000,)
2025-07-22 17:24:07,340 - INFO - xcoords_start shape: (1000,)
2025-07-22 17:24:07,340 - INFO - ycoords_start shape: (1000,)
2025-07-22 17:24:07,340 - INFO - Loading PtychoPINN model from probe_generalization_study_corrected/ideal_gs1/pinn_run...
2025-07-22 17:24:08,209 - INFO - input shape
2025-07-22 17:24:08,209 - INFO - (None, 64, 64, 1)
2025-07-22 17:24:08,220 - WARNING - From /home/ollie/miniconda3/envs/ptycho-tf/lib/python3.10/site-packages/tensorflow_probability/python/distributions/distribution.py:342: calling _Independent.__init__ (from tensorflow_probability.python.distributions.independent) with reinterpreted_batch_ndims=None is deprecated and will be removed after 2022-03-01.
Instructions for updating:
Please pass an integer value for `reinterpreted_batch_ndims`. The current behavior corresponds to `reinterpreted_batch_ndims=tf.size(distribution.batch_shape_tensor()) - 1`.
2025-07-22 17:24:08,332 - INFO - Model: "model"
2025-07-22 17:24:08,332 - INFO - __________________________________________________________________________________________________
2025-07-22 17:24:08,332 - INFO - Layer (type)                Output Shape                 Param #   Connected to
2025-07-22 17:24:08,332 - INFO - ==================================================================================================
2025-07-22 17:24:08,332 - INFO - input (InputLayer)          [(None, 64, 64, 4)]          0         []
2025-07-22 17:24:08,332 - INFO - tf.math.truediv (TFOpLambd  (None, 64, 64, 4)            0         ['input[0][0]']
2025-07-22 17:24:08,332 - INFO - a)
2025-07-22 17:24:08,332 - INFO - conv2d (Conv2D)             (None, 64, 64, 64)           2368      ['tf.math.truediv[0][0]']
2025-07-22 17:24:08,332 - INFO - conv2d_1 (Conv2D)           (None, 64, 64, 64)           36928     ['conv2d[0][0]']
2025-07-22 17:24:08,333 - INFO - max_pooling2d (MaxPooling2  (None, 32, 32, 64)           0         ['conv2d_1[0][0]']
2025-07-22 17:24:08,333 - INFO - D)
2025-07-22 17:24:08,333 - INFO - conv2d_2 (Conv2D)           (None, 32, 32, 128)          73856     ['max_pooling2d[0][0]']
2025-07-22 17:24:08,333 - INFO - conv2d_3 (Conv2D)           (None, 32, 32, 128)          147584    ['conv2d_2[0][0]']
2025-07-22 17:24:08,333 - INFO - max_pooling2d_1 (MaxPoolin  (None, 16, 16, 128)          0         ['conv2d_3[0][0]']
2025-07-22 17:24:08,333 - INFO - g2D)
2025-07-22 17:24:08,333 - INFO - conv2d_4 (Conv2D)           (None, 16, 16, 256)          295168    ['max_pooling2d_1[0][0]']
2025-07-22 17:24:08,333 - INFO - conv2d_5 (Conv2D)           (None, 16, 16, 256)          590080    ['conv2d_4[0][0]']
2025-07-22 17:24:08,333 - INFO - max_pooling2d_2 (MaxPoolin  (None, 8, 8, 256)            0         ['conv2d_5[0][0]']
2025-07-22 17:24:08,333 - INFO - g2D)
2025-07-22 17:24:08,333 - INFO - conv2d_8 (Conv2D)           (None, 8, 8, 128)            295040    ['max_pooling2d_2[0][0]']
2025-07-22 17:24:08,333 - INFO - conv2d_14 (Conv2D)          (None, 8, 8, 128)            295040    ['max_pooling2d_2[0][0]']
2025-07-22 17:24:08,333 - INFO - conv2d_9 (Conv2D)           (None, 8, 8, 128)            147584    ['conv2d_8[0][0]']
2025-07-22 17:24:08,333 - INFO - conv2d_15 (Conv2D)          (None, 8, 8, 128)            147584    ['conv2d_14[0][0]']
2025-07-22 17:24:08,333 - INFO - up_sampling2d (UpSampling2  (None, 16, 16, 128)          0         ['conv2d_9[0][0]']
2025-07-22 17:24:08,334 - INFO - D)
2025-07-22 17:24:08,334 - INFO - up_sampling2d_2 (UpSamplin  (None, 16, 16, 128)          0         ['conv2d_15[0][0]']
2025-07-22 17:24:08,334 - INFO - g2D)
2025-07-22 17:24:08,334 - INFO - conv2d_10 (Conv2D)          (None, 16, 16, 64)           73792     ['up_sampling2d[0][0]']
2025-07-22 17:24:08,334 - INFO - conv2d_16 (Conv2D)          (None, 16, 16, 64)           73792     ['up_sampling2d_2[0][0]']
2025-07-22 17:24:08,334 - INFO - conv2d_11 (Conv2D)          (None, 16, 16, 64)           36928     ['conv2d_10[0][0]']
2025-07-22 17:24:08,334 - INFO - conv2d_17 (Conv2D)          (None, 16, 16, 64)           36928     ['conv2d_16[0][0]']
2025-07-22 17:24:08,334 - INFO - up_sampling2d_1 (UpSamplin  (None, 32, 32, 64)           0         ['conv2d_11[0][0]']
2025-07-22 17:24:08,334 - INFO - g2D)
2025-07-22 17:24:08,334 - INFO - up_sampling2d_3 (UpSamplin  (None, 32, 32, 64)           0         ['conv2d_17[0][0]']
2025-07-22 17:24:08,334 - INFO - g2D)
2025-07-22 17:24:08,334 - INFO - tf.__operators__.getitem (  (None, 32, 32, 60)           0         ['up_sampling2d_1[0][0]']
2025-07-22 17:24:08,334 - INFO - SlicingOpLambda)
2025-07-22 17:24:08,334 - INFO - tf.__operators__.getitem_1  (None, 32, 32, 60)           0         ['up_sampling2d_3[0][0]']
2025-07-22 17:24:08,334 - INFO - (SlicingOpLambda)
2025-07-22 17:24:08,334 - INFO - conv2d_6 (Conv2D)           (None, 32, 32, 1)            541       ['tf.__operators__.getitem[0][
2025-07-22 17:24:08,334 - INFO - 0]']
2025-07-22 17:24:08,334 - INFO - conv2d_12 (Conv2D)          (None, 32, 32, 4)            2164      ['tf.__operators__.getitem_1[0
2025-07-22 17:24:08,335 - INFO - ][0]']
2025-07-22 17:24:08,335 - INFO - amp (Lambda)                (None, 32, 32, 1)            0         ['conv2d_6[0][0]']
2025-07-22 17:24:08,335 - INFO - phi (Lambda)                (None, 32, 32, 4)            0         ['conv2d_12[0][0]']
2025-07-22 17:24:08,335 - INFO - amp_padded (ZeroPadding2D)  (None, 64, 64, 1)            0         ['amp[0][0]']
2025-07-22 17:24:08,335 - INFO - phase_padded (ZeroPadding2  (None, 64, 64, 4)            0         ['phi[0][0]']
2025-07-22 17:24:08,335 - INFO - D)
2025-07-22 17:24:08,335 - INFO - obj (Lambda)                (None, 64, 64, 4)            0         ['amp_padded[0][0]',
2025-07-22 17:24:08,335 - INFO - 'phase_padded[0][0]']
2025-07-22 17:24:08,335 - INFO - input_positions (InputLaye  [(None, 1, 2, 4)]            0         []
2025-07-22 17:24:08,335 - INFO - r)
2025-07-22 17:24:08,335 - INFO - padded_obj_2 (Lambda)       (None, 78, 78, 1)            0         ['obj[0][0]',
2025-07-22 17:24:08,335 - INFO - 'input_positions[0][0]']
2025-07-22 17:24:08,335 - INFO - padded_objs_with_offsets (  (None, None, None, 1)        0         ['padded_obj_2[0][0]',
2025-07-22 17:24:08,335 - INFO - Lambda)                                                             'input_positions[0][0]']
2025-07-22 17:24:08,335 - INFO - probe_illumination (ProbeI  ((None, 64, 64, 1),          4096      ['padded_objs_with_offsets[0][
2025-07-22 17:24:08,335 - INFO - llumination)                 (1, 1, 64, 64, 1))                    0]']
2025-07-22 17:24:08,335 - INFO - pred_amplitude (Lambda)     ((None, 64, 64, 1),          0         ['probe_illumination[0][0]']
2025-07-22 17:24:08,336 - INFO - (None, 64, 64, 1))
2025-07-22 17:24:08,336 - INFO - pred_diff_channels (Lambda  (None, 64, 64, 4)            0         ['pred_amplitude[0][1]']
2025-07-22 17:24:08,336 - INFO - )
2025-07-22 17:24:08,336 - INFO - tf.math.multiply (TFOpLamb  (None, 64, 64, 4)            0         ['pred_diff_channels[0][0]']
2025-07-22 17:24:08,336 - INFO - da)
2025-07-22 17:24:08,336 - INFO - trimmed_obj (Lambda)        (None, 64, 64, 1)            0         ['padded_obj_2[0][0]']
2025-07-22 17:24:08,336 - INFO - distribution_lambda (Distr  ((None, 64, 64, 4),          0         ['tf.math.multiply[0][0]']
2025-07-22 17:24:08,336 - INFO - ibutionLambda)               (None, 64, 64, 4))
2025-07-22 17:24:08,336 - INFO - ==================================================================================================
2025-07-22 17:24:08,336 - INFO - Total params: 2259473 (8.63 MB)
2025-07-22 17:24:08,337 - INFO - Trainable params: 2259473 (8.63 MB)
2025-07-22 17:24:08,337 - INFO - Non-trainable params: 0 (0.00 Byte)
2025-07-22 17:24:08,337 - INFO - __________________________________________________________________________________________________
2025-07-22 17:24:08,337 - INFO - None
2025-07-22 17:24:08,685 - INFO - input shape
2025-07-22 17:24:08,685 - INFO - (None, 64, 64, 1)
2025-07-22 17:24:08,936 - INFO - input shape
2025-07-22 17:24:08,936 - INFO - (None, 64, 64, 1)
2025-07-22 17:24:08,990 - INFO - Loading Baseline model from probe_generalization_study_corrected/ideal_gs1/baseline_run...
2025-07-22 17:24:08,990 - INFO - Found baseline model at: probe_generalization_study_corrected/ideal_gs1/baseline_run/07-22-2025-17.22.23_baseline_gs2/baseline_model.h5
2025-07-22 17:24:08,991 - DEBUG - Creating converter from 3 to 5
2025-07-22 17:24:09,257 - INFO - Baseline model expects 4 channels (gridsize=2)
2025-07-22 17:24:09,257 - INFO - PINN model expects 4 channels (gridsize=2)
2025-07-22 17:24:09,257 - INFO - DEBUG:
2025-07-22 17:24:09,257 - INFO - nsamples: 1000, gridsize: 2 (using smart group-first sampling)
2025-07-22 17:24:09,257 - INFO - Using grouping-aware subsampling strategy for gridsize=2
2025-07-22 17:24:09,258 - INFO - Groups cache loaded from dummy.g2k4.groups_cache.npz
2025-07-22 17:24:09,258 - INFO - Using 1553 cached groups
2025-07-22 17:24:09,258 - INFO - Randomly sampling 1000 groups from 1553 available groups
2025-07-22 17:24:09,258 - INFO - Selected 1000 groups for training
2025-07-22 17:24:09,267 - INFO - INFO: 'Y' array not found. Generating ground truth patches from 'objectGuess' as a fallback.
2025-07-22 17:24:15,549 - INFO - neighbor-sampled diffraction shape
2025-07-22 17:24:15,550 - INFO - (1000, 64, 64, 4)
2025-07-22 17:24:15,654 - INFO - loader: using provided ground truth patches.
2025-07-22 17:24:15,987 - INFO - INFO:
2025-07-22 17:24:15,987 - INFO - None
2025-07-22 17:24:15,987 - INFO - <PtychoDataContainer X=(1000, 64, 64, 4) Y_I=(1000, 64, 64, 4) Y_phi=(1000, 64, 64, 4) norm_Y_I=() coords_nominal=(1000, 1, 2, 4) coords_true=(1000, 1, 2, 4) nn_indices=(1000, 4) mean=501.153 global_offsets=(1000, 1, 2, 1) mean=112.434 local_offsets=(1000, 1, 2, 4) mean=0.000 probe=(64, 64) mean_amplitude=0.092>
2025-07-22 17:24:15,987 - INFO - Created PINN container with shape: (1000, 64, 64, 4)
2025-07-22 17:24:15,988 - INFO - DEBUG:
2025-07-22 17:24:15,988 - INFO - nsamples: 1000, gridsize: 2 (using smart group-first sampling)
2025-07-22 17:24:15,988 - INFO - Using grouping-aware subsampling strategy for gridsize=2
2025-07-22 17:24:15,988 - INFO - Groups cache loaded from dummy.g2k4.groups_cache.npz
2025-07-22 17:24:15,988 - INFO - Using 1553 cached groups
2025-07-22 17:24:15,988 - INFO - Randomly sampling 1000 groups from 1553 available groups
2025-07-22 17:24:15,989 - INFO - Selected 1000 groups for training
2025-07-22 17:24:15,997 - INFO - INFO: 'Y' array not found. Generating ground truth patches from 'objectGuess' as a fallback.
2025-07-22 17:24:22,315 - INFO - neighbor-sampled diffraction shape
2025-07-22 17:24:22,315 - INFO - (1000, 64, 64, 4)
2025-07-22 17:24:22,420 - INFO - loader: using provided ground truth patches.
2025-07-22 17:24:22,422 - INFO - INFO:
2025-07-22 17:24:22,422 - INFO - None
2025-07-22 17:24:22,422 - INFO - <PtychoDataContainer X=(1000, 64, 64, 4) Y_I=(1000, 64, 64, 4) Y_phi=(1000, 64, 64, 4) norm_Y_I=() coords_nominal=(1000, 1, 2, 4) coords_true=(1000, 1, 2, 4) nn_indices=(1000, 4) mean=498.076 global_offsets=(1000, 1, 2, 1) mean=112.436 local_offsets=(1000, 1, 2, 4) mean=0.000 probe=(64, 64) mean_amplitude=0.092>
2025-07-22 17:24:22,423 - INFO - Created baseline container with shape: (1000, 64, 64, 4)
2025-07-22 17:24:22,423 - INFO - GEMINI DIAGNOSTIC: Baseline model using 4-channel data (gridsize=2 neighboring patches)
2025-07-22 17:24:22,423 - INFO - GEMINI DIAGNOSTIC: PINN model using 4-channel data (gridsize=2 neighboring patches)
2025-07-22 17:24:22,423 - INFO - Running inference with PtychoPINN...
2025-07-22 17:24:22,423 - INFO - PINN input shape: (1000, 64, 64, 4) -> model expects: [(None, 64, 64, 4), (None, 1, 2, 4)]
2025-07-22 17:24:23,204 - INFO - 1/32 [..............................] - ETA: 22s
2025-07-22 17:24:23,254 - INFO - 13/32 [===========>..................] - ETA: 0s
2025-07-22 17:24:23,305 - INFO - 25/32 [======================>.......] - ETA: 0s
2025-07-22 17:24:23,549 - INFO - 32/32 [==============================] - ETA: 0s
2025-07-22 17:24:23,549 - INFO - 32/32 [==============================] - 1s 11ms/step
2025-07-22 17:24:23,590 - INFO - PtychoPINN inference completed successfully!
2025-07-22 17:24:23,591 - INFO - Reassembling PtychoPINN patches...
2025-07-22 17:24:24,063 - INFO - Running inference with Baseline model...
2025-07-22 17:24:24,063 - INFO - Baseline input shape: (1000, 64, 64, 4) -> model expects: (None, 64, 64, 4)
2025-07-22 17:24:24,337 - INFO - 1/32 [..............................] - ETA: 6s
2025-07-22 17:24:24,388 - INFO - 10/32 [========>.....................] - ETA: 0s
2025-07-22 17:24:24,440 - INFO - 19/32 [================>.............] - ETA: 0s
2025-07-22 17:24:24,493 - INFO - 28/32 [=========================>....] - ETA: 0s
2025-07-22 17:24:24,626 - INFO - 32/32 [==============================] - ETA: 0s
2025-07-22 17:24:24,626 - INFO - 32/32 [==============================] - 1s 9ms/step
2025-07-22 17:24:24,736 - INFO - Baseline inference completed successfully!
2025-07-22 17:24:24,915 - INFO - Reassembling baseline patches...
2025-07-22 17:24:24,980 - CRITICAL - Uncaught exception
Traceback (most recent call last):
  File "/home/ollie/Documents/PtychoPINN/scripts/compare_models.py", line 843, in <module>
    main()
  File "/home/ollie/Documents/PtychoPINN/scripts/compare_models.py", line 653, in main
    baseline_recon = reassemble_position(baseline_patches_complex, baseline_container.global_offsets, M=20)
  File "/home/ollie/Documents/PtychoPINN/ptycho/tf_helper.py", line 817, in reassemble_position
    return shift_and_sum(obj_tensor, global_offsets, M = M) /\
  File "/home/ollie/miniconda3/envs/ptycho-tf/lib/python3.10/site-packages/tensorflow/python/util/traceback_utils.py", line 153, in error_handler
    raise e.with_traceback(filtered_tb) from None
  File "/tmp/__autograph_generated_file5j1obczw.py", line 106, in tf__shift_and_sum
    result = ag__.converted_call(ag__.ld(tf).cond, (ag__.ld(total_texels) < ag__.ld(mem_cap_texels), ag__.ld(_vectorised), ag__.ld(_streaming)), None, fscope)
  File "/tmp/__autograph_generated_file5j1obczw.py", line 98, in _streaming
    (_, result) = ag__.converted_call(ag__.ld(tf).while_loop, (ag__.ld(cond), ag__.ld(body), [ag__.ld(i), ag__.ld(result)]), None, fscope_2)
ValueError: in user code:

    File "/home/ollie/Documents/PtychoPINN/ptycho/tf_helper.py", line 742, in _streaming  *
        _, result = tf.while_loop(cond, body, [i, result])

    ValueError: Input tensor `cond/zeros:0` enters the loop with shape (None, None, 1), but has shape (None, None, None) after one iteration. To allow the shape to vary across iterations, use the `shape_invariants` argument of tf.while_loop to specify a less-specific shape.

2025-07-22 17:24:24,980 - ERROR - Traceback (most recent call last):
2025-07-22 17:24:24,980 - ERROR - File "/home/ollie/Documents/PtychoPINN/scripts/compare_models.py", line 843, in <module>
2025-07-22 17:24:24,981 - ERROR - main()
2025-07-22 17:24:24,981 - ERROR - File "/home/ollie/Documents/PtychoPINN/scripts/compare_models.py", line 653, in main
2025-07-22 17:24:24,981 - ERROR - baseline_recon = reassemble_position(baseline_patches_complex, baseline_container.global_offsets, M=20)
2025-07-22 17:24:24,981 - ERROR - File "/home/ollie/Documents/PtychoPINN/ptycho/tf_helper.py", line 817, in reassemble_position
2025-07-22 17:24:24,981 - ERROR - return shift_and_sum(obj_tensor, global_offsets, M = M) /\
2025-07-22 17:24:24,981 - ERROR - File "/home/ollie/miniconda3/envs/ptycho-tf/lib/python3.10/site-packages/tensorflow/python/util/traceback_utils.py", line 153, in error_handler
2025-07-22 17:24:24,981 - ERROR - raise e.with_traceback(filtered_tb) from None
2025-07-22 17:24:24,981 - ERROR - File "/tmp/__autograph_generated_file5j1obczw.py", line 106, in tf__shift_and_sum
2025-07-22 17:24:24,981 - ERROR - result = ag__.converted_call(ag__.ld(tf).cond, (ag__.ld(total_texels) < ag__.ld(mem_cap_texels), ag__.ld(_vectorised), ag__.ld(_streaming)), None, fscope)
2025-07-22 17:24:24,981 - ERROR - File "/tmp/__autograph_generated_file5j1obczw.py", line 98, in _streaming
2025-07-22 17:24:24,981 - ERROR - (_, result) = ag__.converted_call(ag__.ld(tf).while_loop, (ag__.ld(cond), ag__.ld(body), [ag__.ld(i), ag__.ld(result)]), None, fscope_2)
2025-07-22 17:24:24,981 - ERROR - ValueError
2025-07-22 17:24:24,981 - ERROR - :
2025-07-22 17:24:24,981 - ERROR - in user code:

    File "/home/ollie/Documents/PtychoPINN/ptycho/tf_helper.py", line 742, in _streaming  *
        _, result = tf.while_loop(cond, body, [i, result])

    ValueError: Input tensor `cond/zeros:0` enters the loop with shape (None, None, 1), but has shape (None, None, None) after one iteration. To allow the shape to vary across iterations, use the `shape_invariants` argument of tf.while_loop to specify a less-specific shape.
