# Agent Implementation Checklist: Phase 2 - Integration, Validation, and Documentation

**Overall Goal for this Phase:** To validate the corrected MS-SSIM metric within the full comparison workflow and update project documentation.

**Instructions for Agent:**
1. Copy this checklist into your working memory.
2. Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3. Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID | Task Description | State | How/Why & API Guidance |
| :-- | :-- | :-- | :-- |
| **Section 0: Preparation & Context Priming** |
| 0.A | **Review Phase 1 Completion Status** | `[ ]` | **Why:** To ensure Phase 1 deliverables are complete before starting integration. <br> **How:** Verify that `ptycho/evaluation.py` contains the corrected `ms_ssim` function and `tests/test_evaluation.py` exists with passing tests. Run `python -m unittest tests.test_evaluation` to confirm. <br> **Dependencies:** Phase 1 must be completed. |
| 0.B | **Identify Integration Test Dataset** | `[ ]` | **Why:** To have a consistent test case for validating the corrected MS-SSIM metrics. <br> **How:** Use the same dataset and model directories that previously produced the faulty MS-SSIM > SSIM results. Document the exact paths for reproducibility. <br> **Suggested:** Use models from `large_generalization_study_tike_test/train_1024/` with test data `tike_outputs/fly001_final_downsampled/fly001_final_downsampled_data_transposed.npz`. |
| **Section 1: Integration Testing with Real Models** |
| 1.A | **Execute compare_models.py with corrected MS-SSIM** | `[ ]` | **Why:** To generate new comparison metrics using the corrected MS-SSIM implementation. <br> **How:** Run `python scripts/compare_models.py --pinn_dir <pinn_model> --baseline_dir <baseline_model> --test_data <test_data> --output_dir ms_ssim_validation_test`. Use the same exact parameters as the original run that showed the bug. <br> **File:** `scripts/compare_models.py`. |
| 1.B | **Validate MS-SSIM ≤ SSIM constraint** | `[ ]` | **Why:** To confirm the primary bug is fixed - MS-SSIM values should never exceed SSIM values. <br> **How:** Load the generated `comparison_metrics.csv` and verify that for both PtychoPINN and Baseline models: `ms_ssim_amplitude <= ssim_amplitude` and `ms_ssim_phase <= ssim_phase`. Log any violations. <br> **Success Criteria:** All MS-SSIM values ≤ corresponding SSIM values. |
| 1.C | **Check metric reasonableness** | `[ ]` | **Why:** To ensure the corrected values are in expected ranges and make intuitive sense. <br> **How:** Verify that MS-SSIM values are in [0,1] range and that they follow expected patterns (e.g., better models should have higher MS-SSIM). Compare with other metrics for consistency. <br> **File:** Generated `comparison_metrics.csv`. |
| **Section 2: Regression Testing** |
| 2.A | **Verify other metrics unchanged** | `[ ]` | **Why:** To ensure the MS-SSIM fix didn't accidentally break other evaluation metrics. <br> **How:** Compare the new `comparison_metrics.csv` with the original faulty version. Verify that MAE, MSE, PSNR, SSIM, and FRC50 values are identical or very close (within numerical precision). Only MS-SSIM should have changed significantly. <br> **File:** Compare CSV files. |
| 2.B | **Test with different datasets** | `[ ]` | **Why:** To ensure the fix works across different image types and model configurations. <br> **How:** Run the comparison workflow on at least one additional dataset (e.g., different training size models or different test data). Verify MS-SSIM ≤ SSIM constraint holds consistently. <br> **File:** Additional test runs. |
| 2.C | **Validate debug image generation** | `[ ]` | **Why:** To ensure the corrected MS-SSIM works with debug visualization features. <br> **How:** Run comparison with `--save-debug-images` flag. Verify that debug images are generated correctly and no errors occur during MS-SSIM preprocessing visualization. <br> **File:** Check debug image outputs. |
| **Section 3: Documentation Updates** |
| 3.A | **Update ms_ssim function docstring** | `[ ]` | **Why:** To accurately document the corrected implementation and remove any outdated warnings. <br> **How:** Update the docstring in `ptycho/evaluation.py` for the `ms_ssim` function to describe the correct multi-scale algorithm, standard weights used, and expected behavior. Remove any mentions of "simplified" or "approximated" versions. <br> **File:** `ptycho/evaluation.py`. |
| 3.B | **Update eval_reconstruction function docstring** | `[ ]` | **Why:** To ensure the main evaluation function documentation reflects the corrected MS-SSIM behavior. <br> **How:** Review and update the docstring for `eval_reconstruction` to mention that MS-SSIM is now computed using the standard algorithm and will always be ≤ SSIM. <br> **File:** `ptycho/evaluation.py`. |
| 3.C | **Update PROJECT_STATUS.md** | `[ ]` | **Why:** To mark the MS-SSIM correction initiative as complete and update the project status. <br> **How:** Add a completion entry to `docs/PROJECT_STATUS.md` under the MS-SSIM initiative. Include a brief summary of what was fixed and reference the corrected implementation. <br> **File:** `docs/PROJECT_STATUS.md`. |
| **Section 4: Performance and Edge Case Testing** |
| 4.A | **Test with edge case images** | `[ ]` | **Why:** To ensure the corrected MS-SSIM handles edge cases robustly. <br> **How:** Test with: 1) Identical images (should return ≈1.0), 2) Very different images (should return low values), 3) Images with uniform regions, 4) Very small images (near minimum size for multi-scale processing). <br> **File:** Add edge case tests to `tests/test_evaluation.py` or run manual tests. |
| 4.B | **Verify performance characteristics** | `[ ]` | **Why:** To ensure the corrected implementation doesn't significantly impact evaluation speed. <br> **How:** Time the MS-SSIM computation before and after the fix using the same test images. The corrected version should be comparable in speed (within ~2x) to the original faulty version. <br> **File:** Performance measurement tests. |
| 4.C | **Test parameter sensitivity** | `[ ]` | **Why:** To verify the MS-SSIM is not overly sensitive to the sigma parameter or other configuration. <br> **How:** Test the corrected MS-SSIM with different `ms_ssim_sigma` values (0.5, 1.0, 2.0) and verify results are reasonable and monotonic. Higher sigma should generally produce slightly higher MS-SSIM values. <br> **File:** Parameter sensitivity tests. |
| **Section 5: Final Validation and Cleanup** |
| 5.A | **Run complete test suite** | `[ ]` | **Why:** To ensure the entire project test suite passes with the corrected MS-SSIM implementation. <br> **How:** Run `python -m unittest discover -s tests` and `python -m unittest discover -s ptycho -p "test_*.py"` to execute all project tests. All tests should pass. <br> **File:** Full test suite execution. |
| 5.B | **Generate final validation report** | `[ ]` | **Why:** To document the successful completion of the MS-SSIM correction and provide evidence of the fix. <br> **How:** Create a brief summary showing: 1) Before/after MS-SSIM values from the same test case, 2) Confirmation that MS-SSIM ≤ SSIM constraint is satisfied, 3) Evidence that other metrics were not affected. <br> **File:** Create validation summary document. |
| 5.C | **Code formatting and cleanup** | `[ ]` | **Why:** To maintain code quality and remove any temporary debugging code. <br> **How:** Run code formatters (black, ruff) on all modified files. Remove any debug print statements or temporary code added during development. Ensure consistent code style. <br> **File:** All modified files. |
| **Section 6: Archive and Completion** |
| 6.A | **Archive test outputs** | `[ ]` | **Why:** To preserve evidence of the successful fix for future reference. <br> **How:** Save the validation test outputs (comparison_metrics.csv, plots, debug images) to a dedicated directory like `ms_ssim_validation_outputs/`. Include a README explaining what was tested. <br> **File:** Archive directory creation. |
| 6.B | **Update initiative status** | `[ ]` | **Why:** To officially mark the MS-SSIM correction initiative as complete. <br> **How:** Update the status in `docs/initiatives/plan_ms_ssim_correction.md` from "Planning Phase" to "Completed". Add completion date and link to validation evidence. <br> **File:** `docs/initiatives/plan_ms_ssim_correction.md`. |
| 6.C | **Final verification checkpoint** | `[ ]` | **Why:** To ensure all deliverables are complete and the initiative can be considered finished. <br> **How:** Review the original success criteria from the R&D plan: 1) Corrected `ms_ssim` function implemented ✓, 2) Unit tests passing ✓, 3) Integration tests showing MS-SSIM ≤ SSIM ✓, 4) No regressions in other metrics ✓. <br> **File:** Final checklist review. |