### **Phase 1 Checklist**

I have generated the detailed checklist for the first phase of this initiative and saved it to `docs/refactor/ms_ssim_fix/phase_1_checklist_ms_ssim_fix.md`.

Here is the content of the generated file:

### **Agent Implementation Checklist: Phase 1 - Core Function Replacement and Unit Testing**

**Overall Goal for this Phase:** To replace the incorrect `ms_ssim` function in `ptycho/evaluation.py` with a correct version and to create a new unit test suite to validate it.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[ ]` | **Why:** To load the necessary context and technical specifications before coding. <br> **Docs:** `docs/refactor/ms_ssim_fix/plan_ms_ssim_fix.md`. <br> **APIs:** `skimage.metrics.structural_similarity(..., full=True)`, `scipy.ndimage.gaussian_filter`.
| 0.B | **Identify Target Files for Modification/Creation**| `[ ]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `ptycho/evaluation.py` (Modify), `tests/test_evaluation.py` (Create).
| **Section 1: MS-SSIM Core Logic Implementation**
| 1.A | **Replace `ms_ssim` function content**             | `[ ]` | **Why:** The existing logic is mathematically incorrect and must be completely replaced. <br> **How:** Delete the body of the current `ms_ssim` function. Implement the new logic that iteratively downsamples the images and computes weighted SSIM components. <br> **File:** `ptycho/evaluation.py`.
| 1.B | **Implement Multi-Scale Loop**                     | `[ ]` | **Why:** To process the image at different scales as required by the MS-SSIM algorithm. <br> **How:** Use `skimage.metrics.structural_similarity(..., full=True)` inside a loop. At each iteration, apply a Gaussian filter and downsample the images by a factor of 2. <br> **File:** `ptycho/evaluation.py`.
| 1.C | **Separate Luminance, Contrast, and Structure**    | `[ ]` | **Why:** The MS-SSIM formula treats these components differently. <br> **How:** The `full=True` argument returns a full SSIM map `S`. The contrast-structure term is `S.mean()`. The luminance term `l` and contrast term `c` must be calculated from the raw images as per the skimage documentation. <br> **File:** `ptycho/evaluation.py`.
| 1.D | **Apply Correct Weights and Formula**              | `[ ]` | **Why:** To correctly combine the components from each scale. <br> **How:** Use the standard weights `[0.0448, 0.2856, 0.3001, 0.2363, 0.1333]`. The final score is a product of the luminance at the last scale and the contrast/structure terms at all other scales, each raised to the power of its corresponding weight. <br> **File:** `ptycho/evaluation.py`.
| **Section 2: Unit Testing**
| 2.A | **Create new test file `tests/test_evaluation.py`** | `[ ]` | **Why:** To establish a dedicated location for testing evaluation metrics, following project conventions. <br> **How:** Create the new file with the standard `unittest` boilerplate. <br> **File:** `tests/test_evaluation.py`.
| 2.B | **Add `test_ms_ssim_self_comparison`**             | `[ ]` | **Why:** To verify the most basic property of the metric: an image compared to itself should yield a perfect score. <br> **How:** Create a random numpy array `img`. Assert that `ms_ssim(img, img)` is `pytest.approx(1.0)`. <br> **File:** `tests/test_evaluation.py`.
| 2.C | **Add `test_ms_ssim_less_than_or_equal_to_ssim`**   | `[ ]` | **Why:** To verify that the corrected MS-SSIM is generally not greater than SSIM, which was the original bug. <br> **How:** Create two slightly different random images `img1` and `img2`. Calculate both `ssim_val = structural_similarity(img1, img2)` and `ms_ssim_val = ms_ssim(img1, img2)`. Assert that `ms_ssim_val <= ssim_val`. <br> **File:** `tests/test_evaluation.py`.
| 2.D | **Add `test_ms_ssim_with_known_shift`**            | `[ ]` | **Why:** To test robustness against simple translations. <br> **How:** Create an image and a slightly shifted version. The MS-SSIM should be high but less than 1.0. This tests that the metric is sensitive but not overly so. <br> **File:** `tests/test_evaluation.py`.
| **Section 3: Finalization**
| 3.A | **Run All Tests**                                  | `[ ]` | **Why:** To ensure the new tests pass and that no existing functionality was broken. <br> **How:** From the project root, run `python -m unittest discover -s tests`.
| 3.B | **Code Formatting & Linting**                      | `[ ]` | **Why:** To maintain code quality and project standards. <br> **How:** Run the project's standard formatters (e.g., Black) and linters (e.g., Ruff) on all modified files.
| 3.C | **Update Function Docstring**                      | `[ ]` | **Why:** To accurately document the corrected function's behavior. <br> **How:** Update the docstring for `ms_ssim` in `ptycho/evaluation.py` to reflect the new, correct implementation and remove any notes about it being a "simplified" version.
