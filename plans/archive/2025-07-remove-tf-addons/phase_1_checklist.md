# Phase 1: Core Implementation and Validation Checklist

**Initiative:** Remove TensorFlow Addons Dependency
**Created:** 2025-07-27
**Phase Goal:** To implement the native TensorFlow translation function and validate it produces identical results to the tensorflow-addons version.
**Deliverable:** Updated `ptycho/tf_helper.py` with new `translate_core()` function and comprehensive test file `tests/test_tf_helper.py` proving numerical equivalence.

## ✅ Task List

### Instructions:
1. Work through tasks in order. Dependencies are noted in the guidance column.
2. The **"How/Why & API Guidance"** column contains all necessary details for implementation.
3. Update the `State` column as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context**
| 0.A | **Review TF Addons Usage & API**                    | `[ ]` | **Why:** To understand the exact API we need to replicate and how it's currently used. <br> **Actions:** <br> 1. Review `tensorflow_addons.image.translate` documentation <br> 2. Examine current usage in `ptycho/tf_helper.py` lines 515-523 <br> 3. Note that it's wrapped with `@complexify_function` decorator <br> **Key insights:** The function takes images and offsets tensors, supports interpolation parameter
| 0.B | **Study TF Raw Ops API**                    | `[ ]` | **Why:** To understand the native TensorFlow API we'll use as replacement. <br> **Actions:** <br> 1. Review `tf.raw_ops.ImageProjectiveTransformV3` documentation <br> 2. Understand transformation matrix format (3x3 for 2D transforms) <br> 3. Note coordinate system differences between TFA and TF raw ops <br> **Key API:** `tf.raw_ops.ImageProjectiveTransformV3(images, transforms, output_shape, interpolation, fill_mode)`
| **Section 1: Core Implementation**
| 1.A | **Create translate_core Function**                   | `[ ]` | **Why:** To implement the core translation logic using native TensorFlow ops. <br> **File:** `ptycho/tf_helper.py` <br> **Location:** Add after line 514, before the current `translate` function <br> **Implementation:** <br> ```python<br>def translate_core(images, translations, interpolation='bilinear'):<br>    """Translate images using native TensorFlow ops.<br>    <br>    Args:<br>        images: Tensor of shape (batch, height, width, channels)<br>        translations: Tensor of shape (batch, 2) with [dy, dx] offsets<br>        interpolation: 'bilinear' or 'nearest'<br>    <br>    Returns:<br>        Translated images with same shape as input<br>    """<br>    # Implementation using tf.raw_ops.ImageProjectiveTransformV3<br>``` <br> **Key considerations:** <br> - TFA uses [dy, dx] order for translations <br> - Need to construct 3x3 transformation matrices <br> - Handle batch processing correctly
| 1.B | **Implement Transformation Matrix Construction**     | `[ ]` | **Why:** ImageProjectiveTransformV3 requires transformation matrices, not simple offsets. <br> **Details:** <br> - Create identity matrices and modify translation components <br> - Matrix format for translation: [[1, 0, tx], [0, 1, ty], [0, 0, 1]] <br> - Note: TF uses inverse transformation (translate by -offset) <br> - Handle batched translations correctly <br> **Code location:** Inside `translate_core` function
| 1.C | **Handle Coordinate System Differences**            | `[ ]` | **Why:** TensorFlow and TFA may use different coordinate conventions. <br> **Tasks:** <br> 1. Verify coordinate system (pixel centers vs corners) <br> 2. Adjust transformation matrix if needed <br> 3. Test with simple known translations to verify correctness <br> **Verification:** Create small test images and verify pixel-perfect translation
| 1.D | **Add Interpolation Mode Handling**                 | `[ ]` | **Why:** To support both bilinear and nearest neighbor interpolation. <br> **Implementation:** <br> - Map 'bilinear' to 'BILINEAR' for TF raw ops <br> - Map 'nearest' to 'NEAREST' <br> - Set appropriate fill_mode (likely 'CONSTANT' with 0 fill)
| **Section 2: Integration with Existing Code**
| 2.A | **Update translate Function**                       | `[ ]` | **Why:** To use the new core implementation while maintaining the same API. <br> **File:** `ptycho/tf_helper.py` <br> **Changes:** <br> 1. Comment out line 515: `from tensorflow_addons.image import translate as _translate` <br> 2. Replace `_translate(imgs, offsets, **kwargs)` with `translate_core(imgs, offsets, **kwargs)` <br> 3. Ensure the `@complexify_function` decorator still works correctly <br> **Line numbers:** Approximately lines 515-523
| 2.B | **Update Translation Class**                        | `[ ]` | **Why:** The Translation layer class also uses the translate function. <br> **File:** `ptycho/tf_helper.py` <br> **Location:** Lines 525-532 <br> **Verify:** The class should automatically use the updated translate function <br> **Test:** Ensure jitter addition still works correctly
| **Section 3: Test Implementation**
| 3.A | **Create Test File Structure**                      | `[ ]` | **Why:** To organize comprehensive tests for the new implementation. <br> **Actions:** <br> 1. Create `tests/test_tf_helper.py` if it doesn't exist <br> 2. Add necessary imports: unittest, numpy, tensorflow, tensorflow_addons <br> 3. Set up TestCase class: `class TestTranslateFunction(unittest.TestCase):`
| 3.B | **Implement Direct Comparison Test**                | `[ ]` | **Why:** To prove numerical equivalence with the TFA implementation. <br> **Test name:** `test_translate_core_matches_addons` <br> **Implementation:** <br> 1. Import both implementations <br> 2. Create test tensors: `(2, 64, 64, 1)` shape <br> 3. Create test offsets: `[[2.5, -1.7], [0.0, 3.2]]` <br> 4. Run both functions with same inputs <br> 5. Assert: `np.testing.assert_allclose(result_new, result_old, atol=1e-6)` <br> **Critical:** Keep TFA import in test file for comparison
| 3.C | **Test Edge Cases - Zero Translation**              | `[ ]` | **Why:** To ensure identity transform works correctly. <br> **Test name:** `test_zero_translation` <br> **Cases:** <br> - Zero offsets: `[[0.0, 0.0]]` <br> - Verify output equals input exactly <br> - Test with different image sizes
| 3.D | **Test Edge Cases - Integer Translation**           | `[ ]` | **Why:** To verify exact pixel shifts work correctly. <br> **Test name:** `test_integer_translation` <br> **Cases:** <br> - Integer offsets: `[[5, -3]]`, `[[-2, 4]]` <br> - Create images with known patterns <br> - Verify pixel-perfect shifts
| 3.E | **Test Edge Cases - Sub-pixel Translation**         | `[ ]` | **Why:** To verify interpolation works correctly. <br> **Test name:** `test_subpixel_translation` <br> **Cases:** <br> - Sub-pixel offsets: `[[0.5, 0.5]]`, `[[0.25, -0.75]]` <br> - Use smooth test images (gradients) <br> - Compare interpolated values
| 3.F | **Test Complex Tensor Support**                     | `[ ]` | **Why:** To ensure the @complexify_function decorator works with new implementation. <br> **Test name:** `test_complex_tensor_translation` <br> **Implementation:** <br> 1. Create complex tensor: real + imaginary parts <br> 2. Apply translation <br> 3. Verify both parts translated correctly <br> 4. Compare with TFA on complex tensors
| 3.G | **Test Batch Processing**                           | `[ ]` | **Why:** To ensure batched translations work correctly. <br> **Test name:** `test_batch_translation` <br> **Cases:** <br> - Different batch sizes: 1, 4, 16 <br> - Different offsets per image in batch <br> - Verify each image translated independently
| **Section 4: Performance Validation**
| 4.A | **Create Performance Benchmark**                    | `[ ]` | **Why:** To ensure no significant performance regression. <br> **Implementation:** <br> 1. Create benchmark script or test method <br> 2. Time both implementations on typical workload <br> 3. Test sizes: (32, 128, 128, 1), (64, 64, 64, 4) <br> 4. Run 100 iterations, measure average time <br> **Acceptable:** Within 20% of TFA performance
| 4.B | **Test GPU Compatibility**                          | `[ ]` | **Why:** To ensure the implementation works on GPU if available. <br> **Actions:** <br> 1. Run tests with GPU device placement if available <br> 2. Verify no device placement errors <br> 3. Compare GPU performance with TFA
| **Section 5: Code Quality**
| 5.A | **Add Comprehensive Docstrings**                    | `[ ]` | **Why:** To document the new implementation clearly. <br> **Tasks:** <br> 1. Complete docstring for `translate_core` <br> 2. Document parameter shapes and types <br> 3. Add usage examples <br> 4. Note any limitations or differences from TFA
| 5.B | **Code Review and Cleanup**                         | `[ ]` | **Why:** To ensure code quality and maintainability. <br> **Actions:** <br> 1. Remove any debug print statements <br> 2. Ensure consistent code style <br> 3. Add type hints if appropriate <br> 4. Verify no unused imports

---

## 🎯 Success Criteria

**This phase is complete when:**
1. All tasks in the table above are marked `[D]` (Done).
2. The phase success test passes: `python -m unittest tests.test_tf_helper` 
3. Numerical comparison shows results match within 1e-6 tolerance
4. No performance regression greater than 20%

## 📝 Notes

- Keep the TensorFlow Addons import in the test file for comparison purposes
- Do not remove TensorFlow Addons from setup.py in this phase
- Focus on exact numerical equivalence - optimization can come later if needed