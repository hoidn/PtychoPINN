### **Agent Implementation Checklist: Phase 3 - MS-SSIM Metric Integration (Revised)**

**Overall Goal for this Phase:** To implement the Multi-Scale Structural Similarity (MS-SSIM) metric, using the correct pre-processing pipeline, and to add robust, specific debugging visualizations for both MS-SSIM and FRC.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[D]` | **Why:** To load the necessary context and technical specifications before coding. <br> **Docs:** `docs/refactor/eval_enhancements/plan_eval_enhancements.md`, `ptycho/evaluation.py`. <br> **APIs:** `skimage.metrics.structural_similarity`, `numpy.linalg.lstsq`.
| 0.B | **Identify Target Files for Modification**| `[D]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `ptycho/evaluation.py` (Modify), `scripts/compare_models.py` (Modify).
| **Section 1: Implement Shared Debug Visualization Utility (DRY Principle)**
| 1.A | **Create _save_debug_image helper function**                   | `[D]` | **Why:** To avoid duplicating plotting code for FRC and MS-SSIM debugging. <br> **How:** In `ptycho/evaluation.py`, create a private helper function `_save_debug_image(image_data, filename_suffix, output_dir)`. This function should use `matplotlib.pyplot.imsave` to save the `image_data` to a file in the specified `output_dir`. It should handle path creation. <br> **File:** `ptycho/evaluation.py`.
| **Section 2: Implement MS-SSIM Logic**
| 2.A | **Create ms_ssim helper function**                   | `[D]` | **Why:** To encapsulate the logic for Multi-Scale SSIM calculation. <br> **How:** In `ptycho/evaluation.py`, create a function `ms_ssim(img1, img2, levels=5)`. Use the implementation from the external review as a reference. It should iteratively downsample and calculate SSIM at each level using the standard weights. <br> **File:** `ptycho/evaluation.py`.
| 2.B | **Integrate ms_ssim into eval_reconstruction**                   | `[D]` | **Why:** To make MS-SSIM part of the standard evaluation suite. <br> **How:** In `eval_reconstruction`, after the phase and amplitude data have been pre-processed, call the new `ms_ssim` function for both amplitude and phase pairs. Store the results in `ms_ssim_amp` and `ms_ssim_phi`. <br> **File:** `ptycho/evaluation.py`.
| 2.C | **Add ms_ssim to return dictionary**                   | `[D]` | **Why:** To expose the new metric to downstream scripts. <br> **How:** Add a new key `'ms_ssim': (ms_ssim_amp, ms_ssim_phi)` to the dictionary returned by `eval_reconstruction`. <br> **File:** `ptycho/evaluation.py`.
| **Section 3: Add Specific Debug Visualizations**
| 3.A | **Add debug hook for MS-SSIM pre-processing**                        | `[D]` | **Why:** To visually verify the exact inputs to the MS-SSIM calculation. <br> **How:** In `eval_reconstruction`, add a new boolean parameter `debug_save_images=False`. If `True`, use the `_save_debug_image` utility to save the following two images: <br> 1. The final, aligned predicted phase (`phi_pred_aligned`). <br> 2. The final target phase (`phi_target`). <br> Filenames should be descriptive, e.g., `pinn_phase_for_ms-ssim.png`. <br> **File:** `ptycho/evaluation.py`.
| 3.B | **Add debug hook for FRC pre-processing**                        | `[D]` | **Why:** To visually verify the exact inputs to the FRC calculation. <br> **How:** In the `frc50` function, add a `debug_save_images=False` parameter. If `True`, use the `_save_debug_image` utility to save the following two images: <br> 1. The target image array. <br> 2. The pred image array. <br> Filenames should be descriptive, e.g., `pinn_amp_for_frc.png`. <br> **File:** `ptycho/evaluation.py`.
| **Section 4: Update Reporting Script**
| 4.A | **Update compare_models.py to handle ms_ssim**                   | `[D]` | **Why:** To ensure the new metric is saved and reported correctly. <br> **How:** In `scripts/compare_models.py`, modify the `save_metrics_csv` function to correctly handle the new `'ms_ssim'` key from the metrics dictionary, adding it to the tidy-format DataFrame. Also, add it to the console log output. <br> **File:** `scripts/compare_models.py`.
| 4.B | **Add debug flag to compare_models.py**                   | `[D]` | **Why:** To allow users to easily trigger the creation of debug images. <br> **How:** Add a `--save-debug-images` command-line flag to `scripts/compare_models.py`. If this flag is present, pass `debug_save_images=True` to the `eval_reconstruction` call. The output directory for the debug images should be a subdirectory within the main output directory. <br> **File:** `scripts/compare_models.py`.
| **Section 5: Finalization**
| 5.A | **Code Formatting & Linting**                      | `[D]` | **Why:** To maintain code quality and project standards. <br> **How:** Run the project's standard formatters and linters on all modified files.
| 5.B | **End-to-end Integration Test**                           | `[D]` | **Why:** To verify the complete workflow with the new metric. <br> **How:** Run `scripts/compare_models.py` with the `--save-debug-images` flag. Verify that: (1) the script completes without errors, (2) the output `comparison_metrics.csv` contains a valid `ms_ssim` row, and (3) a `debug_images/` subdirectory is created and contains the four expected PNG files (pred/target for phase, pred/target for amp).