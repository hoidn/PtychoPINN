### **Agent Implementation Checklist: Phase 1 - Core Evaluation Function Enhancement**

**Overall Goal for this Phase:** To update the `ptycho/evaluation.py` module with new SSIM metric integration, configurable phase alignment, and enhanced FRC functionality.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[ ]` | **Why:** To load the necessary context and technical specifications before coding. <br> **Docs:** `docs/refactor/eval_enhancements/plan_eval_enhancements.md`, `docs/DEVELOPER_GUIDE.md` Section 5. <br> **APIs:** `skimage.metrics.structural_similarity`, `numpy.linalg.lstsq`, `numpy.meshgrid`, `ptycho.evaluation.frc50`.
| 0.B | **Identify Target Files for Modification**| `[ ]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `ptycho/evaluation.py` (Modify - core function updates), `ptycho/evaluation.py` (Add new functions for plane fitting).
| **Section 1: SSIM Integration**
| 1.A | **Add SSIM import and data range calculation**                   | `[ ]` | **Why:** SSIM requires proper data range specification for accurate calculation. <br> **How:** Add `from skimage.metrics import structural_similarity` import. Create helper function to calculate data range: `data_range = arr.max() - arr.min()`. <br> **File:** `ptycho/evaluation.py`.
| 1.B | **Implement SSIM calculation for amplitude**                   | `[ ]` | **Why:** Amplitude SSIM provides perceptual quality metric. <br> **How:** In `eval_reconstruction`, add `ssim_amp = structural_similarity(amp_target[:,:,0], amp_pred[:,:,0], data_range=amp_target.max()-amp_target.min())`. <br> **File:** `ptycho/evaluation.py`.
| 1.C | **Implement SSIM calculation for phase with scaling**                   | `[ ]` | **Why:** Phase SSIM requires scaling from [-π,π] to [0,1] as per R&D plan. <br> **How:** Scale phase to [0,1]: `phase_scaled = (phase + np.pi) / (2 * np.pi)`. Then apply SSIM with `data_range=1.0`. <br> **File:** `ptycho/evaluation.py`.
| **Section 2: Phase Alignment Implementation**
| 2.A | **Create plane fitting helper function**                        | `[ ]` | **Why:** Plane fitting requires solving linear system A·x = d for coefficients [a,b,c]. <br> **How:** Create function `fit_and_remove_plane(phase_img, coords_y, coords_x)` using `np.linalg.lstsq`. Matrix A has columns [x_coords, y_coords, ones]. <br> **File:** `ptycho/evaluation.py`.
| 2.B | **Add phase_align_method parameter to eval_reconstruction**                        | `[ ]` | **Why:** Enable switching between 'plane' (default) and 'mean' alignment methods. <br> **How:** Add `phase_align_method='plane'` parameter to function signature. Add conditional logic to choose alignment method. <br> **File:** `ptycho/evaluation.py`.
| 2.C | **Replace highpass2d with configurable alignment**                        | `[ ]` | **Why:** Remove hardcoded highpass filtering and implement switchable alignment as per R&D plan. <br> **How:** Replace `highpass2d(phi, n=lowpass_n)` calls with alignment logic based on `phase_align_method` parameter. For 'plane': use plane fitting. For 'mean': subtract mean. <br> **File:** `ptycho/evaluation.py`.
| **Section 3: Enhanced FRC Implementation**
| 3.A | **Add frc_sigma parameter to frc50 function**                   | `[ ]` | **Why:** Make FRC smoothing configurable and transparent. <br> **How:** Update `frc50` function signature to include `frc_sigma=0` parameter (0 means no smoothing). Replace hardcoded `sigma=1` with `frc_sigma` parameter. <br> **File:** `ptycho/evaluation.py`.
| 3.B | **Return raw FRC curve from frc50 function**                   | `[ ]` | **Why:** Expose full FRC curve for analysis, not just frc50 value. <br> **How:** Current function returns `(shellcorr, frc50_value)`. Ensure `shellcorr` (raw curve) is properly returned and accessible. <br> **File:** `ptycho/evaluation.py`.
| 3.C | **Update eval_reconstruction to use enhanced FRC**                   | `[ ]` | **Why:** Integrate configurable FRC into main evaluation function. <br> **How:** Update calls to `frc50` to pass `frc_sigma` parameter (default 0). Ensure both raw FRC curve and frc50 value are captured and returned. <br> **File:** `ptycho/evaluation.py`.
| **Section 4: Return Dictionary Enhancement**
| 4.A | **Add SSIM to return dictionary**                        | `[ ]` | **Why:** Expose SSIM metric in function output for downstream use. <br> **How:** Add `'ssim': (ssim_amp, ssim_phi)` to the return dictionary in `eval_reconstruction`. <br> **File:** `ptycho/evaluation.py`.
| 4.B | **Preserve all existing metrics for backwards compatibility**                        | `[ ]` | **Why:** Ensure no breaking changes to existing scripts. <br> **How:** Verify return dictionary still contains: `'mae'`, `'mse'`, `'psnr'`, `'frc50'`, `'frc'`. All existing keys must remain unchanged. <br> **File:** `ptycho/evaluation.py`.
| **Section 5: Unit Testing**
| 5.A | **Test SSIM self-comparison returns 1.0**                        | `[ ]` | **Why:** Verify SSIM implementation correctness. <br> **How:** Create test: `test_img = np.random.rand(64,64); ssim_val = structural_similarity(test_img, test_img, data_range=1.0); assert np.isclose(ssim_val, 1.0)`. <br> **File:** `ptycho/evaluation.py` (inline test or comment).
| 5.B | **Test plane fitting removes known planes**                        | `[ ]` | **Why:** Verify plane fitting implementation correctness. <br> **How:** Create test with known plane `z = 0.1*x + 0.2*y + 0.5`. After alignment with zero reference, result should be near-zero. <br> **File:** `ptycho/evaluation.py` (inline test or comment).
| 5.C | **Test FRC self-comparison returns all 1s**                        | `[ ]` | **Why:** Verify FRC implementation handles edge cases correctly. <br> **How:** Create test: `test_img = np.random.rand(64,64); frc_curve, frc50_val = frc50(test_img, test_img, frc_sigma=0); assert np.allclose(frc_curve, 1.0)`. <br> **File:** `ptycho/evaluation.py` (inline test or comment).
| **Section 6: Finalization**
| 6.A | **Code Formatting & Linting**                      | `[ ]` | **Why:** To maintain code quality and project standards. <br> **How:** Review code for consistent indentation, remove any debug prints, ensure proper docstrings for new functions.
| 6.B | **Update Function Docstring**                           | `[ ]` | **Why:** Document new parameters and functionality. <br> **How:** Update `eval_reconstruction` docstring to document `phase_align_method` parameter and new SSIM return values. Add docstrings for any new helper functions.