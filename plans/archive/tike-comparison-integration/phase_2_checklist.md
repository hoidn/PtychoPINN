# Phase 2: Integration into the Comparison Workflow Checklist

**Initiative:** Tike Comparison Integration
**Created:** 2025-07-25
**Phase Goal:** To modify the existing `scripts/compare_models.py` script to optionally accept the Tike reconstruction artifact from Phase 1 and seamlessly include it in the evaluation and visualization.
**Deliverable:** An updated `scripts/compare_models.py` script capable of generating a 2x4 comparison plot and a CSV file with metrics for all three models (PtychoPINN, Baseline, Tike).

## âœ… Task List

### Instructions:
1. Work through tasks in order. Dependencies are noted in the guidance column.
2. The **"How/Why & API Guidance"** column contains all necessary details for implementation.
3. Update the `State` column as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| :-- | :------------------------------------------------- | :---- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[ ]` | **Why:** To load the necessary context and technical specifications before coding. <br> **Docs:** Implementation plan Phase 2 requirements, existing `scripts/compare_models.py` structure. <br> **APIs:** `numpy.load()` for NPZ file loading, matplotlib subplot creation, pandas DataFrame operations for CSV export.
| 0.B | **Identify Target Files for Modification**         | `[ ]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `scripts/compare_models.py` (main modification target) - add Tike integration logic, modify plotting function, update CSV export logic.
| **Section 1: Command-Line Interface Enhancement**
| 1.A | **Add --tike_recon_path argument to parser**       | `[ ]` | **Why:** To allow users to optionally specify the path to a Tike reconstruction NPZ file for three-way comparison. <br> **How:** In `parse_args()` function around line 78, add: `parser.add_argument("--tike_recon_path", type=Path, default=None, help="Path to Tike reconstruction NPZ file for three-way comparison (optional).")` <br> **File:** `scripts/compare_models.py`
| 1.B | **Update argument validation logic**                | `[ ]` | **Why:** To ensure the Tike NPZ path exists if provided. <br> **How:** In `main()` function after args parsing, add validation: `if args.tike_recon_path and not args.tike_recon_path.exists(): raise FileNotFoundError(f"Tike reconstruction file not found: {args.tike_recon_path}")` <br> **File:** `scripts/compare_models.py`
| **Section 2: Tike Data Loading**
| 2.A | **Implement load_tike_reconstruction function**    | `[ ]` | **Why:** To load the Tike reconstruction from the standardized NPZ format created in Phase 1. <br> **How:** Create new function that loads the NPZ file and extracts the `reconstructed_object` key. Function signature: `def load_tike_reconstruction(tike_path: Path) -> np.ndarray:` Use `np.load(tike_path)['reconstructed_object']`. Add logging for loaded object shape/dtype. <br> **File:** `scripts/compare_models.py`
| 2.B | **Add Tike loading to main workflow**              | `[ ]` | **Why:** To conditionally load Tike reconstruction when the path is provided. <br> **How:** In `main()` after model loading section (~line 570), add: `tike_recon = load_tike_reconstruction(args.tike_recon_path) if args.tike_recon_path else None` with appropriate logging. <br> **File:** `scripts/compare_models.py`
| **Section 3: Registration Integration**
| 3.A | **Apply registration to Tike reconstruction**      | `[ ]` | **Why:** Critical requirement from implementation plan - ensure fair pixel-aligned comparison by applying the same registration function used for ML models. <br> **How:** After Tike loading, apply registration if Tike data exists and registration is not skipped: `if tike_recon is not None and not args.skip_registration: tike_recon_aligned, tike_offset = register_and_align(tike_recon, cropped_gt)` <br> **File:** `scripts/compare_models.py`
| 3.B | **Handle registration edge cases**                  | `[ ]` | **Why:** To ensure robust behavior when registration is skipped or ground truth is unavailable. <br> **How:** Add fallback logic: if registration is skipped or no ground truth, set `tike_recon_aligned = tike_recon` and `tike_offset = None`. Include appropriate logging for these cases. <br> **File:** `scripts/compare_models.py`
| **Section 4: Plotting Function Enhancement**
| 4.A | **Modify create_comparison_plot function signature** | `[ ]` | **Why:** To accept the optional Tike reconstruction and related parameters. <br> **How:** Update function signature around line 126 to include: `tike_obj=None, tike_phase_vmin=None, tike_phase_vmax=None, tike_offset=None` parameters. <br> **File:** `scripts/compare_models.py`
| 4.B | **Update subplot grid from 2x3 to 2x4**           | `[ ]` | **Why:** To accommodate the third reconstruction method (Tike) in the comparison plot. <br> **How:** Change line 147 from `plt.subplots(2, 3, figsize=(15, 10), sharex=True, sharey=True)` to `plt.subplots(2, 4, figsize=(20, 10), sharex=True, sharey=True)` when Tike data is present. Keep 2x3 for backward compatibility when no Tike data. <br> **File:** `scripts/compare_models.py`
| 4.C | **Add Tike column headers and labels**             | `[ ]` | **Why:** To properly label the new Tike column in the comparison plot. <br> **How:** Around line 160, add Tike title with offset information if available: `tike_title = "Tike"` with offset annotation similar to existing models. Update column indexing for ground truth (now column 3). <br> **File:** `scripts/compare_models.py`
| 4.D | **Implement Tike color scaling logic**             | `[ ]` | **Why:** To ensure consistent color scaling approach across all three reconstruction methods. <br> **How:** Add Tike amplitude and phase percentile calculations similar to existing models (around line 170). Handle manual phase limits via new arguments or auto-calculate from percentiles. <br> **File:** `scripts/compare_models.py`
| 4.E | **Add Tike subplot rendering**                     | `[ ]` | **Why:** To display the Tike reconstruction in the comparison plot. <br> **How:** After baseline plotting (around line 202), add Tike phase and amplitude plots in column 2: `axes[0, 2].imshow(np.angle(tike_obj), vmin=tike_v_phase_min, vmax=tike_v_phase_max)` and `axes[1, 2].imshow(np.abs(tike_obj), cmap='gray', vmin=tike_v_amp_min, vmax=tike_v_amp_max)`. Update ground truth column to index 3. <br> **File:** `scripts/compare_models.py`
| 4.F | **Update plot title and layout**                  | `[ ]` | **Why:** To reflect the three-way comparison in the plot title and ensure proper layout. <br> **How:** Update line 148 title to conditionally show "PtychoPINN vs. Baseline vs. Tike Reconstruction" when Tike is present, otherwise keep original title. Adjust `tight_layout()` call if needed. <br> **File:** `scripts/compare_models.py`
| **Section 5: Metrics Calculation Enhancement**
| 5.A | **Add Tike metrics calculation**                   | `[ ]` | **Why:** To include Tike reconstruction in quantitative evaluation metrics. <br> **How:** After baseline metrics calculation (around line 750), add Tike evaluation if available: `if tike_recon_aligned is not None: tike_results = eval_reconstruction(...)` with same parameters as other models. Store results in variables. <br> **File:** `scripts/compare_models.py`
| 5.B | **Update metrics results aggregation**             | `[ ]` | **Why:** To collect metrics from all three models for unified reporting. <br> **How:** Modify the results collection logic to include Tike metrics when available. Create a list or dictionary structure that can accommodate 2 or 3 models dynamically. <br> **File:** `scripts/compare_models.py`
| **Section 6: CSV Export Enhancement**
| 6.A | **Modify CSV DataFrame creation**                  | `[ ]` | **Why:** To include Tike model results in the exported CSV file for downstream analysis. <br> **How:** Around line 780, update DataFrame creation to include Tike row when available. Add model_type='tike', include all standard metrics columns, and add timing information from Tike metadata if available. <br> **File:** `scripts/compare_models.py`
| 6.B | **Add computation time tracking**                  | `[ ]` | **Why:** Implementation plan requires reporting computation times for all models. <br> **How:** Extract timing information from Tike NPZ metadata (key: 'computation_time_seconds') and include in CSV. For ML models, track inference time during model prediction calls. Add 'computation_time_s' column to CSV output. <br> **File:** `scripts/compare_models.py`
| **Section 7: Main Function Integration**
| 7.A | **Update plotting function call**                  | `[ ]` | **Why:** To pass Tike data and parameters to the enhanced plotting function. <br> **How:** Around line 792, update `create_comparison_plot()` call to include new Tike parameters: `tike_obj=tike_recon_aligned, tike_offset=tike_offset` (when Tike data is available). <br> **File:** `scripts/compare_models.py`
| 7.B | **Add conditional three-way mode logging**         | `[ ]` | **Why:** To provide clear feedback about whether two-way or three-way comparison is being performed. <br> **How:** Add logging statements to indicate mode: "Running two-way comparison (PtychoPINN vs. Baseline)" or "Running three-way comparison (PtychoPINN vs. Baseline vs. Tike)" based on presence of Tike data. <br> **File:** `scripts/compare_models.py`
| **Section 8: Backward Compatibility Verification**
| 8.A | **Ensure no-Tike mode works unchanged**           | `[ ]` | **Why:** Implementation plan requires full backward compatibility when --tike_recon_path is not used. <br> **How:** Test that all existing functionality works identically when the new argument is omitted. Verify 2x3 plot generation, two-model CSV export, and all existing features remain functional. Add conditional logic throughout to handle None values gracefully. <br> **File:** `scripts/compare_models.py`
| 8.B | **Validate function signatures**                   | `[ ]` | **Why:** To ensure all modified functions handle optional parameters correctly. <br> **How:** Review all function calls and ensure new optional parameters have proper default values. Check that existing code paths don't break when new parameters are None. <br> **File:** `scripts/compare_models.py`
| **Section 9: Error Handling & Validation**
| 9.A | **Add Tike NPZ file format validation**           | `[ ]` | **Why:** To provide clear error messages if the Tike reconstruction file doesn't conform to expected format. <br> **How:** In `load_tike_reconstruction()`, check for required keys ('reconstructed_object'), validate data types and shapes. Provide informative error messages for common issues. <br> **File:** `scripts/compare_models.py`
| 9.B | **Handle registration failures gracefully**        | `[ ]` | **Why:** To ensure robust behavior if registration fails for the Tike reconstruction. <br> **How:** Wrap Tike registration calls in try-catch blocks. On failure, log warning and proceed with unregistered Tike data. Set offset to None and continue with comparison. <br> **File:** `scripts/compare_models.py`
| **Section 10: Code Quality & Documentation**
| 10.A | **Update function docstrings**                     | `[ ]` | **Why:** To document new parameters and three-way comparison functionality. <br> **How:** Update `create_comparison_plot()` docstring to describe new Tike parameters. Update `main()` function docstring if present. Ensure all new functions have proper docstrings. <br> **File:** `scripts/compare_models.py`
| 10.B | **Code formatting and cleanup**                    | `[ ]` | **Why:** To maintain code quality and project standards. <br> **How:** Review code for consistent indentation, remove any debug prints, ensure proper error handling. Follow existing code style patterns in the file. <br> **File:** `scripts/compare_models.py`

---

## ðŸŽ¯ Success Criteria

**This phase is complete when:**
1. All tasks in the table above are marked `[D]` (Done).
2. **Primary Success Test:** The command `scripts/compare_models.py --pinn_dir <pinn_model> --baseline_dir <baseline_model> --test_data <test.npz> --output_dir <output> --tike_recon_path <tike_recon.npz>` produces a 2x4 comparison plot and a three-model CSV file.
3. **Backward Compatibility Test:** The same command WITHOUT the `--tike_recon_path` argument produces the original 2x3 plot and two-model CSV, demonstrating no regressions.
4. All existing functionality remains unchanged when the new optional argument is not used.
5. The Tike reconstruction undergoes the same registration process as the ML models for fair comparison.
6. Computation times are included in the CSV output for all models.

---

## ðŸ“‹ Implementation Notes

### Key Technical Requirements:
- **Registration Critical:** Apply `ptycho.image.registration.register_and_align()` to Tike reconstruction
- **Data Contract:** Load `reconstructed_object` key from Tike NPZ file
- **Plot Layout:** Dynamic 2x3 vs 2x4 subplot grid based on Tike presence
- **CSV Structure:** Include 'model_type', 'computation_time_s' columns
- **Backward Compatibility:** All existing behavior preserved when --tike_recon_path omitted

### Dependencies:
- Phase 1 must be complete with a valid `tike_reconstruction.npz` file
- Existing `ptycho.image.registration` module must be functional
- Current `eval_reconstruction` function must work with Tike data format