### **Agent Implementation Checklist: Core Registration Module Development**

**Overall Goal for this Phase:** To create a standalone, well-tested image registration module with cross-correlation-based alignment functions.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| :-- | :------------------------------------------------- | :---- | :--------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[D]` | **Why:** To load the necessary context and technical specifications before coding. <br> **Docs:** `docs/refactor/plan_registration.md`, relevant sections in `CLAUDE.md` about image processing. <br> **APIs:** `scipy.signal.phase_cross_correlation`, `skimage.registration.phase_cross_correlation`, `numpy.roll`, `numpy.ndimage.shift`.
| 0.B | **Identify Target Files for Modification/Creation**| `[D]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `ptycho/image/registration.py` (Create), `ptycho/image/test_registration.py` (Create).
| **Section 1: Core Registration Logic Implementation**
| 1.A | **Create registration module structure**           | `[D]` | **Why:** Establish the module foundation with proper imports and docstring. <br> **How:** Create `ptycho/image/registration.py` with imports for `numpy`, `scipy.signal`, `skimage.registration` (if available), and module-level docstring explaining purpose. <br> **File:** `ptycho/image/registration.py`.
| 1.B | **Implement find_translation_offset function**     | `[D]` | **Why:** Core function to detect pixel shifts between images using phase correlation. <br> **How:** Function signature: `find_translation_offset(image: np.ndarray, reference: np.ndarray) -> Tuple[int, int]`. Use `skimage.registration.phase_cross_correlation` or fallback to `scipy.signal` implementation. Handle complex images by using `np.abs()`. Return `(dy, dx)` offset. <br> **File:** `ptycho/image/registration.py`.
| 1.C | **Implement apply_shift_and_crop function**        | `[D]` | **Why:** Apply detected offset and crop images to overlapping region. <br> **How:** Function signature: `apply_shift_and_crop(image: np.ndarray, reference: np.ndarray, offset: Tuple[int, int]) -> Tuple[np.ndarray, np.ndarray]`. Use `numpy.roll` or `scipy.ndimage.shift` to apply offset. Calculate overlapping region and crop both images to same final shape. <br> **File:** `ptycho/image/registration.py`.
| 1.D | **Add comprehensive docstrings and type hints**    | `[D]` | **Why:** Ensure code is well-documented and type-safe. <br> **How:** Add numpy-style docstrings with Parameters, Returns, and Examples sections. Use proper type hints for all function parameters and returns. Include usage examples in docstrings. <br> **File:** `ptycho/image/registration.py`.
| 1.E | **Add input validation and error handling**        | `[D]` | **Why:** Make functions robust against invalid inputs. <br> **How:** Check that inputs are 2D arrays, have compatible shapes, handle edge cases like zero offset, add meaningful error messages for invalid inputs. <br> **File:** `ptycho/image/registration.py`.
| **Section 2: Unit Testing**
| 2.A | **Create test module structure**                   | `[D]` | **Why:** Establish testing framework for registration functions. <br> **How:** Create `ptycho/image/test_registration.py` with unittest framework, imports for registration module and numpy testing utilities. <br> **File:** `ptycho/image/test_registration.py`.
| 2.B | **Test known shift detection**                     | `[D]` | **Why:** Verify function correctly detects known pixel shifts. <br> **How:** Create test case with reference image and shifted version (e.g., 5 pixels right, 3 pixels down). Assert `find_translation_offset` returns correct `(3, 5)`. Test multiple shift values and directions. <br> **File:** `ptycho/image/test_registration.py`.
| 2.C | **Test shift application and cropping**            | `[D]` | **Why:** Verify shift is correctly applied and images properly cropped. <br> **How:** Test `apply_shift_and_crop` with known offset. Verify output images have identical shapes and shifted content appears in correct location. Check that cropping removes invalid regions. <br> **File:** `ptycho/image/test_registration.py`.
| 2.D | **Test pre-aligned images (zero offset)**          | `[D]` | **Why:** Ensure function works correctly when no registration is needed. <br> **How:** Test with identical reference and target images. Assert offset detection returns `(0, 0)` and images are not unnecessarily cropped. <br> **File:** `ptycho/image/test_registration.py`.
| 2.E | **Test complex-valued images**                     | `[D]` | **Why:** Verify functions work with complex ptychography data. <br> **How:** Create complex-valued test images (amplitude + phase). Verify registration works on magnitude while preserving complex values in output. <br> **File:** `ptycho/image/test_registration.py`.
| 2.F | **Test edge cases and error conditions**           | `[D]` | **Why:** Ensure robust error handling. <br> **How:** Test with mismatched image shapes, very large offsets, single-pixel images, etc. Verify appropriate errors are raised with clear messages. <br> **File:** `ptycho/image/test_registration.py`.
| **Section 3: Integration and Validation**
| 3.A | **Run all unit tests**                            | `[D]` | **Why:** Verify all registration functionality works correctly. <br> **How:** Execute `python -m unittest ptycho.image.test_registration` and ensure all tests pass. Fix any failing tests before proceeding. <br> **File:** Command line execution.
| 3.B | **Test with realistic ptychography data**          | `[D]` | **Why:** Validate functions work with actual reconstruction data. <br> **How:** Load sample reconstruction from existing datasets, create artificial offset, verify registration recovers correct alignment. Use complex-valued arrays similar to actual model outputs. <br> **File:** `ptycho/image/test_registration.py` or separate validation script.
| 3.C | **Verify performance with large images**           | `[D]` | **Why:** Ensure registration is efficient enough for real reconstructions. <br> **How:** Test with 256x256 and larger images. Verify registration completes in reasonable time (< 1 second per image pair). <br> **File:** Performance test or timing verification.
| **Section 4: Finalization**
| 4.A | **Code formatting & linting**                      | `[D]` | **Why:** Maintain code quality standards. <br> **How:** Run project's standard formatters (e.g., Black) and linters (e.g., Ruff) on `ptycho/image/registration.py` and `ptycho/image/test_registration.py`. Fix any style or linting issues.
| 4.B | **Add module to package imports**                  | `[D]` | **Why:** Make registration functions accessible from ptycho package. <br> **How:** Add appropriate imports to `ptycho/image/__init__.py` if needed. Verify functions can be imported as `from ptycho.image.registration import find_translation_offset`. <br> **File:** `ptycho/image/__init__.py`.