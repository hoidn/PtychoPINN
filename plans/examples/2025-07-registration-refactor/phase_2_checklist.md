### **Agent Implementation Checklist: Integration with Evaluation Pipeline**

**Overall Goal for this Phase:** To integrate the registration module into the existing comparison workflow, ensuring all reconstructions are properly aligned before metric calculation.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| :-- | :------------------------------------------------- | :---- | :--------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review compare_models.py structure**             | `[D]` | **Why:** To understand the current evaluation workflow and identify integration points. <br> **How:** Read `scripts/compare_models.py` to understand current flow: model loading, reconstruction, reassembly, evaluation. Identify where registration should be inserted. <br> **File:** `scripts/compare_models.py`.
| 0.B | **Review evaluation.py interface**                 | `[D]` | **Why:** To understand how aligned images should be passed to the evaluation function. <br> **How:** Examine `ptycho.evaluation.eval_reconstruction` function signature and requirements. Ensure registration output is compatible. <br> **File:** `ptycho/evaluation.py`.
| **Section 1: Core Integration Implementation**
| 1.A | **Import registration functions**                  | `[D]` | **Why:** Make registration functions available in compare_models.py. <br> **How:** Add `from ptycho.image.registration import find_translation_offset, apply_shift_and_crop, register_and_align` to imports section. <br> **File:** `scripts/compare_models.py`.
| 1.B | **Identify reassembly output location**            | `[D]` | **Why:** Find where reconstructed objects are available after reassembly but before evaluation. <br> **How:** Locate variables containing reassembled PtychoPINN reconstruction, Baseline reconstruction, and ground truth object. These should be 2D complex arrays ready for registration. <br> **File:** `scripts/compare_models.py`.
| 1.C | **Implement registration workflow**                | `[D]` | **Why:** Add the core registration logic to align all reconstructions. <br> **How:** After reassembly, add code to: 1) Register PtychoPINN reconstruction against ground truth, 2) Register Baseline reconstruction against ground truth, 3) Apply both alignments and crop to common region. Store aligned versions. <br> **File:** `scripts/compare_models.py`.
| 1.D | **Update evaluation function calls**               | `[D]` | **Why:** Ensure evaluation uses aligned images instead of original reconstructions. <br> **How:** Replace calls to `eval_reconstruction` to use aligned versions of all three images (aligned_pinn, aligned_baseline, aligned_ground_truth). <br> **File:** `scripts/compare_models.py`.
| **Section 2: Logging and Debugging Support**
| 2.A | **Add registration logging**                       | `[D]` | **Why:** Provide visibility into detected offsets and registration results. <br> **How:** Add logging statements to report detected offsets (dy, dx) for both models, final aligned image shapes, and any registration warnings. Use appropriate log levels (INFO for results, DEBUG for details). <br> **File:** `scripts/compare_models.py`.
| 2.B | **Add registration failure handling**              | `[D]` | **Why:** Handle cases where registration might fail or produce unreasonable results. <br> **How:** Add try-except blocks around registration calls. If registration fails or detects extremely large offsets, log warning and continue with original (unaligned) images. <br> **File:** `scripts/compare_models.py`.
| 2.C | **Add optional registration bypass**               | `[D]` | **Why:** Allow users to disable registration for debugging or comparison purposes. <br> **How:** Add command-line argument `--skip-registration` that bypasses the registration step. Document this option in help text. <br> **File:** `scripts/compare_models.py`.
| **Section 3: Visual Output Enhancement**
| 3.A | **Update comparison plot to show alignment**       | `[D]` | **Why:** Visual verification that registration worked correctly. <br> **How:** Modify the visualization code that creates `comparison_plot.png` to use aligned images. Add text annotation showing detected offsets for each model. <br> **File:** `scripts/compare_models.py`.
| 3.B | **Add offset information to output**               | `[D]` | **Why:** Record registration results for later analysis. <br> **How:** Add detected offset information to the output CSV or create a separate registration log file. Include offset values (dy, dx) for both PtychoPINN and Baseline models. <br> **File:** `scripts/compare_models.py`.
| **Section 4: Integration Testing**
| 4.A | **Test with known problematic dataset**           | `[D]` | **Why:** Verify registration resolves the identical FRC issue. <br> **How:** Run modified `compare_models.py` on a dataset known to produce identical FRC values (e.g., from previous generalization study results). Verify FRC values are now different and reasonable. <br> **File:** Command line execution.
| 4.B | **Test alignment visual verification**             | `[D]` | **Why:** Confirm visual alignment is working correctly. <br> **How:** Examine the generated `comparison_plot.png` to verify all three images (PtychoPINN, Baseline, Ground Truth) appear properly aligned. Look for consistent feature positions across all panels. <br> **File:** Visual inspection of output.
| 4.C | **Test with pre-aligned data**                    | `[D]` | **Why:** Ensure registration doesn't degrade already-aligned reconstructions. <br> **How:** Run on a dataset where reconstructions should already be well-aligned. Verify that detected offsets are small (Â±2 pixels) and metrics remain reasonable. <br> **File:** Command line execution.
| **Section 5: Documentation and Finalization**
| 5.A | **Update function docstrings**                     | `[D]` | **Why:** Document the new registration workflow for future users. <br> **How:** Add or update docstring for the main comparison function to explain that registration is now performed automatically. Describe the alignment process and output format. <br> **File:** `scripts/compare_models.py`.
| 5.B | **Add inline code comments**                      | `[D]` | **Why:** Explain the registration logic for code maintainability. <br> **How:** Add clear comments explaining: 1) Why registration is needed, 2) The workflow (register both vs GT, align all three), 3) How to interpret logged offset values. <br> **File:** `scripts/compare_models.py`.
| 5.C | **Verify command-line help is updated**           | `[D]` | **Why:** Ensure users understand the new registration feature. <br> **How:** Run `python scripts/compare_models.py --help` and verify that help text mentions automatic registration and the `--skip-registration` option if implemented. <br> **File:** Command line execution.