### **Agent Implementation Checklist: Validation and Documentation**

**Overall Goal for this Phase:** To thoroughly validate the registration system works correctly and document the new capability for future users.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| :-- | :------------------------------------------------- | :---- | :--------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review registration implementation**             | `[D]` | **Why:** To understand the completed registration system before validation. <br> **How:** Read `ptycho/image/registration.py` and registration integration in `scripts/compare_models.py`. Review the workflow and key functions. <br> **File:** `ptycho/image/registration.py`, `scripts/compare_models.py`.
| 0.B | **Identify validation datasets**                   | `[D]` | **Why:** To select appropriate test cases for comprehensive validation. <br> **How:** Identify datasets with known alignment issues (from previous studies) and well-aligned datasets for regression testing. Document dataset paths and expected behaviors. <br> **File:** Various dataset directories.
| **Section 1: Comprehensive Validation Testing**
| 1.A | **Test on multiple problematic datasets**         | `[D]` | **Why:** Verify registration works across different alignment scenarios. <br> **How:** Run `compare_models.py` on 3-5 datasets known to have alignment issues. Verify FRC differentiation is achieved in each case. Document offsets and metric improvements. <br> **File:** Command line execution with various test datasets.
| 1.B | **Test regression on aligned datasets**           | `[D]` | **Why:** Ensure registration doesn't degrade well-aligned reconstructions. <br> **How:** Run on datasets where models should already be aligned. Verify small offsets (±2 pixels) and stable metrics. Compare with `--skip-registration` results. <br> **File:** Command line execution with aligned test datasets.
| 1.C | **Validate extreme offset handling**              | `[D]` | **Why:** Test robustness with very large misalignments. <br> **How:** Create or find test cases with large known offsets (>20 pixels). Verify registration correctly detects and corrects these cases. Check for any failure modes. <br> **File:** Command line execution with extreme test cases.
| 1.D | **Test edge cases and failure modes**             | `[D]` | **Why:** Ensure robust error handling for challenging inputs. <br> **How:** Test with: identical images (0 offset), very noisy reconstructions, partially overlapping reconstructions. Verify graceful handling of edge cases. <br> **File:** Command line execution with edge case datasets.
| 1.E | **Verify Registration Sign on Asymmetric Data**   | `[D]` | **Why:** To confirm the `(dy, dx)` offset is being applied in the correct physical direction, not just maximizing correlation. <br> **How:** 1. Create a synthetic test case: a simple reference image (e.g., a circle) and a target image where the circle is shifted by a known `(+10, +5)`. 2. Run this through the `register_and_align` workflow. 3. **Visually inspect the output plot.** Confirm that the shifted image was moved *left* and *up* to match the reference, not the other way around. 4. Log the detected offset and assert it matches the known `(+10, +5)` shift. <br> **File:** Add a new test function to `ptycho/image/test_registration.py`.
| **Section 2: Before/After Comparison Analysis**
| 2.A | **Create systematic before/after comparison**     | `[D]` | **Why:** Demonstrate the quantitative impact of registration on evaluation metrics. <br> **How:** Run the same comparison both with and without registration on 3 representative datasets. Create a summary table showing FRC improvements and offset corrections. <br> **File:** Create validation summary document.
| 2.B | **Document specific identical FRC resolution**    | `[D]` | **Why:** Provide concrete evidence that the core problem has been solved. <br> **How:** Show specific examples where FRC values were identical before registration and are now differentiated. Include the exact datasets, offset values, and metric changes. <br> **File:** Add to validation summary document.
| 2.C | **Analyze registration accuracy**                 | `[D]` | **Why:** Validate that detected offsets are realistic and consistent. <br> **How:** For datasets with known ground truth alignments, compare detected offsets with expected values. Document registration accuracy and precision. <br> **File:** Add to validation summary document.
| **Section 3: Performance and Robustness Validation**
| 3.A | **Test computational performance impact**         | `[D]` | **Why:** Ensure registration doesn't significantly slow down comparisons. <br> **How:** Time comparison runs with and without registration. Document the performance overhead. Verify it's acceptable for typical workflows. <br> **File:** Performance timing analysis.
| 3.B | **Validate sub-pixel precision**                  | `[D]` | **Why:** Confirm the registration achieves the intended sub-pixel accuracy. <br> **How:** Create synthetic test cases with known sub-pixel shifts. Verify registration detects offsets with appropriate precision (±0.1 pixels). <br> **File:** Create synthetic validation tests.
| 3.C | **Test with different image types and sizes**     | `[D]` | **Why:** Ensure registration works across various reconstruction scenarios. <br> **How:** Test with different N values (64, 128), complex vs real images, different object sizes. Verify consistent performance. <br> **File:** Command line execution with diverse datasets.
| **Section 4: Documentation and User Guidance**
| 4.A | **Update CLAUDE.md with registration workflow**   | `[D]` | **Why:** Document the new registration capability for future AI interactions. <br> **How:** Add section explaining: registration purpose, when it's applied automatically, how to disable it, and what the offset outputs mean. Include example output interpretation. <br> **File:** `CLAUDE.md`.
| 4.B | **Document registration module API**              | `[D]` | **Why:** Provide comprehensive API documentation for developers. <br> **How:** Verify all functions in `ptycho/image/registration.py` have complete docstrings with examples. Document the recommended usage patterns and parameter choices. <br> **File:** `ptycho/image/registration.py`.
| 4.C | **Create registration troubleshooting guide**     | `[D]` | **Why:** Help users understand and resolve registration issues. <br> **How:** Document common scenarios: when registration fails, how to interpret large offsets, when to use `--skip-registration`, and how to validate registration results. <br> **File:** Add to `CLAUDE.md` or separate troubleshooting section.
| 4.D | **Document integration with compare_models.py**   | `[D]` | **Why:** Explain the modified comparison workflow for users. <br> **How:** Update docstring/help text for `compare_models.py` to explain automatic registration, logged outputs, and the `--skip-registration` option. <br> **File:** `scripts/compare_models.py`.
| **Section 5: Finalization and Verification**
| 5.A | **Create comprehensive validation report**        | `[D]` | **Why:** Provide complete documentation of registration system effectiveness. <br> **How:** Compile all validation results into a summary report showing: problem solved, validation test results, performance impact, usage guidelines. <br> **File:** `docs/refactor/validation_report_registration.md`.
| 5.B | **Verify all documentation is consistent**        | `[D]` | **Why:** Ensure coherent documentation across all files. <br> **How:** Cross-check that function signatures, examples, and usage patterns are consistent between `CLAUDE.md`, registration module docstrings, and compare_models.py documentation. <br> **File:** Multiple documentation files.
| 5.C | **Test complete workflow end-to-end**             | `[D]` | **Why:** Final verification that everything works together seamlessly. <br> **How:** Run a complete comparison workflow from scratch: fresh models, new dataset, full registration and evaluation. Verify all outputs are generated correctly and documentation matches behavior. <br> **File:** Complete end-to-end test execution.