### **Agent Implementation Checklist: Phase 2 - Integration and Script Updates**

**Overall Goal for this Phase:** To update the `scripts/compare_models.py` script to handle and report all new metrics while maintaining existing functionality.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[D]` | **Why:** To understand the current CSV output format and integration points. <br> **Docs:** `docs/refactor/eval_enhancements/plan_eval_enhancements.md`, `scripts/compare_models.py` existing CSV logic. <br> **APIs:** `ptycho.evaluation.eval_reconstruction`, `pandas.DataFrame.to_csv`.
| 0.B | **Identify Target Files for Modification**| `[D]` | **Why:** To have a clear list of files that will be touched during this phase. <br> **Files:** `scripts/compare_models.py` (Modify - CSV writing and metric handling), potentially `ptycho/evaluation.py` (check save_metrics function).
| **Section 1: CSV Writing Logic Updates**
| 1.A | **Analyze current CSV output format in compare_models.py**                   | `[D]` | **Why:** To understand how metrics are currently written to CSV. <br> **How:** Read the `compare_models.py` script and identify where metrics are written to CSV. Look for calls to `to_csv()` or similar. <br> **File:** `scripts/compare_models.py`.
| 1.B | **Update CSV writing to handle SSIM metric**                   | `[D]` | **Why:** New SSIM metric needs to be properly written to CSV output. <br> **How:** Add `'ssim'` to the list of metrics that get written to CSV. Ensure both amplitude and phase SSIM values are saved with appropriate column names. <br> **File:** `scripts/compare_models.py`.
| 1.C | **Handle raw FRC curve data storage**                   | `[D]` | **Why:** Raw FRC curves are now returned and may need special handling for CSV. <br> **How:** Determine if raw FRC curves should be saved separately or excluded from CSV (they're arrays, not scalar values). Document the decision. <br> **File:** `scripts/compare_models.py`.
| **Section 2: Logging and Debug Output**
| 2.A | **Add logging for new metrics during comparison runs**                        | `[D]` | **Why:** To provide visibility into the new metrics during model comparison. <br> **How:** Add log statements that report SSIM values and phase alignment method used during evaluation. Use existing logging patterns in the script. <br> **File:** `scripts/compare_models.py`.
| 2.B | **Update metric reporting in console output**                        | `[D]` | **Why:** Users should see the new metrics in console output for immediate feedback. <br> **How:** Update any print statements or console reporting to include SSIM values alongside existing metrics like PSNR, MAE. <br> **File:** `scripts/compare_models.py`.
| **Section 3: Integration Testing**
| 3.A | **Test eval_reconstruction parameter passing**                        | `[D]` | **Why:** Ensure the new parameters are correctly passed from compare_models.py to eval_reconstruction. <br> **How:** Check that `phase_align_method` and `frc_sigma` parameters can be passed through the comparison workflow. Add debug logging to verify parameters are received. <br> **File:** `scripts/compare_models.py`.
| 3.B | **Verify backwards compatibility with existing calls**                        | `[D]` | **Why:** Ensure existing comparison scripts still work without modification. <br> **How:** Test that `compare_models.py` works with default parameters (should use `phase_align_method='plane'`, `frc_sigma=0`). Verify no required parameters were added. <br> **File:** `scripts/compare_models.py`.
| **Section 4: Error Handling and Validation**
| 4.A | **Add error handling for new metric failures**                   | `[D]` | **Why:** SSIM calculation or phase alignment might fail on edge cases. <br> **How:** Add try-catch blocks around metric calculation. Log errors gracefully and allow comparison to continue with NaN values for failed metrics. <br> **File:** `scripts/compare_models.py`.
| 4.B | **Validate CSV output format compatibility**                   | `[D]` | **Why:** Ensure new CSV format doesn't break downstream analysis scripts. <br> **How:** Check that existing scripts that read comparison CSV files can handle the new `ssim` columns. Document any breaking changes. <br> **File:** Test with existing CSV parsing code.
| **Section 5: Documentation and Configuration**
| 5.A | **Add command-line options for new parameters**                   | `[D]` | **Why:** Users should be able to control phase alignment method and FRC smoothing. <br> **How:** Add `--phase-align-method` and `--frc-sigma` command-line arguments to `compare_models.py`. Include help text explaining the options. <br> **File:** `scripts/compare_models.py`.
| 5.B | **Update script help text and documentation**                   | `[D]` | **Why:** Users need to understand the new functionality. <br> **How:** Update the script's help text to document new command-line options and their effects. Add examples of usage. <br> **File:** `scripts/compare_models.py`.
| **Section 6: Finalization**
| 6.A | **Code Formatting & Linting**                      | `[D]` | **Why:** To maintain code quality and project standards. <br> **How:** Review code for consistent indentation, remove any debug prints, ensure proper variable naming.
| 6.B | **End-to-end integration test**                           | `[D]` | **Why:** Verify the complete workflow works correctly. <br> **How:** Run `compare_models.py` with test data and verify: (1) script completes without errors, (2) CSV contains all expected metrics including `ssim`, (3) console output shows new metrics.