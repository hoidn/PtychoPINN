# R&D Plan: Probe Parameterization Study

*Created: 2025-08-01*

## üéØ **OBJECTIVE & HYPOTHESIS**

**Project/Initiative Name:** Generalization Test with Decoupled Probe Simulation

**Problem Statement:** The current simulation workflow implicitly ties the probe function to the dataset it was generated from. There is no straightforward, reusable mechanism to simulate diffraction patterns using an arbitrary combination of an object from one source and a probe from another. This limits our ability to conduct controlled studies on how probe variations affect reconstruction, a key aspect of ptychography research.

**Proposed Solution / Hypothesis:**
- **Solution:** We will create a new, modular simulation utility that decouples the object and probe sources. This utility will be exposed as both a Python function and a command-line script, allowing users to specify the source for the object and the probe independently. This will culminate in a comprehensive 2x2 integration study that validates the new tools by testing model performance against both probe variations and overlap constraints (gridsize).
- **Hypothesis:** By decoupling these components, we can create a more powerful and flexible experimental framework. We hypothesize that models trained with a realistic, aberrated probe phase will show different performance characteristics than those trained with an idealized probe, and that the gridsize=2 overlap constraint will make the model more robust to these probe variations.

---

## üìö **LEARNING FROM PREVIOUS ATTEMPT**

The prior "Probe Generalization Study" failed to produce meaningful results. A root cause analysis identified the following issues, which this plan directly addresses:

1. **Monolithic and Fragile Workflow:** The previous attempt tried to retrofit existing, complex scripts. This led to unpredictable side effects, particularly with the sensitive gridsize > 1 data grouping logic, resulting in corrupted or physically incoherent training data.

2. **Lack of Decoupling:** The object and probe were tightly coupled within the data generation process, making it impossible to cleanly swap one component without affecting the entire pipeline (e.g., coordinate generation, patch extraction).

3. **Absence of Component-Level Validation:** Without dedicated, modular tools, it was difficult to test and validate intermediate steps (like the creation of a hybrid probe), leading to a final failure that was hard to debug.

This plan addresses these failures by:
- **Decoupling Object/Probe Sources:** Creating a workflow where the object and probe are treated as independent, pluggable components.
- **Creating Dedicated, Testable Utilities:** Building small, focused scripts for specific tasks (e.g., `create_hybrid_probe.py`) instead of modifying large, complex ones.
- **Ensuring Data Pipeline Integrity:** Explicitly defining how coordinates and ground truth Y patches are generated in a mixed-source context to maintain physical consistency.

---

## üõ†Ô∏è **METHODOLOGY / SOLUTION APPROACH**

This initiative will follow a lighter, more surgical approach by extending existing, proven tools and adding small, focused helper functions. This minimizes new code and reduces the risk of unforeseen side effects.

1. **Extend `simulate_and_save.py`:** The core simulation script will be enhanced with a `--probe-file` option to allow overriding the probe from the main input NPZ.

2. **Create a Hybrid Probe Tool:** A new, standalone utility (`scripts/tools/create_hybrid_probe.py`) will be created for the specific task of mixing probe characteristics.

3. **Add Core Helper Functions:** A few small, well-tested helper functions will be added to a new `ptycho/workflows/simulation_utils.py` module to handle probe loading and validation, avoiding code duplication.

4. **Orchestrate a 2x2 Study:** A master script (`scripts/studies/run_2x2_probe_study.sh`) will automate the final integration test, using the enhanced and new tools to execute the full experiment.

---

## üéØ **DELIVERABLES**

1. **Enhanced Simulation Script:** An updated `scripts/simulation/simulate_and_save.py` with a new `--probe-file` argument.
2. **New Probe Tool:** A new utility script, `scripts/tools/create_hybrid_probe.py`.
3. **New Helper Module:** A new, minimal Python module, `ptycho/workflows/simulation_utils.py`.
4. **New Study Orchestrator:** A new master script, `scripts/studies/run_2x2_probe_study.sh`.
5. **Final Artifact:** A `2x2_study_report.md` file generated by the study script with quantitative metrics (PSNR, SSIM, MS-SSIM).

---

## üîß **TECHNICAL IMPLEMENTATION DETAILS**

### Core Helper Module: `ptycho/workflows/simulation_utils.py`

This module will contain small, reusable functions to prevent code duplication:

```python
def load_probe_from_source(source: Union[str, Path, np.ndarray]) -> np.ndarray:
    """Unified probe loading from an .npz file, .npy file, or a direct NumPy array."""
    # Implementation will handle all three source types with validation.
    # Ensure probe is 2D complex array with dtype complex64
    
def validate_probe_object_compatibility(probe: np.ndarray, obj: np.ndarray) -> None:
    """Ensures the probe is smaller than the object and can physically scan it."""
    # Implementation will check that probe.shape < obj.shape and raise a clear
    # ValueError if the probe is too large for the object canvas.
```

### New Utility Script: `scripts/tools/create_hybrid_probe.py`

Algorithm:
1. Load both source probes using the new `load_probe_from_source` helper
2. Validate that both are 2D complex arrays
3. Ensure matching dimensions: If shapes differ, resize the smaller probe to match the larger one using `skimage.transform.resize` with anti-aliasing (order=3)
4. Extract amplitude from the first probe: `amp = np.abs(probe_amp_source)`
5. Extract phase from the second: `phase = np.angle(probe_phase_source)`
6. Combine: `hybrid_probe = amp * np.exp(1j * phase)`
7. Validate output: Check for finite values and ensure dtype is complex64
8. Optional: Add `--visualize` flag to display the hybrid probe

### Enhancements to `scripts/simulation/simulate_and_save.py`

- Add a new optional argument: `--probe-file <path/to/probe.[npy|npz]>`
- If `--probe-file` is provided, use `load_probe_from_source` to load this external probe
- Call `validate_probe_object_compatibility` before proceeding
- Use centralized logging from `ptycho.log_config`

### Data Pipeline Strategy

- **Coordinate Generation:** Scan coordinates will always be generated based on the dimensions of the final `objectGuess` being used in the simulation
- **Ground Truth Y Patches:** Generated within the simulation pipeline after the final object and probe have been selected
- **gridsize > 1 Compatibility:** The coordinate grouping logic will operate on the newly generated scan coordinates

---

## ‚úÖ **VALIDATION & VERIFICATION PLAN**

### Step 1: Component Testing (Incremental)
- Unit test the new helper functions in `simulation_utils.py`
- Run `create_hybrid_probe.py` and visually inspect the output
- Test the enhanced `simulate_and_save.py` with the `--probe-file` option

### Step 2: End-to-End Integration Test (The 2x2 Study)

**Experimental Design:** A 2x2 study using a single synthetic 'lines' object

|                    | Gridsize = 1          | Gridsize = 2          |
|--------------------|-----------------------|-----------------------|
| **Probe A: Default** | Arm 1: Train & evaluate | Arm 2: Train & evaluate |
| **Probe B: Hybrid**  | Arm 3: Train & evaluate | Arm 4: Train & evaluate |

**Metrics:** PSNR, SSIM, MS-SSIM, FRC50

**Success Criteria:**
- **Viability:** All four models must train successfully and achieve a reconstruction PSNR of > 20 dB
- **Measurable Impact:** Models trained with the Hybrid Probe expected to show < 3 dB PSNR degradation vs Default Probe
- **Robustness Hypothesis:** Performance gap between Default and Hybrid probes should be smaller for gridsize=2

---

## üöÄ **RISK MITIGATION**

1. **Risk:** The hybrid probe is physically implausible and causes simulation or training to fail.
   - **Mitigation:** Include validation steps in `create_hybrid_probe.py`. Prepare fallback test using experimental probe amplitude with ideal phase.

2. **Risk:** Unforeseen interactions with the gridsize > 1 logic.
   - **Mitigation:** Clean separation of data generation from training. Apply grouping logic only to final coordinates.

3. **Risk:** The full 2x2 study is computationally expensive and time-consuming.
   - **Mitigation:** Test components incrementally. Include "quick test" mode (fewer images, fewer epochs). Consider `@memoize_simulated_data` decorator.

---

## üìÅ **File Organization**

**Initiative Path:** `plans/active/probe-parameterization-study/`

**Next Step:** Run `/implementation` to generate the phased implementation plan.