# Phase D1e Shape Mismatch Triage — 2025-10-19T105248Z

## Failure Snapshot
- Selector: `pytest tests/torch/test_integration_workflow_torch.py::TestPyTorchIntegrationWorkflow::test_pytorch_train_save_load_infer_cycle -vv`
- Latest log: `plans/active/INTEGRATE-PYTORCH-001/reports/2025-10-19T110500Z/phase_d2_completion/pytest_integration_dtype_green.log`
- Exception: `RuntimeError: The size of tensor a (572) must match the size of tensor b (1080) at non-singleton dimension 3`
- Failing frame: `ptycho_torch/model.py:366` inside `Decoder_last.forward` (`outputs = x1 + x2`)

## Immediate Observations
- Trigger occurs after dtype enforcement (Phase D1d) — Lightning forward now reaches decoder merge step.
- Branch specific to `probe_big=True` path: `x1` operates on inner channels, `x2` generated by `ConvUpBlock` + `conv2` with upsample/padding.
- Tensor mismatch implies spatial dimension disagreement (572 vs 1080) rather than channel count; likely a consequence of padding + upsample interactions.
- TensorFlow reference (`ptycho/model.py` `Decoder_last`) crops/pads outputs to maintain spatial equality before addition.

## Initial Hypotheses
1. **Upsample scale factor mismatch** — `ConvUpBlock` uses `scale_factor=(p1,p2)` defaulting to `(2,2)`. When combined with padding, spatial dims might overshoot expected size.
2. **Padding asymmetry vs TensorFlow crop** — PyTorch path applies `ConstantPad2d` whereas TensorFlow uses center crop/pad. Lack of crop in PyTorch may increase spatial extent beyond original grid.
3. **Input tensor layout difference** — `x` fed into `Decoder_last` may already be channel-last (after previous fixes), but `conv` layers expect channel-first. Need to confirm we permute correctly before decode stage.

## Evidence To Gather (Phase A Targets)
- Shape trace for `x`, `x1`, `x2`, and `outputs` within `Decoder_last.forward`.
- Compare with TensorFlow decoder shapes for identical checkpoint (if available).
- Determine whether mismatch occurs only when `model_config.probe_big` is True (i.e., when `x2` branch active).

## Next Steps
- Follow Phase D1e checklist (`d1e_shape_plan.md`) to collect shape traces and convert hypotheses into targeted tests.
- Update this triage with confirmed root cause once instrumentation data collected.
