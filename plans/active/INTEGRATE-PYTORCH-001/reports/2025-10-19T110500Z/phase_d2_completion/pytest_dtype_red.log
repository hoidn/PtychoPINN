============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchFloat32::test_batches_remain_float32 PASSED [100%]

============================== 1 passed in 3.62s ===============================
        # CRITICAL: Use float64 to simulate the actual bug
        X_float64 = np.random.randn(n_samples, N, N).astype(np.float64)
        coords_float64 = np.random.randn(n_samples, 2).astype(np.float64)
    
        container = {
            'X': X_float64,  # Will be converted to torch.float64 by torch.from_numpy
            'coords_nominal': coords_float64,
        }
    
        # Build inference dataloader
        infer_loader = _build_inference_dataloader(
            container,
            minimal_training_config
        )
    
        # Iterate loader and assert dtype enforcement
        batch_count = 0
        for batch in infer_loader:
            X_batch, coords_batch = batch
    
            # CRITICAL ASSERTION: Must cast to float32 despite float64 input
>           assert X_batch.dtype == torch.float32, \
                f"X_batch dtype is {X_batch.dtype}, expected torch.float32. " \
                f"Inference dataloader MUST cast float64 arrays to float32 before yielding batches. " \
                f"Current failure: 'Input type (double) and bias type (float)' in Conv2d forward. " \
                f"Fix: Add `infer_X = infer_X.to(torch.float32, copy=False)` before TensorDataset construction. " \
                f"See plans/active/INTEGRATE-PYTORCH-001/reports/2025-10-19T110500Z/phase_d2_completion/dtype_triage.md"
E           AssertionError: X_batch dtype is torch.float64, expected torch.float32. Inference dataloader MUST cast float64 arrays to float32 before yielding batches. Current failure: 'Input type (double) and bias type (float)' in Conv2d forward. Fix: Add `infer_X = infer_X.to(torch.float32, copy=False)` before TensorDataset construction. See plans/active/INTEGRATE-PYTORCH-001/reports/2025-10-19T110500Z/phase_d2_completion/dtype_triage.md
E           assert torch.float64 == torch.float32
E            +  where torch.float64 = tensor([[[ 1.6758e-01, -1.5303e+00, -2.1263e-01,  ...,  6.0153e-01,\n           1.3684e+00, -5.8383e-01],\n         [-1.9078e+00,  1.2125e-01, -1.4283e+00,  ...,  8.8563e-01,\n          -1.9534e-01,  5.3507e-01],\n         [-6.3131e-01,  9.4285e-01, -8.9407e-01,  ...,  2.4466e-01,\n           9.5667e-01,  7.6893e-01],\n         ...,\n         [-1.6678e-01, -8.0864e-01, -5.8355e-01,  ...,  3.8127e-04,\n           1.7545e+00, -1.9300e+00],\n         [-3.1614e-01, -3.1499e-01,  6.4230e-01,  ..., -3.4759e-01,\n          -2.9126e-02,  9.5366e-01],\n         [-8.7428e-01,  3.0198e-01, -7.4814e-01,  ..., -5.2968e-01,\n           1.5672e+00,  2.1851e+00]],\n\n        [[ 2.9826e-01, -8.7962e-01,  1.3760e+00,  ...,  9.6785e-01,\n           1.9244e+00,  2.8860e-01],\n         [-4.0894e-01, -1.3089e+00, -1.2622e+00,  ..., -1.4483e+00,\n           2.5733e-01, -3.9369e-01],\n         [ 3.8075e-01, -6.8141e-01, -1.1058e+00,  ...,  6.6149e-02,\n          -3.6203e-01, -4.3863e-01],\n         ...,\n         [ 8.4702e-02,  5.7399e-01,  9.3621e-01,  ..., -1.6674e-02,\n           2.8828e-01,  4.7182e-01],\n         [-8.7348e-01,  1.2381e-02, -5.3016e-01,  ..., -3.1662e-01,\n           4.3477e-01,  1.2085e+00],\n         [-9.4155e-01,  6.1932e-01, -4.3746e-01,  ...,  6.6102e-01,\n          -8.1566e-01, -3.8222e-01]],\n\n        [[ 4.2762e-01,  1.5836e+00,  2.5986e-01,  ...,  1.8586e+00,\n           1.3318e-01,  1.4480e+00],\n         [ 9.1432e-01,  2.8271e-01,  5.3004e-01,  ...,  8.9930e-01,\n           1.2778e+00, -6.9466e-01],\n         [ 2.5925e-01, -5.3913e-02, -1.0513e-01,  ...,  1.3501e+00,\n           1.1297e+00,  4.5007e-01],\n         ...,\n         [ 7.5021e-01, -5.8434e-02,  3.3382e-01,  ...,  8.2934e-02,\n          -1.3300e+00, -1.5357e-01],\n         [ 5.9123e-01,  3.6616e-01,  4.7460e-01,  ..., -1.4234e+00,\n           1.1455e+00,  1.8870e-01],\n         [ 1.1793e+00, -3.3223e-01,  6.8057e-02,  ...,  5.3519e-01,\n           7.8012e-01,  1.6448e-01]],\n\n        [[-1.5973e+00, -1.6273e-01,  1.3882e+00,  ...,  1.1746e+00,\n           1.6136e+00,  9.8804e-01],\n         [-4.2533e-02, -9.1789e-01, -7.2307e-01,  ..., -1.1441e+00,\n           1.3000e+00,  2.7043e-01],\n         [ 7.4597e-01, -1.1680e-01, -2.6245e+00,  ..., -1.8690e-01,\n          -6.9461e-01, -5.9537e-01],\n         ...,\n         [-5.1783e-01,  7.1892e-01, -2.5130e-01,  ..., -5.5170e-01,\n          -1.3040e+00,  5.9331e-01],\n         [-8.1963e-01, -7.2459e-01,  2.0491e+00,  ...,  2.0454e-01,\n           8.5414e-01,  1.5175e+00],\n         [-1.4783e+00,  2.3910e-01, -1.5591e+00,  ..., -1.6815e-01,\n          -1.0217e+00,  7.1091e-01]]], dtype=torch.float64).dtype
E            +  and   torch.float32 = <module 'torch' from '/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/torch/__init__.py'>.float32

tests/torch/test_workflows_components.py:1736: AssertionError
----------------------------- Captured stderr call -----------------------------
2025-10-19 03:40:23.654370: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E0000 00:00:1760870423.665830  813860 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
E0000 00:00:1760870423.669727  813860 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
W0000 00:00:1760870423.680790  813860 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1760870423.680808  813860 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1760870423.680811  813860 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1760870423.680814  813860 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
2025-10-19 03:40:23.683562: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
=========================== short test summary info ============================
FAILED tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchFloat32::test_dataloader_casts_float64_to_float32 - AssertionError: X_batch dtype is torch.float64, expected torch.float32. Inference dataloader MUST cast float64 arrays to float32 before yielding batches. Current failure: 'Input type (double) and bias type (float)' in Conv2d forward. Fix: Add `infer_X = infer_X.to(torch.float32, copy=False)` before TensorDataset construction. See plans/active/INTEGRATE-PYTORCH-001/reports/2025-10-19T110500Z/phase_d2_completion/dtype_triage.md
assert torch.float64 == torch.float32
 +  where torch.float64 = tensor([[[ 1.6758e-01, -1.5303e+00, -2.1263e-01,  ...,  6.0153e-01,\n           1.3684e+00, -5.8383e-01],\n         [-1.9078e+00,  1.2125e-01, -1.4283e+00,  ...,  8.8563e-01,\n          -1.9534e-01,  5.3507e-01],\n         [-6.3131e-01,  9.4285e-01, -8.9407e-01,  ...,  2.4466e-01,\n           9.5667e-01,  7.6893e-01],\n         ...,\n         [-1.6678e-01, -8.0864e-01, -5.8355e-01,  ...,  3.8127e-04,\n           1.7545e+00, -1.9300e+00],\n         [-3.1614e-01, -3.1499e-01,  6.4230e-01,  ..., -3.4759e-01,\n          -2.9126e-02,  9.5366e-01],\n         [-8.7428e-01,  3.0198e-01, -7.4814e-01,  ..., -5.2968e-01,\n           1.5672e+00,  2.1851e+00]],\n\n        [[ 2.9826e-01, -8.7962e-01,  1.3760e+00,  ...,  9.6785e-01,\n           1.9244e+00,  2.8860e-01],\n         [-4.0894e-01, -1.3089e+00, -1.2622e+00,  ..., -1.4483e+00,\n           2.5733e-01, -3.9369e-01],\n         [ 3.8075e-01, -6.8141e-01, -1.1058e+00,  ...,  6.6149e-02,\n          -3.6203e-01, -4.3863e-01],\n         ...,\n         [ 8.4702e-02,  5.7399e-01,  9.3621e-01,  ..., -1.6674e-02,\n           2.8828e-01,  4.7182e-01],\n         [-8.7348e-01,  1.2381e-02, -5.3016e-01,  ..., -3.1662e-01,\n           4.3477e-01,  1.2085e+00],\n         [-9.4155e-01,  6.1932e-01, -4.3746e-01,  ...,  6.6102e-01,\n          -8.1566e-01, -3.8222e-01]],\n\n        [[ 4.2762e-01,  1.5836e+00,  2.5986e-01,  ...,  1.8586e+00,\n           1.3318e-01,  1.4480e+00],\n         [ 9.1432e-01,  2.8271e-01,  5.3004e-01,  ...,  8.9930e-01,\n           1.2778e+00, -6.9466e-01],\n         [ 2.5925e-01, -5.3913e-02, -1.0513e-01,  ...,  1.3501e+00,\n           1.1297e+00,  4.5007e-01],\n         ...,\n         [ 7.5021e-01, -5.8434e-02,  3.3382e-01,  ...,  8.2934e-02,\n          -1.3300e+00, -1.5357e-01],\n         [ 5.9123e-01,  3.6616e-01,  4.7460e-01,  ..., -1.4234e+00,\n           1.1455e+00,  1.8870e-01],\n         [ 1.1793e+00, -3.3223e-01,  6.8057e-02,  ...,  5.3519e-01,\n           7.8012e-01,  1.6448e-01]],\n\n        [[-1.5973e+00, -1.6273e-01,  1.3882e+00,  ...,  1.1746e+00,\n           1.6136e+00,  9.8804e-01],\n         [-4.2533e-02, -9.1789e-01, -7.2307e-01,  ..., -1.1441e+00,\n           1.3000e+00,  2.7043e-01],\n         [ 7.4597e-01, -1.1680e-01, -2.6245e+00,  ..., -1.8690e-01,\n          -6.9461e-01, -5.9537e-01],\n         ...,\n         [-5.1783e-01,  7.1892e-01, -2.5130e-01,  ..., -5.5170e-01,\n          -1.3040e+00,  5.9331e-01],\n         [-8.1963e-01, -7.2459e-01,  2.0491e+00,  ...,  2.0454e-01,\n           8.5414e-01,  1.5175e+00],\n         [-1.4783e+00,  2.3910e-01, -1.5591e+00,  ..., -1.6815e-01,\n          -1.0217e+00,  7.1091e-01]]], dtype=torch.float64).dtype
 +  and   torch.float32 = <module 'torch' from '/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/torch/__init__.py'>.float32
============================== 1 failed in 3.82s ===============================
