#!/usr/bin/env python3
"""
Phase G Dense Metrics Reporting Helper

Parses metrics_summary.json generated by summarize_phase_g_outputs() and emits:
- Aggregate metrics tables per model (deterministic sorted order)
- Delta tables comparing PtychoPINN against Baseline and PtyChi
- Stdout console output + optional Markdown file

Exit codes:
  0 - Success
  1 - Required model missing (cannot compute deltas)
  2 - Invalid input or IO error
"""

from __future__ import annotations

import argparse
import json
import sys
from pathlib import Path

DEFAULT_MS_SSIM_THRESHOLD = 0.80


def load_metrics(metrics_path: Path) -> dict:
    """Load and validate metrics_summary.json."""
    if not metrics_path.exists():
        print(f"ERROR: Metrics file not found: {metrics_path}", file=sys.stderr)
        sys.exit(2)

    try:
        with metrics_path.open('r') as f:
            data = json.load(f)
    except json.JSONDecodeError as e:
        print(f"ERROR: Invalid JSON in metrics file: {e}", file=sys.stderr)
        sys.exit(2)

    # Validate structure
    if 'aggregate_metrics' not in data:
        print("ERROR: Missing 'aggregate_metrics' field in metrics file", file=sys.stderr)
        sys.exit(2)

    return data


def validate_required_models(aggregate_metrics: dict) -> tuple[str, str, str]:
    """
    Ensure PtychoPINN, Baseline, and PtyChi are present for delta computation.
    Returns (pinn_key, baseline_key, ptychi_key) with actual keys from metrics.
    Accepts flexible model names with case-insensitive prefix matching.
    """
    available_keys = set(aggregate_metrics.keys())

    # Find PtychoPINN (exact match required)
    pinn_key = None
    if 'PtychoPINN' in available_keys:
        pinn_key = 'PtychoPINN'

    # Find Baseline (case-insensitive prefix match)
    baseline_key = None
    for key in available_keys:
        if key.lower().startswith('baseline'):
            baseline_key = key
            break

    # Find PtyChi/Pty-chi (case-insensitive, allows dash)
    ptychi_key = None
    for key in available_keys:
        key_clean = key.lower().replace('-', '').replace(' ', '').replace('(', '').replace(')', '')
        if 'ptychi' in key_clean:
            ptychi_key = key
            break

    # Check if all three models were found
    missing = []
    if pinn_key is None:
        missing.append('PtychoPINN')
    if baseline_key is None:
        missing.append('Baseline')
    if ptychi_key is None:
        missing.append('PtyChi')

    if missing:
        print(f"ERROR: Required models missing for delta computation: {', '.join(sorted(missing))}", file=sys.stderr)
        print(f"Available models: {', '.join(sorted(available_keys))}", file=sys.stderr)
        sys.exit(1)

    return (pinn_key, baseline_key, ptychi_key)


def format_metric_table(model_name: str, metrics: dict) -> str:
    """Format aggregate metrics for a single model as Markdown table."""
    lines = []
    lines.append(f"### {model_name}\n")

    # MS-SSIM table
    if 'ms_ssim' in metrics:
        ms_ssim = metrics['ms_ssim']
        lines.append("**MS-SSIM:**\n")
        lines.append("| Statistic | Amplitude | Phase |")
        lines.append("|-----------|-----------|-------|")

        mean_amp = ms_ssim.get('mean_amplitude', None)
        mean_phase = ms_ssim.get('mean_phase', None)
        best_amp = ms_ssim.get('best_amplitude', None)
        best_phase = ms_ssim.get('best_phase', None)

        mean_amp_str = f"{mean_amp:.3f}" if mean_amp is not None else 'N/A'
        mean_phase_str = f"{mean_phase:.3f}" if mean_phase is not None else 'N/A'
        best_amp_str = f"{best_amp:.3f}" if best_amp is not None else 'N/A'
        best_phase_str = f"{best_phase:.3f}" if best_phase is not None else 'N/A'

        lines.append(f"| Mean | {mean_amp_str} | {mean_phase_str} |")
        lines.append(f"| Best | {best_amp_str} | {best_phase_str} |")
        lines.append("")

    # MAE table
    if 'mae' in metrics:
        mae = metrics['mae']
        lines.append("**MAE:**\n")
        lines.append("| Statistic | Amplitude | Phase |")
        lines.append("|-----------|-----------|-------|")

        mean_amp = mae.get('mean_amplitude', None)
        mean_phase = mae.get('mean_phase', None)

        mean_amp_str = f"{mean_amp:.3f}" if mean_amp is not None else 'N/A'
        mean_phase_str = f"{mean_phase:.3f}" if mean_phase is not None else 'N/A'

        lines.append(f"| Mean | {mean_amp_str} | {mean_phase_str} |")
        lines.append("")

    return "\n".join(lines)


def compute_delta(pinn_val: float | None, other_val: float | None) -> str:
    """Compute PtychoPINN - Other delta with 3-decimal formatting."""
    if pinn_val is None or other_val is None:
        return 'N/A'
    delta = pinn_val - other_val
    return f"{delta:+.3f}"  # Include sign (+/-)


def format_delta_tables(pinn_metrics: dict, baseline_metrics: dict, ptychi_metrics: dict) -> str:
    """Format delta comparison tables."""
    lines = []
    lines.append("## Deltas (PtychoPINN vs Baselines)\n")
    lines.append("Positive values indicate PtychoPINN performs better (higher MS-SSIM or lower MAE).\n")

    # MS-SSIM deltas
    lines.append("### MS-SSIM Deltas\n")
    lines.append("| Comparison | Mean Amplitude | Best Amplitude | Mean Phase | Best Phase |")
    lines.append("|------------|----------------|----------------|------------|------------|")

    if 'ms_ssim' in pinn_metrics:
        pinn_ms = pinn_metrics['ms_ssim']
        base_ms = baseline_metrics.get('ms_ssim', {})
        pty_ms = ptychi_metrics.get('ms_ssim', {})

        # PtychoPINN vs Baseline
        delta_mean_amp_base = compute_delta(pinn_ms.get('mean_amplitude'), base_ms.get('mean_amplitude'))
        delta_best_amp_base = compute_delta(pinn_ms.get('best_amplitude'), base_ms.get('best_amplitude'))
        delta_mean_phase_base = compute_delta(pinn_ms.get('mean_phase'), base_ms.get('mean_phase'))
        delta_best_phase_base = compute_delta(pinn_ms.get('best_phase'), base_ms.get('best_phase'))

        lines.append(f"| vs Baseline | {delta_mean_amp_base} | {delta_best_amp_base} | {delta_mean_phase_base} | {delta_best_phase_base} |")

        # PtychoPINN vs PtyChi
        delta_mean_amp_pty = compute_delta(pinn_ms.get('mean_amplitude'), pty_ms.get('mean_amplitude'))
        delta_best_amp_pty = compute_delta(pinn_ms.get('best_amplitude'), pty_ms.get('best_amplitude'))
        delta_mean_phase_pty = compute_delta(pinn_ms.get('mean_phase'), pty_ms.get('mean_phase'))
        delta_best_phase_pty = compute_delta(pinn_ms.get('best_phase'), pty_ms.get('best_phase'))

        lines.append(f"| vs PtyChi | {delta_mean_amp_pty} | {delta_best_amp_pty} | {delta_mean_phase_pty} | {delta_best_phase_pty} |")

    lines.append("")

    # MAE deltas (note: for MAE, negative delta means PtychoPINN is better)
    lines.append("### MAE Deltas\n")
    lines.append("**Note:** For MAE, negative values indicate PtychoPINN performs better (lower error).\n")
    lines.append("| Comparison | Mean Amplitude | Mean Phase |")
    lines.append("|------------|----------------|------------|")

    if 'mae' in pinn_metrics:
        pinn_mae = pinn_metrics['mae']
        base_mae = baseline_metrics.get('mae', {})
        pty_mae = ptychi_metrics.get('mae', {})

        # PtychoPINN vs Baseline
        delta_mean_amp_base = compute_delta(pinn_mae.get('mean_amplitude'), base_mae.get('mean_amplitude'))
        delta_mean_phase_base = compute_delta(pinn_mae.get('mean_phase'), base_mae.get('mean_phase'))

        lines.append(f"| vs Baseline | {delta_mean_amp_base} | {delta_mean_phase_base} |")

        # PtychoPINN vs PtyChi
        delta_mean_amp_pty = compute_delta(pinn_mae.get('mean_amplitude'), pty_mae.get('mean_amplitude'))
        delta_mean_phase_pty = compute_delta(pinn_mae.get('mean_phase'), pty_mae.get('mean_phase'))

        lines.append(f"| vs PtyChi | {delta_mean_amp_pty} | {delta_mean_phase_pty} |")

    lines.append("")

    return "\n".join(lines)


def format_ms_ssim_health_section(aggregate_metrics: dict, threshold: float) -> str:
    """Create absolute MS-SSIM sanity section."""
    lines = []
    lines.append("## MS-SSIM Sanity Check\n")
    lines.append(f"_Threshold: mean amplitude/phase ≥ {threshold:.2f}_\n")
    lines.append("| Model | Mean Amplitude | Mean Phase | Status |")
    lines.append("|-------|----------------|------------|--------|")

    def classify(mean_amp: float | None, mean_phase: float | None) -> str:
        if mean_amp is None or mean_phase is None:
            return "MISSING"
        issues = []
        if mean_amp < threshold:
            issues.append("amp")
        if mean_phase < threshold:
            issues.append("phase")
        return "LOW (" + ",".join(issues) + ")" if issues else "OK"

    for model_name in sorted(aggregate_metrics.keys()):
        metrics = aggregate_metrics[model_name]
        ms_ssim = metrics.get('ms_ssim', {})
        mean_amp = ms_ssim.get('mean_amplitude')
        mean_phase = ms_ssim.get('mean_phase')
        amp_str = f"{mean_amp:.3f}" if mean_amp is not None else "N/A"
        phase_str = f"{mean_phase:.3f}" if mean_phase is not None else "N/A"
        status = classify(mean_amp, mean_phase)
        lines.append(f"| {model_name} | {amp_str} | {phase_str} | {status} |")

    lines.append("")
    return "\n".join(lines)


def generate_highlights(
    pinn_metrics: dict,
    baseline_metrics: dict,
    ptychi_metrics: dict,
    threshold: float,
) -> str:
    """Generate concise highlights text with top-line deltas."""
    lines = []
    lines.append("Phase G Dense Metrics — Highlights")
    lines.append("=" * 50)
    lines.append("")

    # Absolute MS-SSIM snapshot for sanity
    if 'ms_ssim' in pinn_metrics:
        pinn_ms = pinn_metrics['ms_ssim']
        base_ms = baseline_metrics.get('ms_ssim', {})
        pty_ms = ptychi_metrics.get('ms_ssim', {})

        def fmt(val: float | None) -> str:
            return f"{val:.3f}" if val is not None else "N/A"

        lines.append(f"MS-SSIM (mean) threshold: {threshold:.2f}")
        lines.append(f"  PtychoPINN amplitude/phase: {fmt(pinn_ms.get('mean_amplitude'))} / {fmt(pinn_ms.get('mean_phase'))}")
        lines.append(f"  Baseline amplitude/phase:  {fmt(base_ms.get('mean_amplitude'))} / {fmt(base_ms.get('mean_phase'))}")
        lines.append(f"  PtyChi amplitude/phase:    {fmt(pty_ms.get('mean_amplitude'))} / {fmt(pty_ms.get('mean_phase'))}")
        lines.append("")

    # MS-SSIM deltas
    if 'ms_ssim' in pinn_metrics:
        pinn_ms = pinn_metrics['ms_ssim']
        base_ms = baseline_metrics.get('ms_ssim', {})
        pty_ms = ptychi_metrics.get('ms_ssim', {})

        lines.append("MS-SSIM Deltas (PtychoPINN - Baseline):")
        delta_mean_amp_base = compute_delta(pinn_ms.get('mean_amplitude'), base_ms.get('mean_amplitude'))
        delta_mean_phase_base = compute_delta(pinn_ms.get('mean_phase'), base_ms.get('mean_phase'))
        lines.append(f"  Amplitude (mean): {delta_mean_amp_base}")
        lines.append(f"  Phase (mean):     {delta_mean_phase_base}")
        lines.append("")

        lines.append("MS-SSIM Deltas (PtychoPINN - PtyChi):")
        delta_mean_amp_pty = compute_delta(pinn_ms.get('mean_amplitude'), pty_ms.get('mean_amplitude'))
        delta_mean_phase_pty = compute_delta(pinn_ms.get('mean_phase'), pty_ms.get('mean_phase'))
        lines.append(f"  Amplitude (mean): {delta_mean_amp_pty}")
        lines.append(f"  Phase (mean):     {delta_mean_phase_pty}")
        lines.append("")

    # MAE deltas
    if 'mae' in pinn_metrics:
        pinn_mae = pinn_metrics['mae']
        base_mae = baseline_metrics.get('mae', {})
        pty_mae = ptychi_metrics.get('mae', {})

        lines.append("MAE Deltas (PtychoPINN - Baseline):")
        lines.append("  [Note: Negative = PtychoPINN better (lower error)]")
        delta_mean_amp_base = compute_delta(pinn_mae.get('mean_amplitude'), base_mae.get('mean_amplitude'))
        delta_mean_phase_base = compute_delta(pinn_mae.get('mean_phase'), base_mae.get('mean_phase'))
        lines.append(f"  Amplitude (mean): {delta_mean_amp_base}")
        lines.append(f"  Phase (mean):     {delta_mean_phase_base}")
        lines.append("")

        lines.append("MAE Deltas (PtychoPINN - PtyChi):")
        lines.append("  [Note: Negative = PtychoPINN better (lower error)]")
        delta_mean_amp_pty = compute_delta(pinn_mae.get('mean_amplitude'), pty_mae.get('mean_amplitude'))
        delta_mean_phase_pty = compute_delta(pinn_mae.get('mean_phase'), pty_mae.get('mean_phase'))
        lines.append(f"  Amplitude (mean): {delta_mean_amp_pty}")
        lines.append(f"  Phase (mean):     {delta_mean_phase_pty}")

    return "\n".join(lines)


def generate_report(data: dict, ms_ssim_threshold: float, pinn_key: str, baseline_key: str, ptychi_key: str) -> str:
    """Generate full Markdown report from metrics_summary.json."""
    aggregate_metrics = data['aggregate_metrics']

    lines = []
    lines.append("# Phase G Dense Metrics Report\n")

    # Job summary
    n_jobs = data.get('n_jobs', 0)
    n_success = data.get('n_success', 0)
    n_failed = data.get('n_failed', 0)

    lines.append(f"**Total Jobs:** {n_jobs}  ")
    lines.append(f"**Successful:** {n_success}  ")
    lines.append(f"**Failed:** {n_failed}  \n")

    # Absolute health section
    lines.append(format_ms_ssim_health_section(aggregate_metrics, ms_ssim_threshold))

    # Aggregate metrics per model (sorted for determinism)
    lines.append("## Aggregate Metrics\n")
    for model_name in sorted(aggregate_metrics.keys()):
        metrics = aggregate_metrics[model_name]
        lines.append(format_metric_table(model_name, metrics))

    # Delta tables (use actual keys from validation)
    pinn_metrics = aggregate_metrics[pinn_key]
    baseline_metrics = aggregate_metrics[baseline_key]
    ptychi_metrics = aggregate_metrics[ptychi_key]
    lines.append(format_delta_tables(pinn_metrics, baseline_metrics, ptychi_metrics))

    return "\n".join(lines)


def main() -> None:
    """CLI entry point."""
    parser = argparse.ArgumentParser(
        description="Generate aggregate metrics report from Phase G dense pipeline outputs.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    parser.add_argument(
        "--metrics",
        type=Path,
        required=True,
        help="Path to metrics_summary.json (output from summarize_phase_g_outputs)",
    )
    parser.add_argument(
        "--output",
        type=Path,
        help="Optional path to write Markdown report (in addition to stdout)",
    )
    parser.add_argument(
        "--highlights",
        type=Path,
        help="Optional path to write concise highlights text (top-line deltas)",
    )
    parser.add_argument(
        "--ms-ssim-threshold",
        type=float,
        default=DEFAULT_MS_SSIM_THRESHOLD,
        help="Threshold used to flag MS-SSIM health (default: 0.80)",
    )

    args = parser.parse_args()

    # Load and validate
    data = load_metrics(args.metrics)
    aggregate_metrics = data['aggregate_metrics']
    pinn_key, baseline_key, ptychi_key = validate_required_models(aggregate_metrics)

    # Generate report with actual model keys
    report = generate_report(data, args.ms_ssim_threshold, pinn_key, baseline_key, ptychi_key)

    # Emit to stdout
    print(report)

    # Optionally write Markdown file
    if args.output:
        try:
            args.output.parent.mkdir(parents=True, exist_ok=True)
            with args.output.open('w') as f:
                f.write(report)
            print(f"\n[report_phase_g_dense_metrics] Wrote Markdown report: {args.output}", file=sys.stderr)
        except IOError as e:
            print(f"ERROR: Failed to write Markdown report: {e}", file=sys.stderr)
            sys.exit(2)

    # Optionally write highlights file
    if args.highlights:
        try:
            pinn_metrics = aggregate_metrics[pinn_key]
            baseline_metrics = aggregate_metrics[baseline_key]
            ptychi_metrics = aggregate_metrics[ptychi_key]
            highlights = generate_highlights(
                pinn_metrics,
                baseline_metrics,
                ptychi_metrics,
                args.ms_ssim_threshold,
            )

            args.highlights.parent.mkdir(parents=True, exist_ok=True)
            with args.highlights.open('w') as f:
                f.write(highlights)
            print(f"[report_phase_g_dense_metrics] Wrote highlights: {args.highlights}", file=sys.stderr)
        except IOError as e:
            print(f"ERROR: Failed to write highlights: {e}", file=sys.stderr)
            sys.exit(2)


if __name__ == '__main__':
    main()
