#!/usr/bin/env python3
"""
Phase G Dense Metrics Analysis Script

Loads metrics_summary.json and aggregate_highlights.txt generated by the Phase G
dense orchestrator pipeline, summarizes MS-SSIM/MAE deltas, and emits a concise
Markdown digest suitable for documentation and reporting.

Exit codes:
  0 - Success (all comparison jobs succeeded)
  1 - Failures detected (n_failed > 0) or missing required input files
  2 - Invalid JSON or file format
"""

from __future__ import annotations

import argparse
import json
import sys
from pathlib import Path


def load_metrics_json(metrics_path: Path) -> dict:
    """Load and validate metrics_summary.json."""
    if not metrics_path.exists():
        print(f"ERROR: Metrics JSON file not found: {metrics_path}", file=sys.stderr)
        sys.exit(1)

    try:
        with metrics_path.open('r') as f:
            data = json.load(f)
    except json.JSONDecodeError as e:
        print(f"ERROR: Invalid JSON in metrics file: {e}", file=sys.stderr)
        sys.exit(2)
    except Exception as e:
        print(f"ERROR: Failed to read metrics file: {e}", file=sys.stderr)
        sys.exit(2)

    # Validate required structure
    if 'aggregate_metrics' not in data:
        print("ERROR: Missing 'aggregate_metrics' field in metrics JSON", file=sys.stderr)
        sys.exit(2)

    return data


def load_highlights_txt(highlights_path: Path) -> str:
    """Load aggregate_highlights.txt content."""
    if not highlights_path.exists():
        print(f"ERROR: Highlights file not found: {highlights_path}", file=sys.stderr)
        sys.exit(1)

    try:
        content = highlights_path.read_text()
    except Exception as e:
        print(f"ERROR: Failed to read highlights file: {e}", file=sys.stderr)
        sys.exit(2)

    if not content.strip():
        print("ERROR: Highlights file is empty", file=sys.stderr)
        sys.exit(2)

    return content


def generate_digest(metrics_data: dict, highlights_content: str) -> str:
    """Generate concise Markdown digest from metrics and highlights."""
    lines = []
    lines.append("# Phase G Dense Metrics Digest\n")

    # Extract job summary
    n_jobs = metrics_data.get('n_jobs', 0)
    n_success = metrics_data.get('n_success', 0)
    n_failed = metrics_data.get('n_failed', 0)

    # Add status banner (success or failure)
    if n_failed > 0:
        lines.append("**⚠️ FAILURES PRESENT ⚠️**\n")
        lines.append(f"**{n_failed} of {n_jobs} comparison job(s) failed.**")
        lines.append("Review pipeline logs for diagnostic information.\n")
    else:
        # Success banner when all jobs succeeded
        lines.append("**✓ ALL COMPARISONS SUCCESSFUL ✓**\n")
        lines.append(f"All {n_jobs} comparison job(s) completed successfully.\n")

    lines.append("## Pipeline Summary\n")
    lines.append(f"- Total comparison jobs: {n_jobs}")
    lines.append(f"- Successful: {n_success}")
    lines.append(f"- Failed: {n_failed}\n")

    # Add highlights section
    lines.append("## Highlights\n")
    lines.append("```")
    lines.append(highlights_content.strip())
    lines.append("```\n")

    # Extract key metrics from aggregate_metrics
    aggregate = metrics_data.get('aggregate_metrics', {})

    if 'PtychoPINN' in aggregate and 'Baseline' in aggregate and 'PtyChi' in aggregate:
        pinn = aggregate['PtychoPINN']
        baseline = aggregate['Baseline']
        ptychi = aggregate['PtyChi']

        lines.append("## Key Deltas\n")

        # MS-SSIM summary
        if 'ms_ssim' in pinn:
            pinn_ms = pinn['ms_ssim']
            base_ms = baseline.get('ms_ssim', {})
            pty_ms = ptychi.get('ms_ssim', {})

            lines.append("### MS-SSIM (Mean Values)\n")
            lines.append("| Comparison | Amplitude | Phase |")
            lines.append("|------------|-----------|-------|")

            # PtychoPINN vs Baseline
            pinn_amp = pinn_ms.get('mean_amplitude')
            base_amp = base_ms.get('mean_amplitude')
            pinn_phase = pinn_ms.get('mean_phase')
            base_phase = base_ms.get('mean_phase')

            if pinn_amp is not None and base_amp is not None:
                delta_amp_base = pinn_amp - base_amp
                delta_amp_str = f"{delta_amp_base:+.3f}"
            else:
                delta_amp_str = "N/A"

            if pinn_phase is not None and base_phase is not None:
                delta_phase_base = pinn_phase - base_phase
                delta_phase_str = f"{delta_phase_base:+.3f}"
            else:
                delta_phase_str = "N/A"

            lines.append(f"| PtychoPINN - Baseline | {delta_amp_str} | {delta_phase_str} |")

            # PtychoPINN vs PtyChi
            pty_amp = pty_ms.get('mean_amplitude')
            pty_phase = pty_ms.get('mean_phase')

            if pinn_amp is not None and pty_amp is not None:
                delta_amp_pty = pinn_amp - pty_amp
                delta_amp_pty_str = f"{delta_amp_pty:+.3f}"
            else:
                delta_amp_pty_str = "N/A"

            if pinn_phase is not None and pty_phase is not None:
                delta_phase_pty = pinn_phase - pty_phase
                delta_phase_pty_str = f"{delta_phase_pty:+.3f}"
            else:
                delta_phase_pty_str = "N/A"

            lines.append(f"| PtychoPINN - PtyChi | {delta_amp_pty_str} | {delta_phase_pty_str} |\n")

        # MAE summary
        if 'mae' in pinn:
            pinn_mae = pinn['mae']
            base_mae = baseline.get('mae', {})
            pty_mae = ptychi.get('mae', {})

            lines.append("### MAE (Mean Values)\n")
            lines.append("**Note:** Negative delta = PtychoPINN better (lower error)\n")
            lines.append("| Comparison | Amplitude | Phase |")
            lines.append("|------------|-----------|-------|")

            # PtychoPINN vs Baseline
            pinn_amp_mae = pinn_mae.get('mean_amplitude')
            base_amp_mae = base_mae.get('mean_amplitude')
            pinn_phase_mae = pinn_mae.get('mean_phase')
            base_phase_mae = base_mae.get('mean_phase')

            if pinn_amp_mae is not None and base_amp_mae is not None:
                delta_amp_base_mae = pinn_amp_mae - base_amp_mae
                delta_amp_mae_str = f"{delta_amp_base_mae:+.3f}"
            else:
                delta_amp_mae_str = "N/A"

            if pinn_phase_mae is not None and base_phase_mae is not None:
                delta_phase_base_mae = pinn_phase_mae - base_phase_mae
                delta_phase_mae_str = f"{delta_phase_base_mae:+.3f}"
            else:
                delta_phase_mae_str = "N/A"

            lines.append(f"| PtychoPINN - Baseline | {delta_amp_mae_str} | {delta_phase_mae_str} |")

            # PtychoPINN vs PtyChi
            pty_amp_mae = pty_mae.get('mean_amplitude')
            pty_phase_mae = pty_mae.get('mean_phase')

            if pinn_amp_mae is not None and pty_amp_mae is not None:
                delta_amp_pty_mae = pinn_amp_mae - pty_amp_mae
                delta_amp_pty_mae_str = f"{delta_amp_pty_mae:+.3f}"
            else:
                delta_amp_pty_mae_str = "N/A"

            if pinn_phase_mae is not None and pty_phase_mae is not None:
                delta_phase_pty_mae = pinn_phase_mae - pty_phase_mae
                delta_phase_pty_mae_str = f"{delta_phase_pty_mae:+.3f}"
            else:
                delta_phase_pty_mae_str = "N/A"

            lines.append(f"| PtychoPINN - PtyChi | {delta_amp_pty_mae_str} | {delta_phase_pty_mae_str} |\n")

    else:
        lines.append("## Key Deltas\n")
        lines.append("**Note:** Cannot compute deltas - missing required models (PtychoPINN, Baseline, or PtyChi)\n")

    # Add reference to full report
    lines.append("## References\n")
    lines.append("- Full metrics report: `aggregate_report.md`")
    lines.append("- Raw metrics data: `metrics_summary.json`")
    lines.append("- Detailed highlights: `aggregate_highlights.txt`")

    return "\n".join(lines)


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description="Analyze Phase G dense metrics and generate digest",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Example usage:
  python analyze_dense_metrics.py \\
    --metrics path/to/metrics_summary.json \\
    --highlights path/to/aggregate_highlights.txt \\
    --output path/to/metrics_digest.md
        """
    )

    parser.add_argument(
        '--metrics',
        type=Path,
        required=True,
        help='Path to metrics_summary.json file'
    )

    parser.add_argument(
        '--highlights',
        type=Path,
        required=True,
        help='Path to aggregate_highlights.txt file'
    )

    parser.add_argument(
        '--output',
        type=Path,
        required=True,
        help='Path to output metrics_digest.md file'
    )

    args = parser.parse_args()

    # Load inputs
    metrics_data = load_metrics_json(args.metrics)
    highlights_content = load_highlights_txt(args.highlights)

    # Check for failures before generating digest
    n_failed = metrics_data.get('n_failed', 0)
    if n_failed > 0:
        print(f"\n**⚠️ FAILURES PRESENT ⚠️**", file=sys.stderr)
        print(f"{n_failed} comparison job(s) failed. Review logs for details.", file=sys.stderr)

    # Generate digest
    digest = generate_digest(metrics_data, highlights_content)

    # Print to stdout
    print(digest)

    # Write to file
    try:
        args.output.parent.mkdir(parents=True, exist_ok=True)
        args.output.write_text(digest)
        print(f"\n[analyze_dense_metrics] Digest written to: {args.output}", file=sys.stderr)
    except Exception as e:
        print(f"\nERROR: Failed to write digest to {args.output}: {e}", file=sys.stderr)
        sys.exit(2)

    # Exit with non-zero status if failures are present
    if n_failed > 0:
        sys.exit(1)

    sys.exit(0)


if __name__ == '__main__':
    main()
