============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_phase_g_dense_artifacts_verifier.py::test_verify_dense_pipeline_cli_logs_missing FAILED [100%]

=================================== FAILURES ===================================
_________________ test_verify_dense_pipeline_cli_logs_missing __________________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-483/test_verify_dense_pipeline_cli0')

    def test_verify_dense_pipeline_cli_logs_missing(tmp_path: Path) -> None:
        """
        RED test: Verify that CLI log validation fails when required logs are missing.
    
        Acceptance:
        - Create a hub with cli/ directory but missing phase logs
        - Invoke verify_dense_pipeline_artifacts.py --hub <hub> --report <report>
        - Assert the script exits with non-zero status
        - Assert the verification report JSON shows a validation failure for CLI logs
        - Assert error message mentions missing phase banners or SUCCESS sentinel
    
        Follows input.md Do Now step 1 (TDD RED).
        """
        # Setup: Create incomplete hub (cli/ dir exists but logs are empty/missing)
        hub = tmp_path / "incomplete_cli_hub"
        analysis = hub / "analysis"
        cli_dir = hub / "cli"
        analysis.mkdir(parents=True)
        cli_dir.mkdir(parents=True)
    
        # Create minimal artifacts so other checks don't all fail
        (analysis / "metrics_summary.json").write_text(json.dumps({
            "n_jobs": 6,
            "n_success": 6,
            "n_failed": 0,
            "aggregate_metrics": {},
            "phase_c_metadata_compliance": {}
        }))
        (analysis / "comparison_manifest.json").write_text(json.dumps({
            "n_jobs": 6,
            "n_success": 6,
            "n_failed": 0,
            "jobs": []
        }))
        (analysis / "metrics_summary.md").write_text("# Metrics Summary")
        (analysis / "aggregate_highlights.txt").write_text("highlights")
        (analysis / "metrics_digest.md").write_text("# Metrics Digest")
        (analysis / "metrics_delta_summary.json").write_text(json.dumps({
            "deltas": {}
        }))
        (analysis / "metrics_delta_highlights.txt").write_text(
            "MS-SSIM Δ (PtychoPINN - Baseline): +0.010\n"
            "MS-SSIM Δ (PtychoPINN - PtyChi): +0.005\n"
            "MAE Δ (PtychoPINN - Baseline): -0.020\n"
            "MAE Δ (PtychoPINN - PtyChi): -0.015"
        )
        (analysis / "artifact_inventory.txt").write_text(
            "analysis/metrics_summary.json\n"
            "analysis/metrics_summary.md\n"
            "cli/phase_c_generation.log\n"
        )
    
        # Create a CLI log that is incomplete (missing phase banners and SUCCESS)
        (cli_dir / "phase_c_generation.log").write_text(
            "# Command: python -m studies.fly64_dose_overlap.generation\n"
            "Some output\n"
            "But no phase banners or success marker\n"
        )
    
        report_path = tmp_path / "report_missing_cli.json"
    
        # Execute: Import and run the verifier
        import sys
        import importlib.util
    
        verifier_script = Path(__file__).parent.parent.parent / "plans" / "active" / \
                          "STUDY-SYNTH-FLY64-DOSE-OVERLAP-001" / "bin" / "verify_dense_pipeline_artifacts.py"
    
        spec = importlib.util.spec_from_file_location("verifier", verifier_script)
        verifier = importlib.util.module_from_spec(spec)
    
        # Monkeypatch sys.argv
        original_argv = sys.argv
        sys.argv = [
            str(verifier_script),
            "--hub", str(hub),
            "--report", str(report_path),
        ]
    
        try:
            spec.loader.exec_module(verifier)
            exit_code = verifier.main()
        except SystemExit as e:
            exit_code = e.code
        finally:
            sys.argv = original_argv
    
        # Assert: Verification failed due to missing CLI log validation
        assert exit_code != 0, f"Expected non-zero exit code with incomplete CLI logs, got {exit_code}"
    
        # Load report and check for CLI log validation failure
        assert report_path.exists(), "Report JSON should be created even on failure"
    
        with report_path.open('r') as f:
            report_data = json.load(f)
    
        assert not report_data['all_valid'], \
            "Expected all_valid=False with incomplete CLI logs"
        assert report_data['n_invalid'] > 0, "Expected at least one invalid check"
    
        # Find the CLI log validation result
        cli_check = None
        for check in report_data['validations']:
            desc = check.get('description', '').lower()
            if 'cli log' in desc or 'phase banner' in desc or 'success' in desc:
                cli_check = check
                break
    
>       assert cli_check is not None, \
            "Expected validation check for CLI logs/banners/SUCCESS marker"
E       AssertionError: Expected validation check for CLI logs/banners/SUCCESS marker
E       assert None is not None

tests/study/test_phase_g_dense_artifacts_verifier.py:370: AssertionError
----------------------------- Captured stdout call -----------------------------
[verify_dense_pipeline_artifacts] Hub: /tmp/pytest-of-ollie/pytest-483/test_verify_dense_pipeline_cli0/incomplete_cli_hub
[verify_dense_pipeline_artifacts] Report: /tmp/pytest-of-ollie/pytest-483/test_verify_dense_pipeline_cli0/report_missing_cli.json

[verify_dense_pipeline_artifacts] Verification Summary:
  Total checks: 10
  Valid: 6
  Invalid: 4
  Report: /tmp/pytest-of-ollie/pytest-483/test_verify_dense_pipeline_cli0/report_missing_cli.json

[verify_dense_pipeline_artifacts] FAILURES:
  ✗ Metrics digest: Missing sections: # Phase G Dense Metrics Digest, ## Pipeline Summary, ## Highlights
  ✗ Phase C metadata compliance: Missing phase_c_metadata_compliance field
  ✗ Metrics delta summary JSON: Missing required fields: generated_at, source_metrics
  ✗ CLI orchestrator logs validation: Orchestrator log not found: run_phase_g_dense.log is required
=========================== short test summary info ============================
FAILED tests/study/test_phase_g_dense_artifacts_verifier.py::test_verify_dense_pipeline_cli_logs_missing - AssertionError: Expected validation check for CLI logs/banners/SUCCESS marker
assert None is not None
============================== 1 failed in 0.85s ===============================
