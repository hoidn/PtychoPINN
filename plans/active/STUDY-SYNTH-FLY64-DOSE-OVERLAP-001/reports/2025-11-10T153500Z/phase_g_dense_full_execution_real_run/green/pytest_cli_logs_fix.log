============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_phase_g_dense_artifacts_verifier.py::test_verify_dense_pipeline_cli_logs_complete FAILED [100%]

=================================== FAILURES ===================================
_________________ test_verify_dense_pipeline_cli_logs_complete _________________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-509/test_verify_dense_pipeline_cli0')

    def test_verify_dense_pipeline_cli_logs_complete(tmp_path: Path) -> None:
        """
        GREEN test: Verify that CLI log validation passes when all required logs are present.
    
        Acceptance:
        - Create a hub with cli/ directory containing complete logs with all phase banners
        - Ensure logs include [1/8]...[8/8] banners and "SUCCESS: All phases completed"
        - Invoke verify_dense_pipeline_artifacts.py --hub <hub> --report <report>
        - Assert the script exits with status 0
        - Assert the verification report JSON shows CLI log validation passed
    
        Follows input.md Do Now step 1 (TDD GREEN).
        """
        # Setup: Create complete hub with proper CLI logs
        hub = tmp_path / "complete_cli_hub"
        analysis = hub / "analysis"
        cli_dir = hub / "cli"
        analysis.mkdir(parents=True)
        cli_dir.mkdir(parents=True)
    
        # Create minimal artifacts
        (analysis / "metrics_summary.json").write_text(json.dumps({
            "n_jobs": 6,
            "n_success": 6,
            "n_failed": 0,
            "aggregate_metrics": {},
            "phase_c_metadata_compliance": {}
        }))
        (analysis / "comparison_manifest.json").write_text(json.dumps({
            "n_jobs": 6,
            "n_success": 6,
            "n_failed": 0,
            "jobs": []
        }))
        (analysis / "metrics_summary.md").write_text("# Metrics Summary")
        (analysis / "aggregate_highlights.txt").write_text("highlights")
        (analysis / "metrics_digest.md").write_text("# Metrics Digest")
        (analysis / "metrics_delta_summary.json").write_text(json.dumps({
            "deltas": {}
        }))
        (analysis / "metrics_delta_highlights.txt").write_text(
            "MS-SSIM Δ (PtychoPINN - Baseline): +0.010\n"
            "MS-SSIM Δ (PtychoPINN - PtyChi): +0.005\n"
            "MAE Δ (PtychoPINN - Baseline): -0.020\n"
            "MAE Δ (PtychoPINN - PtyChi): -0.015"
        )
        (analysis / "artifact_inventory.txt").write_text(
            "analysis/metrics_summary.json\n"
            "analysis/metrics_summary.md\n"
            "cli/run_phase_g_dense.log\n"
        )
    
        # Create a complete CLI log with all phase banners and SUCCESS
        complete_log_content = """
    # Command: python plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/bin/run_phase_g_dense.py
    # CWD: /home/user/PtychoPINN2
    # Log: cli/run_phase_g_dense.log
    # ==============================================================================
    
    [run_phase_g_dense] Preparing hub...
    [run_phase_g_dense] Hub: /home/user/hub
    [run_phase_g_dense] Total commands: 8
    
    ================================================================================
    [1/8] Phase C: Dataset Generation
    ================================================================================
    Running phase C...
    
    ================================================================================
    [2/8] Phase D: Overlap View Generation
    ================================================================================
    Running phase D...
    
    ================================================================================
    [3/8] Phase E: Training Baseline (gs1)
    ================================================================================
    Running baseline training...
    
    ================================================================================
    [4/8] Phase E: Training Dense (gs2)
    ================================================================================
    Running dense training...
    
    ================================================================================
    [5/8] Phase F: Reconstruction dense/train
    ================================================================================
    Running reconstruction train...
    
    ================================================================================
    [6/8] Phase F: Reconstruction dense/test
    ================================================================================
    Running reconstruction test...
    
    ================================================================================
    [7/8] Phase G: Comparison dense/train
    ================================================================================
    Running comparison train...
    
    ================================================================================
    [8/8] Phase G: Comparison dense/test
    ================================================================================
    Running comparison test...
    
    ================================================================================
    [run_phase_g_dense] SUCCESS: All phases completed
    ================================================================================
    """
        (cli_dir / "run_phase_g_dense.log").write_text(complete_log_content)
    
        # Create all required per-phase logs (requirement added in this TDD cycle)
        phase_logs = {
            "phase_c_generation.log": "Phase C generation complete\n",
            "phase_d_dense.log": "Phase D overlap view generation complete\n",
            "phase_e_baseline.log": "Phase E baseline training complete\n",
            "phase_e_dense.log": "Phase E dense training complete\n",
            "phase_f_train.log": "Phase F train reconstruction complete\n",
            "phase_f_test.log": "Phase F test reconstruction complete\n",
            "phase_g_train.log": "Phase G train comparison complete\n",
            "phase_g_test.log": "Phase G test comparison complete\n",
        }
    
        for log_name, content in phase_logs.items():
            (cli_dir / log_name).write_text(f"# {log_name}\n{content}")
    
        report_path = tmp_path / "report_complete_cli.json"
    
        # Execute: Import and run the verifier
        import sys
        import importlib.util
    
        verifier_script = Path(__file__).parent.parent.parent / "plans" / "active" / \
                          "STUDY-SYNTH-FLY64-DOSE-OVERLAP-001" / "bin" / "verify_dense_pipeline_artifacts.py"
    
        spec = importlib.util.spec_from_file_location("verifier", verifier_script)
        verifier = importlib.util.module_from_spec(spec)
    
        # Monkeypatch sys.argv
        original_argv = sys.argv
        sys.argv = [
            str(verifier_script),
            "--hub", str(hub),
            "--report", str(report_path),
        ]
    
        try:
            spec.loader.exec_module(verifier)
            exit_code = verifier.main()
        except SystemExit as e:
            exit_code = e.code
        finally:
            sys.argv = original_argv
    
        # Load report and check CLI log validation passed
        # Note: Other checks may fail due to minimal fixture data, but we only care about CLI validation here
        assert report_path.exists(), "Report JSON should be created"
    
        with report_path.open('r') as f:
            report_data = json.load(f)
    
        # Find the CLI log validation result
        cli_check = None
        for check in report_data['validations']:
            desc = check.get('description', '').lower()
            if 'orchestrator' in desc or ('cli' in desc and 'log' in desc):
                cli_check = check
                break
    
        # The CLI check must exist and be valid
        assert cli_check is not None, \
            f"Expected validation check for CLI orchestrator logs. Available checks: {[v.get('description') for v in report_data['validations']]}"
>       assert cli_check['valid'], \
            f"Expected CLI log check to be valid with complete logs, got error: {cli_check.get('error', 'none')}"
E       AssertionError: Expected CLI log check to be valid with complete logs, got error: Missing required per-phase log files: phase_e_baseline_gs1_dose1000.log, phase_e_dense_gs2_dose1000.log, phase_f_dense_train.log, phase_f_dense_test.log, phase_g_dense_train.log, phase_g_dense_test.log
E       assert False

tests/study/test_phase_g_dense_artifacts_verifier.py:600: AssertionError
----------------------------- Captured stdout call -----------------------------
[verify_dense_pipeline_artifacts] Hub: /tmp/pytest-of-ollie/pytest-509/test_verify_dense_pipeline_cli0/complete_cli_hub
[verify_dense_pipeline_artifacts] Report: /tmp/pytest-of-ollie/pytest-509/test_verify_dense_pipeline_cli0/report_complete_cli.json

[verify_dense_pipeline_artifacts] Verification Summary:
  Total checks: 10
  Valid: 6
  Invalid: 4
  Report: /tmp/pytest-of-ollie/pytest-509/test_verify_dense_pipeline_cli0/report_complete_cli.json

[verify_dense_pipeline_artifacts] FAILURES:
  ✗ Metrics digest: Missing sections: # Phase G Dense Metrics Digest, ## Pipeline Summary, ## Highlights
  ✗ Phase C metadata compliance: Missing phase_c_metadata_compliance field
  ✗ Metrics delta summary JSON: Missing required fields: generated_at, source_metrics
  ✗ CLI orchestrator logs validation: Missing required per-phase log files: phase_e_baseline_gs1_dose1000.log, phase_e_dense_gs2_dose1000.log, phase_f_dense_train.log, phase_f_dense_test.log, phase_g_dense_train.log, phase_g_dense_test.log
=========================== short test summary info ============================
FAILED tests/study/test_phase_g_dense_artifacts_verifier.py::test_verify_dense_pipeline_cli_logs_complete - AssertionError: Expected CLI log check to be valid with complete logs, got error: Missing required per-phase log files: phase_e_baseline_gs1_dose1000.log, phase_e_dense_gs2_dose1000.log, phase_f_dense_train.log, phase_f_dense_test.log, phase_g_dense_train.log, phase_g_dense_test.log
assert False
============================== 1 failed in 0.85s ===============================
