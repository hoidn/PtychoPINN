============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_phase_g_dense_artifacts_verifier.py::test_verify_dense_pipeline_cli_phase_logs_wrong_pattern FAILED [100%]

=================================== FAILURES ===================================
___________ test_verify_dense_pipeline_cli_phase_logs_wrong_pattern ____________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-504/test_verify_dense_pipeline_cli0')

    def test_verify_dense_pipeline_cli_phase_logs_wrong_pattern(tmp_path: Path) -> None:
        """
        RED test: Verify that per-phase CLI log validation fails when phase logs use wrong filename patterns.
    
        Acceptance:
        - Create a hub with cli/ directory containing orchestrator log and phase logs
        - Phase logs use OLD generic names (phase_e_baseline.log) instead of dose/view-specific names
          (phase_e_baseline_gs1_dose1000.log) that run_phase_g_dense.py actually generates
        - Invoke verify_dense_pipeline_artifacts.py --hub <hub> --report <report>
        - Assert the script exits with non-zero status
        - Assert the verification report JSON shows a validation failure for CLI logs
        - Assert error message indicates missing phase logs with correct patterns
    
        Follows input.md Do Now step 1 (TDD RED for filename pattern enforcement).
        """
        # Setup: Create hub with orchestrator log but WRONG-PATTERN phase logs
        hub = tmp_path / "hub_wrong_pattern_phase_logs"
        analysis = hub / "analysis"
        cli_dir = hub / "cli"
        analysis.mkdir(parents=True)
        cli_dir.mkdir(parents=True)
    
        # Create minimal artifacts so other checks don't all fail
        (analysis / "metrics_summary.json").write_text(json.dumps({
            "n_jobs": 6,
            "n_success": 6,
            "n_failed": 0,
            "aggregate_metrics": {},
            "phase_c_metadata_compliance": {}
        }))
        (analysis / "comparison_manifest.json").write_text(json.dumps({
            "n_jobs": 6,
            "n_success": 6,
            "n_failed": 0,
            "jobs": []
        }))
        (analysis / "metrics_summary.md").write_text("# Metrics Summary")
        (analysis / "aggregate_highlights.txt").write_text("highlights")
        (analysis / "metrics_digest.md").write_text("# Metrics Digest")
        (analysis / "metrics_delta_summary.json").write_text(json.dumps({
            "deltas": {}
        }))
        (analysis / "metrics_delta_highlights.txt").write_text(
            "MS-SSIM Δ (PtychoPINN - Baseline): +0.010\n"
            "MS-SSIM Δ (PtychoPINN - PtyChi): +0.005\n"
            "MAE Δ (PtychoPINN - Baseline): -0.020\n"
            "MAE Δ (PtychoPINN - PtyChi): -0.015"
        )
        (analysis / "artifact_inventory.txt").write_text(
            "analysis/metrics_summary.json\n"
            "analysis/metrics_summary.md\n"
            "cli/run_phase_g_dense.log\n"
        )
    
        # Create orchestrator log with all phase banners and SUCCESS
        orchestrator_log_content = """[run_phase_g_dense] Starting pipeline...
    ================================================================================
    [1/8] Phase C: Dataset Generation
    ================================================================================
    Running Phase C...
    ================================================================================
    [2/8] Phase D: Overlap View Generation
    ================================================================================
    Running Phase D...
    ================================================================================
    [3/8] Phase E: Training Baseline (gs1)
    ================================================================================
    Running baseline...
    ================================================================================
    [4/8] Phase E: Training Dense (gs2)
    ================================================================================
    Running dense...
    ================================================================================
    [5/8] Phase F: Reconstruction dense/train
    ================================================================================
    Reconstruction train...
    ================================================================================
    [6/8] Phase F: Reconstruction dense/test
    ================================================================================
    Reconstruction test...
    ================================================================================
    [7/8] Phase G: Comparison dense/train
    ================================================================================
    Comparison train...
    ================================================================================
    [8/8] Phase G: Comparison dense/test
    ================================================================================
    Comparison test...
    ================================================================================
    [run_phase_g_dense] SUCCESS: All phases completed
    ================================================================================
    """
        (cli_dir / "run_phase_g_dense.log").write_text(orchestrator_log_content)
    
        # Create phase logs with WRONG PATTERN (old generic names, not dose/view-specific)
        # These are the OLD names that don't match what run_phase_g_dense.py actually generates
        wrong_pattern_logs = {
            "phase_c_generation.log": "Phase C generation complete\n",
            "phase_d_dense.log": "Phase D overlap view generation complete\n",
            "phase_e_baseline.log": "Phase E baseline training complete\n",  # Should be phase_e_baseline_gs1_dose1000.log
            "phase_e_dense.log": "Phase E dense training complete\n",  # Should be phase_e_dense_gs2_dose1000.log
            "phase_f_train.log": "Phase F train reconstruction complete\n",  # Should be phase_f_dense_train.log
            "phase_f_test.log": "Phase F test reconstruction complete\n",  # Should be phase_f_dense_test.log
            "phase_g_train.log": "Phase G train comparison complete\n",  # Should be phase_g_dense_train.log
            "phase_g_test.log": "Phase G test comparison complete\n",  # Should be phase_g_dense_test.log
        }
    
        for log_name, content in wrong_pattern_logs.items():
            (cli_dir / log_name).write_text(f"# {log_name}\n# Starting phase...\n{content}")
    
        report_path = tmp_path / "report_wrong_pattern.json"
    
        # Execute: Import and run the verifier
        import sys
        import importlib.util
    
        verifier_script = Path(__file__).parent.parent.parent / "plans" / "active" / \
                          "STUDY-SYNTH-FLY64-DOSE-OVERLAP-001" / "bin" / "verify_dense_pipeline_artifacts.py"
    
        spec = importlib.util.spec_from_file_location("verifier", verifier_script)
        verifier = importlib.util.module_from_spec(spec)
    
        # Monkeypatch sys.argv
        original_argv = sys.argv
        sys.argv = [
            str(verifier_script),
            "--hub", str(hub),
            "--report", str(report_path),
        ]
    
        try:
            spec.loader.exec_module(verifier)
            exit_code = verifier.main()
        except SystemExit as e:
            exit_code = e.code
        finally:
            sys.argv = original_argv
    
        # Assert: Verification should FAIL because expected dose/view-specific patterns are missing
        assert exit_code != 0, "Expected non-zero exit code when phase logs use wrong filename pattern"
    
        # Load report and check CLI log validation failed
        assert report_path.exists(), "Report JSON should be created"
    
        with report_path.open('r') as f:
            report_data = json.load(f)
    
        # Find the CLI log validation result
        cli_check = None
        for check in report_data['validations']:
            desc = check.get('description', '').lower()
            if 'orchestrator' in desc or ('cli' in desc and 'log' in desc):
                cli_check = check
                break
    
        assert cli_check is not None, \
            f"Expected validation check for CLI logs. Available checks: {[v.get('description') for v in report_data['validations']]}"
>       assert not cli_check['valid'], \
            "Expected CLI log check to be invalid with wrong filename patterns"
E       AssertionError: Expected CLI log check to be invalid with wrong filename patterns
E       assert not True

tests/study/test_phase_g_dense_artifacts_verifier.py:928: AssertionError
----------------------------- Captured stdout call -----------------------------
[verify_dense_pipeline_artifacts] Hub: /tmp/pytest-of-ollie/pytest-504/test_verify_dense_pipeline_cli0/hub_wrong_pattern_phase_logs
[verify_dense_pipeline_artifacts] Report: /tmp/pytest-of-ollie/pytest-504/test_verify_dense_pipeline_cli0/report_wrong_pattern.json

[verify_dense_pipeline_artifacts] Verification Summary:
  Total checks: 10
  Valid: 7
  Invalid: 3
  Report: /tmp/pytest-of-ollie/pytest-504/test_verify_dense_pipeline_cli0/report_wrong_pattern.json

[verify_dense_pipeline_artifacts] FAILURES:
  ✗ Metrics digest: Missing sections: # Phase G Dense Metrics Digest, ## Pipeline Summary, ## Highlights
  ✗ Phase C metadata compliance: Missing phase_c_metadata_compliance field
  ✗ Metrics delta summary JSON: Missing required fields: generated_at, source_metrics
=========================== short test summary info ============================
FAILED tests/study/test_phase_g_dense_artifacts_verifier.py::test_verify_dense_pipeline_cli_phase_logs_wrong_pattern - AssertionError: Expected CLI log check to be invalid with wrong filename patterns
assert not True
============================== 1 failed in 0.85s ===============================
