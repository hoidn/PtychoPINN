============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 9 items / 7 deselected / 2 selected

tests/study/test_dose_overlap_overlap.py::test_spacing_filter_parametrized[sparse-True] PASSED [ 50%]
tests/study/test_dose_overlap_overlap.py::test_spacing_filter_parametrized[dense-False] PASSED [100%]

======================= 2 passed, 7 deselected in 0.96s ========================
============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_dose_overlap_overlap.py::test_generate_overlap_views_paths FAILED [100%]

=================================== FAILURES ===================================
______________________ test_generate_overlap_views_paths _______________________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-31/test_generate_overlap_views_pa0')
study_design = StudyDesign(dose_list=[1000.0, 10000.0, 100000.0], gridsizes=[1, 2], neighbor_count=7, patch_size_pixels=128, overlap_...: 456}, metrics_config={'ms_ssim_sigma': 1.0, 'emphasize_phase': True, 'report_amplitude': True, 'frc_threshold': 0.5})

    def test_generate_overlap_views_paths(tmp_path: Path, study_design: StudyDesign):
        """
        Integration test for generate_overlap_views orchestration.
    
        RED expectation: This test will fail when validation enforces spacing threshold
        on dense coordinates that violate the threshold.
    
        GREEN expectation: After implementation correctly filters positions,
        this test passes with accepted positions only.
    
        Selector: pytest tests/study/test_dose_overlap_overlap.py::test_generate_overlap_views_paths -vv
        """
        # Create synthetic train/test NPZs with DENSE coordinates (will violate dense threshold)
        coords_dense = np.array([[0, 0], [30, 0], [60, 0], [0, 30], [30, 30], [60, 30]], dtype=np.float32)
        n = len(coords_dense)
    
        train_data = {
            'diffraction': np.random.randn(n, 64, 64).astype(np.float32),
            'objectGuess': np.random.randn(128, 128).astype(np.complex64),
            'probeGuess': np.random.randn(64, 64).astype(np.complex64),
            'xcoords': coords_dense[:, 0],
            'ycoords': coords_dense[:, 1],
        }
        test_data = train_data.copy()  # Simplified: reuse same coords
    
        train_path = tmp_path / "train.npz"
        test_path = tmp_path / "test.npz"
        np.savez_compressed(train_path, **train_data)
        np.savez_compressed(test_path, **test_data)
    
        output_dir = tmp_path / "dense_view"
    
        # Attempt to generate dense view
        # RED: This should raise ValueError due to spacing < threshold
        # GREEN: After filtering implementation, this passes with reduced positions
>       with pytest.raises(ValueError, match="Minimum inter-position spacing .* < required threshold"):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/study/test_dose_overlap_overlap.py:261: Failed
----------------------------- Captured stdout call -----------------------------

============================================================
Generating dense overlap view
Threshold: 38.40 px (f_overlap=0.7)
============================================================

[TRAIN] Processing train.npz...
  Computing spacing matrix for 6 positions...
  Spacing metrics:
    Min: 30.00 px
    Max: 67.08 px
    Mean: 42.26 px
    Median: 42.43 px
    Acceptance: 0/6 (0.0%)
  Filtering to accepted positions...
  Validating DATA-001 compliance + spacing constraint...
    ✓ Validation passed
  Writing filtered NPZ: /tmp/pytest-of-ollie/pytest-31/test_generate_overlap_views_pa0/dense_view/dense_train.npz
  ✓ TRAIN complete

[TEST] Processing test.npz...
  Computing spacing matrix for 6 positions...
  Spacing metrics:
    Min: 30.00 px
    Max: 67.08 px
    Mean: 42.26 px
    Median: 42.43 px
    Acceptance: 0/6 (0.0%)
  Filtering to accepted positions...
  Validating DATA-001 compliance + spacing constraint...
    ✓ Validation passed
  Writing filtered NPZ: /tmp/pytest-of-ollie/pytest-31/test_generate_overlap_views_pa0/dense_view/dense_test.npz
  ✓ TEST complete

============================================================
Dense view generation complete
============================================================

=========================== short test summary info ============================
FAILED tests/study/test_dose_overlap_overlap.py::test_generate_overlap_views_paths - Failed: DID NOT RAISE <class 'ValueError'>
============================== 1 failed in 1.02s ===============================
