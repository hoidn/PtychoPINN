# Phase C Plan — Dataset Generation

## Context
- **Initiative:** STUDY-SYNTH-FLY64-DOSE-OVERLAP-001
- **Phase Goal:** Produce canonical train/test NPZ datasets for each dose in the design sweep (1e3, 1e4, 1e5) using the fly64 object/probe while preserving y-axis separation and preparing artifacts for downstream overlap studies.
- **Dependencies:** Phase A design constants (`studies/fly64_dose_overlap/design.py`), Phase B validator (`studies/fly64_dose_overlap/validation.py`), DATA-001 contract (`specs/data_contracts.md`), spacing/oversampling guidance (`docs/GRIDSIZE_N_GROUPS_GUIDE.md:141-151`, `docs/SAMPLING_USER_GUIDE.md:112-123`), canonicalization tooling (`scripts/tools/transpose_rename_convert_tool.py`), patch generation tool (`scripts/tools/generate_patches_tool.py`), and dataset splitter (`scripts/tools/split_dataset_tool.py`).

### Phase C — Dose Sweep Dataset Generation
Goal: Automate dataset synthesis for each dose, ensuring outputs satisfy DATA-001 via Phase B validator and are stored with reproducible metadata for later grouping/training phases.
Prereqs: Phase A/B complete; base dataset `datasets/fly64/fly64_shuffled.npz` verified to contain object/probe; StudyDesign constants validated.
Exit Criteria: New module orchestrates simulation → canonicalization → patch generation → train/test split → validation for each dose; pytest coverage exercises config construction & pipeline wiring; run logs captured under the Phase C artifact hub; documentation and ledger updated with generated artifact locations and validation evidence.

| ID | Task Description | State | How/Why & Guidance (API/doc/artifact/source refs) |
| --- | --- | --- | --- |
| C1 | Implement `studies/fly64_dose_overlap/generation.py::build_simulation_plan` returning a dataclass with dose-specific `TrainingConfig`, `ModelConfig`, and derived counts (n_images = len(base xcoords), seeds from `StudyDesign`). | [ ] | Import `TrainingConfig`, `ModelConfig` (`ptycho.config.config`). Use `StudyDesign` for `nphotons`, `rng_seeds['simulation']`, `patch_size_pixels`, `gridsizes`. Reference `docs/GRIDSIZE_N_GROUPS_GUIDE.md:141-151` for spacing context & ensure `TrainingConfig.n_groups` aligns with base dataset length (use `numpy.load` on `datasets/fly64/fly64_shuffled.npz`). |
| C2 | Implement `generate_dataset_for_dose(...)` orchestrating simulation → canonicalization → patch generation → split → validation with dependency injection for testability. | [ ] | Call `simulate_and_save.simulate_and_save`, `transpose_rename_convert`, `generate_patches`, `split_dataset`, and `validate_dataset_contract`. Ensure outputs land under `data/studies/fly64_dose_overlap/<dose>/` (train/test NPZ + intermediates) and validator runs on both train/test files (CONFIG-001 safe). Log steps to console and return paths for downstream phases. |
| C3 | Add CLI entry (`if __name__ == "__main__"` or `main()` function) to iterate over `StudyDesign.dose_list`, invoking `generate_dataset_for_dose` and writing run metadata (`run_manifest.json`) plus stdout log to `plans/active/.../reports/2025-11-04T032018Z/phase_c_dataset_generation/<dose>/dataset_generation.log`. | [ ] | Use `argparse` to allow overriding base dataset path/output root. Record artifact paths for fix_plan ledger. Ensure `AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md` when documenting invocation. |
| C4 | Author pytest module `tests/study/test_dose_overlap_generation.py` covering: (a) config construction (dose→nphotons, n_images matches base count, seeds propagate), and (b) pipeline wiring via monkeypatched stubs ensuring each stage called with expected arguments and validator invoked on outputs. Capture RED then GREEN logs. | [ ] | RED selector: `pytest tests/study/test_dose_overlap_generation.py -k generation_pipeline -vv` (fail on NotImplementedError). GREEN: same after implementation. Store logs under `reports/2025-11-04T032018Z/phase_c_dataset_generation/{red,green}/pytest.log`; collect-only run to `collect/pytest_collect.log`. |
| C5 | Documentation & ledger sync: update `implementation.md` Phase C section with workflow diagram + artifact paths, refresh `test_strategy.md` Phase C tests, write `summary.md` of dataset generation run (include photon stats, validator output), append Attempt entry to `docs/fix_plan.md`, and link new plan from Attempts History. | [ ] | Reference DATA-001, CONFIG-001, OVERSAMPLING-001 in summary. Note where generated NPZs reside and validator results. Update `docs/findings.md` only if new durable lesson emerges. |

