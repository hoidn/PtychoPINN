============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 3 items

tests/study/test_dose_overlap_generation.py::test_generate_dataset_pipeline_orchestration[1000.0] FAILED [ 33%]
tests/study/test_dose_overlap_generation.py::test_generate_dataset_pipeline_orchestration[10000.0] FAILED [ 66%]
tests/study/test_dose_overlap_generation.py::test_generate_dataset_pipeline_orchestration[100000.0] FAILED [100%]

=================================== FAILURES ===================================
_____________ test_generate_dataset_pipeline_orchestration[1000.0] _____________

mock_base_npz = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline0/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}
tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline0')
dose = 1000.0

    @pytest.mark.parametrize("dose", [1e3, 1e4, 1e5])
    def test_generate_dataset_pipeline_orchestration(mock_base_npz, design_params, tmp_path, dose):
        """
        Test that generate_dataset_for_dose invokes all stages in correct order
        with proper arguments, using monkeypatched stubs.
    
        This is the main RED→GREEN test for Phase C.
        """
        output_root = tmp_path / "output"
    
        # Create mock functions that track calls
        mock_simulate = Mock()
        mock_canonicalize = Mock()
        mock_patch_gen = Mock()
        mock_split = Mock()
        mock_validate = Mock()
    
        # Call the orchestration function with mocked dependencies
>       paths = generate_dataset_for_dose(
            dose=dose,
            base_npz_path=mock_base_npz,
            output_root=output_root,
            design_params=design_params,
            simulate_fn=mock_simulate,
            canonicalize_fn=mock_canonicalize,
            patch_gen_fn=mock_patch_gen,
            split_fn=mock_split,
            validate_fn=mock_validate,
        )

tests/study/test_dose_overlap_generation.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
studies/fly64_dose_overlap/generation.py:154: in generate_dataset_for_dose
    plan = build_simulation_plan(dose, base_npz_path, design_params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

dose = 1000.0
base_npz_path = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline0/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}

    def build_simulation_plan(
        dose: float,
        base_npz_path: Path,
        design_params: Dict[str, Any],
    ) -> SimulationPlan:
        """
        Construct TrainingConfig and ModelConfig for a single dose.
    
        Args:
            dose: Photon dose (nphotons per exposure)
            base_npz_path: Path to base dataset with object/probe
            design_params: StudyDesign parameters (as dict)
    
        Returns:
            SimulationPlan with dose-specific configs and derived counts
    
        References:
            - docs/GRIDSIZE_N_GROUPS_GUIDE.md:141-151 (spacing context)
            - specs/data_contracts.md:207 (canonical format requirements)
        """
        # Load base dataset to determine n_images
        with np.load(base_npz_path) as data:
            n_images = len(data['xcoords'])
    
        # Extract design constants
        simulation_seed = design_params['rng_seeds']['simulation']
        patch_size = design_params['patch_size_pixels']
    
        # Build configs (using gridsize=1 for initial simulation)
        # Grouping will happen in Phase D
>       training_config = TrainingConfig(
            train_data_file=str(base_npz_path),
            n_images=n_images,
            n_groups=n_images,  # gs=1 initially
            gridsize=1,
            nphotons=int(dose),
            # Use defaults for other params; they'll be overridden in phase E training
        )
E       TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'gridsize'

studies/fly64_dose_overlap/generation.py:80: TypeError
____________ test_generate_dataset_pipeline_orchestration[10000.0] _____________

mock_base_npz = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline1/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}
tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline1')
dose = 10000.0

    @pytest.mark.parametrize("dose", [1e3, 1e4, 1e5])
    def test_generate_dataset_pipeline_orchestration(mock_base_npz, design_params, tmp_path, dose):
        """
        Test that generate_dataset_for_dose invokes all stages in correct order
        with proper arguments, using monkeypatched stubs.
    
        This is the main RED→GREEN test for Phase C.
        """
        output_root = tmp_path / "output"
    
        # Create mock functions that track calls
        mock_simulate = Mock()
        mock_canonicalize = Mock()
        mock_patch_gen = Mock()
        mock_split = Mock()
        mock_validate = Mock()
    
        # Call the orchestration function with mocked dependencies
>       paths = generate_dataset_for_dose(
            dose=dose,
            base_npz_path=mock_base_npz,
            output_root=output_root,
            design_params=design_params,
            simulate_fn=mock_simulate,
            canonicalize_fn=mock_canonicalize,
            patch_gen_fn=mock_patch_gen,
            split_fn=mock_split,
            validate_fn=mock_validate,
        )

tests/study/test_dose_overlap_generation.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
studies/fly64_dose_overlap/generation.py:154: in generate_dataset_for_dose
    plan = build_simulation_plan(dose, base_npz_path, design_params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

dose = 10000.0
base_npz_path = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline1/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}

    def build_simulation_plan(
        dose: float,
        base_npz_path: Path,
        design_params: Dict[str, Any],
    ) -> SimulationPlan:
        """
        Construct TrainingConfig and ModelConfig for a single dose.
    
        Args:
            dose: Photon dose (nphotons per exposure)
            base_npz_path: Path to base dataset with object/probe
            design_params: StudyDesign parameters (as dict)
    
        Returns:
            SimulationPlan with dose-specific configs and derived counts
    
        References:
            - docs/GRIDSIZE_N_GROUPS_GUIDE.md:141-151 (spacing context)
            - specs/data_contracts.md:207 (canonical format requirements)
        """
        # Load base dataset to determine n_images
        with np.load(base_npz_path) as data:
            n_images = len(data['xcoords'])
    
        # Extract design constants
        simulation_seed = design_params['rng_seeds']['simulation']
        patch_size = design_params['patch_size_pixels']
    
        # Build configs (using gridsize=1 for initial simulation)
        # Grouping will happen in Phase D
>       training_config = TrainingConfig(
            train_data_file=str(base_npz_path),
            n_images=n_images,
            n_groups=n_images,  # gs=1 initially
            gridsize=1,
            nphotons=int(dose),
            # Use defaults for other params; they'll be overridden in phase E training
        )
E       TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'gridsize'

studies/fly64_dose_overlap/generation.py:80: TypeError
____________ test_generate_dataset_pipeline_orchestration[100000.0] ____________

mock_base_npz = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline2/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}
tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline2')
dose = 100000.0

    @pytest.mark.parametrize("dose", [1e3, 1e4, 1e5])
    def test_generate_dataset_pipeline_orchestration(mock_base_npz, design_params, tmp_path, dose):
        """
        Test that generate_dataset_for_dose invokes all stages in correct order
        with proper arguments, using monkeypatched stubs.
    
        This is the main RED→GREEN test for Phase C.
        """
        output_root = tmp_path / "output"
    
        # Create mock functions that track calls
        mock_simulate = Mock()
        mock_canonicalize = Mock()
        mock_patch_gen = Mock()
        mock_split = Mock()
        mock_validate = Mock()
    
        # Call the orchestration function with mocked dependencies
>       paths = generate_dataset_for_dose(
            dose=dose,
            base_npz_path=mock_base_npz,
            output_root=output_root,
            design_params=design_params,
            simulate_fn=mock_simulate,
            canonicalize_fn=mock_canonicalize,
            patch_gen_fn=mock_patch_gen,
            split_fn=mock_split,
            validate_fn=mock_validate,
        )

tests/study/test_dose_overlap_generation.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
studies/fly64_dose_overlap/generation.py:154: in generate_dataset_for_dose
    plan = build_simulation_plan(dose, base_npz_path, design_params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

dose = 100000.0
base_npz_path = PosixPath('/tmp/pytest-of-ollie/pytest-26/test_generate_dataset_pipeline2/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}

    def build_simulation_plan(
        dose: float,
        base_npz_path: Path,
        design_params: Dict[str, Any],
    ) -> SimulationPlan:
        """
        Construct TrainingConfig and ModelConfig for a single dose.
    
        Args:
            dose: Photon dose (nphotons per exposure)
            base_npz_path: Path to base dataset with object/probe
            design_params: StudyDesign parameters (as dict)
    
        Returns:
            SimulationPlan with dose-specific configs and derived counts
    
        References:
            - docs/GRIDSIZE_N_GROUPS_GUIDE.md:141-151 (spacing context)
            - specs/data_contracts.md:207 (canonical format requirements)
        """
        # Load base dataset to determine n_images
        with np.load(base_npz_path) as data:
            n_images = len(data['xcoords'])
    
        # Extract design constants
        simulation_seed = design_params['rng_seeds']['simulation']
        patch_size = design_params['patch_size_pixels']
    
        # Build configs (using gridsize=1 for initial simulation)
        # Grouping will happen in Phase D
>       training_config = TrainingConfig(
            train_data_file=str(base_npz_path),
            n_images=n_images,
            n_groups=n_images,  # gs=1 initially
            gridsize=1,
            nphotons=int(dose),
            # Use defaults for other params; they'll be overridden in phase E training
        )
E       TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'gridsize'

studies/fly64_dose_overlap/generation.py:80: TypeError
=========================== short test summary info ============================
FAILED tests/study/test_dose_overlap_generation.py::test_generate_dataset_pipeline_orchestration[1000.0] - TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'gridsize'
FAILED tests/study/test_dose_overlap_generation.py::test_generate_dataset_pipeline_orchestration[10000.0] - TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'gridsize'
FAILED tests/study/test_dose_overlap_generation.py::test_generate_dataset_pipeline_orchestration[100000.0] - TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'gridsize'
============================== 3 failed in 4.10s ===============================
