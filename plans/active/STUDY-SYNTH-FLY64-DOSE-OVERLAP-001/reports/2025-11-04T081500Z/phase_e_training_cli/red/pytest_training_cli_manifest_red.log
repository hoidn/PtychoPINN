============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_dose_overlap_training.py::test_training_cli_manifest_and_bridging FAILED [100%]

=================================== FAILURES ===================================
___________________ test_training_cli_manifest_and_bridging ____________________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-58/test_training_cli_manifest_and0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x747d6af8a2d0>

    def test_training_cli_manifest_and_bridging(tmp_path, monkeypatch):
        """
        RED â†’ GREEN TDD test for training CLI manifest emission and CONFIG-001 bridging.
    
        Validates that the training CLI main() function:
        - Emits a training_manifest.json file under --artifact-root
        - Manifest contains job metadata (dose, view, gridsize, dataset paths, log paths)
        - Ensures run_training_job is called with proper CONFIG-001 bridge
        - Writes CLI stdout/stderr log to --artifact-root for traceability
    
        Test strategy: Mock run_training_job to verify it's called (CONFIG-001 handled internally),
        execute CLI with --dry-run, validate manifest JSON structure and content.
    
        References:
        - input.md:10 (manifest emission requirement for Phase E4)
        - plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md:84-115
        """
        import sys
        import json
        from studies.fly64_dose_overlap import training
    
        # Setup: Create mock Phase C and Phase D directories
        phase_c_root = tmp_path / "phase_c"
        phase_d_root = tmp_path / "phase_d"
        artifact_root = tmp_path / "artifacts"
    
        phase_c_root.mkdir()
        phase_d_root.mkdir()
    
        # Create minimal dataset structure (only dose=1000 for simplicity)
        dose_dir_c = phase_c_root / "dose_1000"
        dose_dir_d = phase_d_root / "dose_1000"
        dose_dir_c.mkdir()
        dose_dir_d.mkdir()
    
        (dose_dir_c / "patched_train.npz").touch()
        (dose_dir_c / "patched_test.npz").touch()
        (dose_dir_d / "dense_train.npz").touch()
        (dose_dir_d / "dense_test.npz").touch()
        (dose_dir_d / "sparse_train.npz").touch()
        (dose_dir_d / "sparse_test.npz").touch()
    
        # Spy: Track run_training_job calls
        run_calls = []
    
        def mock_run_training_job(job, runner, dry_run=False):
            run_calls.append({
                'dose': job.dose,
                'view': job.view,
                'gridsize': job.gridsize,
            })
            return {'status': 'mock_success'}
    
        monkeypatch.setattr(training, 'run_training_job', mock_run_training_job)
    
        # Execute CLI with dose filter to reduce output
        test_argv = [
            'training.py',
            '--phase-c-root', str(phase_c_root),
            '--phase-d-root', str(phase_d_root),
            '--artifact-root', str(artifact_root),
            '--dose', '1000',
            '--dry-run',
        ]
        monkeypatch.setattr(sys, 'argv', test_argv)
    
>       training.main()
        ^^^^^^^^^^^^^
E       AttributeError: module 'studies.fly64_dose_overlap.training' has no attribute 'main'

tests/study/test_dose_overlap_training.py:644: AttributeError
=========================== short test summary info ============================
FAILED tests/study/test_dose_overlap_training.py::test_training_cli_manifest_and_bridging - AttributeError: module 'studies.fly64_dose_overlap.training' has no attribute 'main'
============================== 1 failed in 3.11s ===============================
