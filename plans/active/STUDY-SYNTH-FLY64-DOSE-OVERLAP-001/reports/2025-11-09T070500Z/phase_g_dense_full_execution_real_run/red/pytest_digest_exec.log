============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_phase_g_dense_orchestrator.py::test_run_phase_g_dense_exec_runs_analyze_digest FAILED [100%]

=================================== FAILURES ===================================
_______________ test_run_phase_g_dense_exec_runs_analyze_digest ________________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7261311c4c10>

    def test_run_phase_g_dense_exec_runs_analyze_digest(tmp_path: Path, monkeypatch: pytest.MonkeyPatch) -> None:
        """
        Test that main() in real execution mode invokes analyze_dense_metrics.py after reporting helper.
    
        Acceptance:
        - Loads main() from orchestrator script via importlib
        - Stubs prepare_hub, validate_phase_c_metadata, summarize_phase_g_outputs (no-op for speed)
        - Monkeypatches run_command to record invocations and create required files
        - Runs main() without --collect-only to trigger real execution path
        - Asserts analyze_dense_metrics.py is invoked after report_phase_g_dense_metrics.py
        - Validates analyze command includes --metrics, --highlights, --output flags
        - Validates log_path points to cli/metrics_digest_cli.log
        - Ensures AUTHORITATIVE_CMDS_DOC environment variable is respected
        - Returns 0 exit code on success
    
        Follows TYPE-PATH-001 (Path normalization).
        """
        # Import main() and helper functions from orchestrator
        module = _import_orchestrator_module()
        main = module.main
    
        # Setup: Create tmp hub directory
        hub = tmp_path / "exec_hub"
        hub.mkdir(parents=True)
    
        # Create expected directory structure for Phase C→G
        phase_c_root = hub / "data" / "phase_c"
        phase_c_root.mkdir(parents=True)
        cli_log_dir = hub / "cli"
        cli_log_dir.mkdir(parents=True)
        phase_g_root = hub / "analysis"
        phase_g_root.mkdir(parents=True)
    
        # Set AUTHORITATIVE_CMDS_DOC to satisfy orchestrator env check
        monkeypatch.setenv("AUTHORITATIVE_CMDS_DOC", "./docs/TESTING_GUIDE.md")
    
        # Prepare sys.argv for argparse (NO --collect-only, so real execution)
        monkeypatch.setattr(
            sys,
            "argv",
            [
                "run_phase_g_dense.py",
                "--hub", str(hub),
                "--dose", "1000",
                "--view", "dense",
                "--splits", "train", "test",
                "--clobber",  # Required to pass prepare_hub check
            ],
        )
    
        # Stub heavy helpers to no-op (we only care about run_command invocations)
        def stub_prepare_hub(hub_path, clobber):
            """No-op stub for prepare_hub."""
            pass
    
        def stub_validate_phase_c_metadata(hub_path):
            """No-op stub for validate_phase_c_metadata."""
            pass
    
        def stub_summarize_phase_g_outputs(hub_path):
            """No-op stub for summarize_phase_g_outputs."""
            pass
    
        monkeypatch.setattr(module, "prepare_hub", stub_prepare_hub)
        monkeypatch.setattr(module, "validate_phase_c_metadata", stub_validate_phase_c_metadata)
        monkeypatch.setattr(module, "summarize_phase_g_outputs", stub_summarize_phase_g_outputs)
    
        # Record run_command invocations
        run_command_calls = []
    
        def stub_run_command(cmd, log_path):
            """Record cmd and log_path, create required files for orchestrator progression."""
            run_command_calls.append((cmd, log_path))
            cmd_str = " ".join(str(c) for c in cmd)
    
            # When reporting helper is invoked, create highlights file
            if "report_phase_g_dense_metrics.py" in cmd_str and "--highlights" in cmd_str:
                for i, part in enumerate(cmd):
                    if str(part) == "--highlights" and i + 1 < len(cmd):
                        highlights_path = Path(cmd[i + 1])
                        highlights_path.parent.mkdir(parents=True, exist_ok=True)
                        highlights_path.write_text("MS-SSIM Deltas (PtychoPINN - Baseline):\n  Amplitude (mean): +0.050\n", encoding="utf-8")
                        break
    
            # When analyze digest is invoked, create digest file
            if "analyze_dense_metrics.py" in cmd_str and "--output" in cmd_str:
                for i, part in enumerate(cmd):
                    if str(part) == "--output" and i + 1 < len(cmd):
                        digest_path = Path(cmd[i + 1])
                        digest_path.parent.mkdir(parents=True, exist_ok=True)
                        digest_path.write_text("# Phase G Dense Metrics Digest\n", encoding="utf-8")
                        break
    
        monkeypatch.setattr(module, "run_command", stub_run_command)
    
        # Execute: Call main() with stdout capture (should execute Phase C→G pipeline + reporting helper + analyze digest)
        import io
        import contextlib
    
        stdout_buffer = io.StringIO()
        with contextlib.redirect_stdout(stdout_buffer):
            exit_code = main()
    
        stdout = stdout_buffer.getvalue()
    
        # Assert: Exit code should be 0
        assert exit_code == 0, f"Expected exit code 0 from real execution mode, got {exit_code}"
    
        # Assert: run_command should have been called for all phases + reporting helper + analyze digest
        # Expected: 1 Phase C + 1 Phase D + 2 Phase E (baseline gs1 + dense gs2) + 2 Phase F (train/test) + 2 Phase G (train/test) + 1 reporting helper + 1 analyze digest = 10 total
        assert len(run_command_calls) >= 10, f"Expected at least 10 run_command calls (C/D/E/F/G phases + reporting + analyze), got {len(run_command_calls)}"
    
        # Find reporting helper and analyze digest calls
        reporting_helper_idx = None
        analyze_digest_idx = None
    
        for idx, (cmd, log_path) in enumerate(run_command_calls):
            cmd_str = " ".join(str(c) for c in cmd)
            if "report_phase_g_dense_metrics.py" in cmd_str:
                reporting_helper_idx = idx
            if "analyze_dense_metrics.py" in cmd_str:
                analyze_digest_idx = idx
    
        # Assert: Both helpers should be invoked
        assert reporting_helper_idx is not None, "reporting helper (report_phase_g_dense_metrics.py) was not invoked"
        assert analyze_digest_idx is not None, "analyze digest (analyze_dense_metrics.py) was not invoked"
    
        # Assert: analyze_dense_metrics.py should be invoked AFTER report_phase_g_dense_metrics.py
        assert analyze_digest_idx > reporting_helper_idx, \
            f"analyze_dense_metrics.py should be invoked after report_phase_g_dense_metrics.py, but got order: reporting={reporting_helper_idx}, analyze={analyze_digest_idx}"
    
        # Validate analyze digest command
        analyze_cmd, analyze_log_path = run_command_calls[analyze_digest_idx]
        analyze_cmd_str = " ".join(str(c) for c in analyze_cmd)
    
        assert "analyze_dense_metrics.py" in analyze_cmd_str, \
            f"Expected analyze_dense_metrics.py in command, got: {analyze_cmd_str}"
        assert "--metrics" in analyze_cmd_str, f"Missing --metrics flag in analyze command: {analyze_cmd_str}"
        assert "metrics_summary.json" in analyze_cmd_str, f"Missing metrics_summary.json in analyze command: {analyze_cmd_str}"
        assert "--highlights" in analyze_cmd_str, f"Missing --highlights flag in analyze command: {analyze_cmd_str}"
        assert "aggregate_highlights.txt" in analyze_cmd_str, f"Missing aggregate_highlights.txt in analyze command: {analyze_cmd_str}"
        assert "--output" in analyze_cmd_str, f"Missing --output flag in analyze command: {analyze_cmd_str}"
        assert "metrics_digest.md" in analyze_cmd_str, f"Missing metrics_digest.md in analyze command: {analyze_cmd_str}"
    
        # Validate log_path points to cli/metrics_digest_cli.log
        assert "metrics_digest_cli.log" in str(analyze_log_path), \
            f"Expected analyze digest log path to be cli/metrics_digest_cli.log, got: {analyze_log_path}"
    
        # Assert: Success banner should include metrics digest paths (TYPE-PATH-001)
>       assert "Metrics digest (Markdown):" in stdout, \
            f"Expected success banner to include 'Metrics digest (Markdown):' line, got:\n{stdout}"
E       AssertionError: Expected success banner to include 'Metrics digest (Markdown):' line, got:
E         
E         ================================================================================
E         [run_phase_g_dense] Preparing hub...
E         ================================================================================
E         
E         
E         [run_phase_g_dense] Starting Phase C→G pipeline for dose=1000, view=dense, splits=['train', 'test']
E         [run_phase_g_dense] Hub: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub
E         [run_phase_g_dense] Total commands: 8
E         
E         
E         ================================================================================
E         [1/8] Phase C: Dataset Generation
E         ================================================================================
E         
E         
E         ================================================================================
E         [run_phase_g_dense] Validating Phase C metadata...
E         ================================================================================
E         
E         
E         ================================================================================
E         [2/8] Phase D: Overlap View Generation
E         ================================================================================
E         
E         
E         ================================================================================
E         [3/8] Phase E: Training Baseline (gs1)
E         ================================================================================
E         
E         
E         ================================================================================
E         [4/8] Phase E: Training Dense (gs2)
E         ================================================================================
E         
E         
E         ================================================================================
E         [5/8] Phase F: Reconstruction dense/train
E         ================================================================================
E         
E         
E         ================================================================================
E         [6/8] Phase F: Reconstruction dense/test
E         ================================================================================
E         
E         
E         ================================================================================
E         [7/8] Phase G: Comparison dense/train
E         ================================================================================
E         
E         
E         ================================================================================
E         [8/8] Phase G: Comparison dense/test
E         ================================================================================
E         
E         
E         ================================================================================
E         [run_phase_g_dense] SUCCESS: All phases completed
E         ================================================================================
E         
E         ================================================================================
E         [run_phase_g_dense] Summarizing Phase G metrics...
E         ================================================================================
E         
E         
E         ================================================================================
E         [run_phase_g_dense] Generating aggregate metrics report...
E         ================================================================================
E         
E         
E         ================================================================================
E         [run_phase_g_dense] Aggregate highlights preview
E         ================================================================================
E         
E         MS-SSIM Deltas (PtychoPINN - Baseline):
E           Amplitude (mean): +0.050
E         
E         ================================================================================
E         
E         
E         ================================================================================
E         [run_phase_g_dense] Generating metrics digest...
E         ================================================================================
E         
E         
E         Artifacts saved to: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub
E         CLI logs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/cli
E         Analysis outputs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis
E         Aggregate report: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_report.md
E         Highlights: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_highlights.txt
E         Metrics digest: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/metrics_digest.md
E         
E       assert 'Metrics digest (Markdown):' in "\n================================================================================\n[run_phase_g_dense] Preparing hub...\n================================================================================\n\n\n[run_phase_g_dense] Starting Phase C\u2192G pipeline for dose=1000, view=dense, splits=['train', 'test']\n[run_phase_g_dense] Hub: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub\n[run_phase_g_dense] Total commands: 8\n\n\n================================================================================\n[1/8] Phase C: Dataset Generation\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Validating Phase C metadata...\n================================================================================\n\n\n================================================================================\n[2/8] Phase D: Overlap View Generation\n================================================================================\n\n\n================================================================================\n[3/8] Phase E: Training Baseline (gs1)\n================================================================================\n\n\n================================================================================\n[4/8] Phase E: Training Dense (gs2)\n================================================================================\n\n\n================================================================================\n[5/8] Phase F: Reconstruction dense/train\n================================================================================\n\n\n================================================================================\n[6/8] Phase F: Reconstruction dense/test\n================================================================================\n\n\n================================================================================\n[7/8] Phase G: Comparison dense/train\n================================================================================\n\n\n================================================================================\n[8/8] Phase G: Comparison dense/test\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] SUCCESS: All phases completed\n================================================================================\n\n================================================================================\n[run_phase_g_dense] Summarizing Phase G metrics...\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Generating aggregate metrics report...\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Aggregate highlights preview\n================================================================================\n\nMS-SSIM Deltas (PtychoPINN - Baseline):\n  Amplitude (mean): +0.050\n\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Generating metrics digest...\n================================================================================\n\n\nArtifacts saved to: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub\nCLI logs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/cli\nAnalysis outputs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis\nAggregate report: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_report.md\nHighlights: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_highlights.txt\nMetrics digest: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/metrics_digest.md\n"

tests/study/test_phase_g_dense_orchestrator.py:1005: AssertionError
=========================== short test summary info ============================
FAILED tests/study/test_phase_g_dense_orchestrator.py::test_run_phase_g_dense_exec_runs_analyze_digest - AssertionError: Expected success banner to include 'Metrics digest (Markdown):' line, got:
  
  ================================================================================
  [run_phase_g_dense] Preparing hub...
  ================================================================================
  
  
  [run_phase_g_dense] Starting Phase C→G pipeline for dose=1000, view=dense, splits=['train', 'test']
  [run_phase_g_dense] Hub: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub
  [run_phase_g_dense] Total commands: 8
  
  
  ================================================================================
  [1/8] Phase C: Dataset Generation
  ================================================================================
  
  
  ================================================================================
  [run_phase_g_dense] Validating Phase C metadata...
  ================================================================================
  
  
  ================================================================================
  [2/8] Phase D: Overlap View Generation
  ================================================================================
  
  
  ================================================================================
  [3/8] Phase E: Training Baseline (gs1)
  ================================================================================
  
  
  ================================================================================
  [4/8] Phase E: Training Dense (gs2)
  ================================================================================
  
  
  ================================================================================
  [5/8] Phase F: Reconstruction dense/train
  ================================================================================
  
  
  ================================================================================
  [6/8] Phase F: Reconstruction dense/test
  ================================================================================
  
  
  ================================================================================
  [7/8] Phase G: Comparison dense/train
  ================================================================================
  
  
  ================================================================================
  [8/8] Phase G: Comparison dense/test
  ================================================================================
  
  
  ================================================================================
  [run_phase_g_dense] SUCCESS: All phases completed
  ================================================================================
  
  ================================================================================
  [run_phase_g_dense] Summarizing Phase G metrics...
  ================================================================================
  
  
  ================================================================================
  [run_phase_g_dense] Generating aggregate metrics report...
  ================================================================================
  
  
  ================================================================================
  [run_phase_g_dense] Aggregate highlights preview
  ================================================================================
  
  MS-SSIM Deltas (PtychoPINN - Baseline):
    Amplitude (mean): +0.050
  
  ================================================================================
  
  
  ================================================================================
  [run_phase_g_dense] Generating metrics digest...
  ================================================================================
  
  
  Artifacts saved to: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub
  CLI logs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/cli
  Analysis outputs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis
  Aggregate report: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_report.md
  Highlights: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_highlights.txt
  Metrics digest: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/metrics_digest.md
  
assert 'Metrics digest (Markdown):' in "\n================================================================================\n[run_phase_g_dense] Preparing hub...\n================================================================================\n\n\n[run_phase_g_dense] Starting Phase C\u2192G pipeline for dose=1000, view=dense, splits=['train', 'test']\n[run_phase_g_dense] Hub: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub\n[run_phase_g_dense] Total commands: 8\n\n\n================================================================================\n[1/8] Phase C: Dataset Generation\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Validating Phase C metadata...\n================================================================================\n\n\n================================================================================\n[2/8] Phase D: Overlap View Generation\n================================================================================\n\n\n================================================================================\n[3/8] Phase E: Training Baseline (gs1)\n================================================================================\n\n\n================================================================================\n[4/8] Phase E: Training Dense (gs2)\n================================================================================\n\n\n================================================================================\n[5/8] Phase F: Reconstruction dense/train\n================================================================================\n\n\n================================================================================\n[6/8] Phase F: Reconstruction dense/test\n================================================================================\n\n\n================================================================================\n[7/8] Phase G: Comparison dense/train\n================================================================================\n\n\n================================================================================\n[8/8] Phase G: Comparison dense/test\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] SUCCESS: All phases completed\n================================================================================\n\n================================================================================\n[run_phase_g_dense] Summarizing Phase G metrics...\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Generating aggregate metrics report...\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Aggregate highlights preview\n================================================================================\n\nMS-SSIM Deltas (PtychoPINN - Baseline):\n  Amplitude (mean): +0.050\n\n================================================================================\n\n\n================================================================================\n[run_phase_g_dense] Generating metrics digest...\n================================================================================\n\n\nArtifacts saved to: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub\nCLI logs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/cli\nAnalysis outputs: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis\nAggregate report: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_report.md\nHighlights: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/aggregate_highlights.txt\nMetrics digest: /tmp/pytest-of-ollie/pytest-402/test_run_phase_g_dense_exec_ru0/exec_hub/analysis/metrics_digest.md\n"
============================== 1 failed in 2.34s ===============================
