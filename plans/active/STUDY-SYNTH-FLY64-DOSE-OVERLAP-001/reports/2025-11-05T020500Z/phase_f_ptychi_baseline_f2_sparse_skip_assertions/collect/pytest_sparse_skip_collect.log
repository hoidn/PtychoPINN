============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

<Dir PtychoPINN2>
  <Package tests>
    <Package study>
      <Module test_dose_overlap_reconstruction.py>
        Tests for Phase F pty-chi LSQML reconstruction job builder.
        
        Validates that build_ptychi_jobs() correctly constructs a manifest with:
        - 3 doses × 3 views (baseline, dense, sparse) × 2 splits = 18 jobs total
        - CLI arguments for scripts/reconstruction/ptychi_reconstruct_tike.py
        - DATA-001 compliant NPZ path validation
        
        Test tier: Unit
        Test strategy: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md
        <Function test_cli_skips_missing_phase_d>
          RED→GREEN test: CLI skips missing Phase D NPZs with --allow-missing-phase-d.
          
          Phase F2 sparse view handling:
          - When sparse view NPZs are missing from Phase D (e.g., rejected by spacing threshold)
          - And --allow-missing-phase-d flag is set
          - Then builder should skip missing jobs and record skip metadata
          - Manifest should include skip events with reasons (e.g., "Phase D NPZ not found")
          - Skip summary should document missing views
          
          Test strategy:
          1. Create Phase C baseline datasets (all doses/splits present)
          2. Create Phase D datasets WITH ONLY dense views (sparse views deliberately omitted)
          3. Run CLI with --allow-missing-phase-d flag
          4. Assert manifest contains skip metadata for missing sparse views
          5. Assert skip summary documents missing Phase D files
          
          Expected skip events (with sparse views missing):
          - 3 doses × 1 view (sparse) × 2 splits = 6 missing jobs
          - Skip reason: "Phase D NPZ not found: <path>" (or similar)
          
          Findings alignment:
          - CONFIG-001: Builder stays pure; skip metadata collected without params.cfg mutation
          - DATA-001: Validate present NPZs against canonical contract
          - OVERSAMPLING-001: Skip reasoning should reference spacing guard when applicable

========================== 1 test collected in 0.83s ===========================
