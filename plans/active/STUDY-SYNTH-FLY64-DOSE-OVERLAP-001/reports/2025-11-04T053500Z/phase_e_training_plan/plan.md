# Phase E Plan — Train PtychoPINN

## Context
- **Initiative:** STUDY-SYNTH-FLY64-DOSE-OVERLAP-001
- **Phase Goal:** Produce PtychoPINN training runs for the fly64 dose/overlap study across dense/sparse views and gridsize variants (gs1 baseline, gs2 grouped) with reproducible configs, logs, and checkpoints suitable for Phase G comparisons.
- **Dependencies:** Phase C datasets (`studies/fly64_dose_overlap/generation.py`, outputs per dose), Phase D overlap views (`studies/fly64_dose_overlap/overlap.py` metrics bundle + filtered NPZs), StudyDesign constants (`studies/fly64_dose_overlap/design.py`), DATA-001 validator (`studies/fly64_dose_overlap/validation.py`), CONFIG-001 bridge rules (`docs/DEVELOPER_GUIDE.md:68-74`), and test infrastructure guidance in `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md`.

### Phase E — Train PtychoPINN
Goal: Orchestrate deterministic training jobs for each dose/view + gridsize combination, capture configs/checkpoints/logs, and provide automated validation hooks.
Prereqs: Phase D artifact hubs populated with dense/sparse NPZs, y-axis split validated, metrics bundle available per dose, and Phase C baseline train/test NPZs accessible.
Exit Criteria: Training job matrix documented and codified, unit tests covering job enumeration + config wiring, CLI entry capable of launching jobs (with artifact-root logging), dry-run verification for all combinations, and at least one successful training run log captured under this initiative's reports.

| ID | Task Description | State | How/Why & Guidance (API/doc/artifact/source refs) |
| --- | --- | --- | --- |
| E1 | Finalize Phase E test design in `test_strategy.md` (outline selectors, fixtures, and RED→GREEN expectations for training orchestration tests). | [x] | Completed during Attempt #13: test_strategy.md updated with job matrix selector + collection proof requirements before RED test landed. |
| E2 | Implement `studies/fly64_dose_overlap/training.py` with a `TrainingJob` dataclass and `build_training_jobs(phase_c_root, phase_d_root, design)` creating job definitions for: (a) gs1 baseline (Phase C train/test NPZs) and (b) gs2 dense/sparse overlap outputs (Phase D). | [x] | Completed during Attempt #13: TrainingJob dataclass + builder ship with DATA-001 existence checks, deterministic artifact/log paths, consistent with StudyDesign spacing guidance. |
| E3 | Add `run_training_job(job, *, runner=None)` helper invoking `ptycho_train` (or injected callable) with proper config bridging (`update_legacy_dict(params.cfg, config)`) and logging to `<artifact_root>/phase_e_training/<dose>/<view>/<gridsize>/train.log`. Surface dry-run option that prints planned commands without execution. | [P] | Use dependency injection so tests can pass a stub runner. Ensure logs capture StudyDesign metadata, dataset paths, and metrics bundle references. Reference `docs/DEVELOPER_GUIDE.md:68-104` for bridge ordering and `docs/TESTING_GUIDE.md:28-46` for authoritative training commands. Capture RED→GREEN evidence for new tests guarding runner invocation and log creation. |
| E4 | Provide CLI `python -m studies.fly64_dose_overlap.training` supporting job selection (`--dose`, `--view`, `--gridsize`), dry-run flag, and artifact-root handling. Emit `training_manifest.json` summarizing runs and update docs/fix_plan.md with captured evidence. | [ ] | Mirror CLI style from Phase C/D modules (argparse, stdout logging). Store artifacts under `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/<timestamp>/phase_e_training_run/`. Document invocation in summary.md and reference metrics bundle (for grouped runs) to reinforce DATA-001/CONFIG-001 compliance. |
