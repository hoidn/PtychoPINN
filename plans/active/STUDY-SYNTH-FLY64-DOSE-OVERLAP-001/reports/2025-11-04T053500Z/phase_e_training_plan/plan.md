# Phase E Plan — Train PtychoPINN

## Context
- **Initiative:** STUDY-SYNTH-FLY64-DOSE-OVERLAP-001
- **Phase Goal:** Produce PtychoPINN training runs for the fly64 dose/overlap study across dense/sparse views and gridsize variants (gs1 baseline, gs2 grouped) with reproducible configs, logs, and checkpoints suitable for Phase G comparisons.
- **Dependencies:** Phase C datasets (`studies/fly64_dose_overlap/generation.py`, outputs per dose), Phase D overlap views (`studies/fly64_dose_overlap/overlap.py` metrics bundle + filtered NPZs), StudyDesign constants (`studies/fly64_dose_overlap/design.py`), DATA-001 validator (`studies/fly64_dose_overlap/validation.py`), CONFIG-001 bridge rules (`docs/DEVELOPER_GUIDE.md:68-74`), and test infrastructure guidance in `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md`.

### Phase E — Train PtychoPINN
Goal: Orchestrate deterministic training jobs for each dose/view + gridsize combination, capture configs/checkpoints/logs, and provide automated validation hooks.
Prereqs: Phase D artifact hubs populated with dense/sparse NPZs, y-axis split validated, metrics bundle available per dose, and Phase C baseline train/test NPZs accessible.
Exit Criteria: Training job matrix documented and codified, unit tests covering job enumeration + config wiring, CLI entry capable of launching jobs (with artifact-root logging), dry-run verification for all combinations, and at least one successful training run log captured under this initiative's reports.

| ID | Task Description | State | How/Why & Guidance (API/doc/artifact/source refs) |
| --- | --- | --- | --- |
| E1 | Finalize Phase E test design in `test_strategy.md` (outline selectors, fixtures, and RED→GREEN expectations for training orchestration tests). | [x] | Completed during Attempt #13: test_strategy.md updated with job matrix selector + collection proof requirements before RED test landed. |
| E2 | Implement `studies/fly64_dose_overlap/training.py` with a `TrainingJob` dataclass and `build_training_jobs(phase_c_root, phase_d_root, design)` creating job definitions for: (a) gs1 baseline (Phase C train/test NPZs) and (b) gs2 dense/sparse overlap outputs (Phase D). | [x] | Completed during Attempt #13: TrainingJob dataclass + builder ship with DATA-001 existence checks, deterministic artifact/log paths, consistent with StudyDesign spacing guidance. |
| E3 | Add `run_training_job(job, *, runner=None)` helper invoking `ptycho_train` (or injected callable) with proper config bridging (`update_legacy_dict(params.cfg, config)`) and logging to `<artifact_root>/phase_e_training/<dose>/<view>/<gridsize>/train.log`. Surface dry-run option that prints planned commands without execution. | [x] | ✅ Attempt #14 (`reports/2025-11-04T070000Z/phase_e_training_e2/`) delivered run helper with stubbed runner support, log initialization, and dry-run preview artifacts. Follow-up: upgrade placeholder dict config to `TrainingConfig` + `update_legacy_dict` during E4 CLI wiring. |
| E4 | Provide CLI `python -m studies.fly64_dose_overlap.training` supporting job selection (`--dose`, `--view`, `--gridsize`), dry-run flag, and artifact-root handling. Emit `training_manifest.json` summarizing runs and update docs/fix_plan.md with captured evidence. | [x] | ✅ Attempt #16 (artifact hub `reports/2025-11-04T081500Z/phase_e_training_cli/`) shipped RED→GREEN tests plus CLI implementation: tightened `run_training_job` to construct `TrainingConfig`/`ModelConfig` and call `update_legacy_dict` (CONFIG-001), added argparse entrypoint with filters + dry-run, emitted `training_manifest.json`, and captured CLI dry-run transcript. Documentation + registries updated (test_strategy.md, docs/TESTING_GUIDE.md, TEST_SUITE_INDEX.md). Next focus: replace stub runner with real training orchestration + capture first deterministic run (new E5 task). |
| E5 | Replace stub CLI runner with production training orchestration and capture first deterministic study run. | [P] | Pending. Tasks: (1) implement `studies/fly64_dose_overlap/training.py::execute_training_job` (or equivalent helper) that consumes `TrainingConfig`, loads Phase C/D NPZs via `load_training_data` / PyTorch workflow components, and invokes backend training (`train_cdi_model_torch` or `ptycho_train`) with CONFIG-001 + POLICY-001 compliance; (2) update `main()` to use the real runner (allow monkeypatch for tests) and persist training outputs (logs/checkpoints/manifest augmentations); (3) extend tests (`test_training_cli_*`) to assert actual runner wiring and log/manifest updates; (4) run one deterministic job (dose=1e3 baseline gs1) writing evidence under `reports/<timestamp>/phase_e_training_real_run/` with CLI stdout and manifest diff. Reference `docs/workflows/pytorch.md` §12, `docs/pytorch_runtime_checklist.md`, `plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md` Phase E section, and CONFIG-001/OVERSAMPLING-001 findings. |
