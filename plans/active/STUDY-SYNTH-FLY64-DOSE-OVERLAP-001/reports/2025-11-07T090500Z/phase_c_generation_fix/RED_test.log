============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_dose_overlap_generation.py::test_generate_dataset_config_construction FAILED [100%]

=================================== FAILURES ===================================
__________________ test_generate_dataset_config_construction ___________________

mock_base_npz = PosixPath('/tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/base.npz')
design_params = {'dose_list': [1000.0, 10000.0, 100000.0], 'gridsizes': [1, 2], 'metrics_config': {'emphasize_phase': True, 'frc_threshold': 0.5, 'ms_ssim_sigma': 1.0, 'report_amplitude': True}, 'neighbor_count': 7, ...}
tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0')

    def test_generate_dataset_config_construction(mock_base_npz, design_params, tmp_path):
        """Test that TrainingConfig is correctly constructed for simulation."""
        dose = 1e4
        output_root = tmp_path / "output"
    
        # Mock only validate to let config construction run
        mock_validate = Mock()
    
        # Create a mock simulate that captures the config
        captured_config = None
        def capture_simulate(config, **kwargs):
            nonlocal captured_config
            captured_config = config
    
        mock_simulate = Mock(side_effect=capture_simulate)
        mock_canonicalize = Mock()
        mock_patch_gen = Mock()
        mock_split = Mock()
    
        generate_dataset_for_dose(
            dose=dose,
            base_npz_path=mock_base_npz,
            output_root=output_root,
            design_params=design_params,
            simulate_fn=mock_simulate,
            canonicalize_fn=mock_canonicalize,
            patch_gen_fn=mock_patch_gen,
            split_fn=mock_split,
            validate_fn=mock_validate,
        )
    
        # Verify config was captured and has correct values
        assert captured_config is not None
        assert captured_config.nphotons == int(dose)
        assert captured_config.n_groups == 100  # from mock_base_npz
        assert captured_config.model.gridsize == 1
        # Verify n_images is set (required for legacy simulator coordinate arrays)
>       assert captured_config.n_images == 100  # must match base dataset length
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert None == 100
E        +  where None = TrainingConfig(model=ModelConfig(N=128, gridsize=1, n_filters_scale=2, model_type='pinn', amp_activation='sigmoid', object_big=True, probe_big=True, probe_mask=False, pad_object=True, probe_scale=4.0, gaussian_smoothing_sigma=0.0), train_data_file='/tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/base.npz', test_data_file=None, batch_size=16, nepochs=50, mae_weight=0.0, nll_weight=1.0, realspace_mae_weight=0.0, realspace_weight=0.0, nphotons=10000, n_groups=100, n_images=None, n_subsample=None, subsample_seed=None, neighbor_count=4, positions_provided=True, probe_trainable=False, intensity_scale_trainable=True, output_dir=PosixPath('training_outputs'), sequential_sampling=False, backend='tensorflow').n_images

tests/study/test_dose_overlap_generation.py:181: AssertionError
----------------------------- Captured stdout call -----------------------------

============================================================
Generating dataset for dose=1e+04 photons
Output directory: /tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/output/dose_10000
============================================================

[Stage 1/5] Simulating diffraction patterns...
  ✓ Simulation complete: /tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/output/dose_10000/simulated_raw.npz

[Stage 2/5] Canonicalizing to DATA-001 format...
  ✓ Canonicalization complete: /tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/output/dose_10000/canonical.npz

[Stage 3/5] Generating Y patches...
  ✓ Patch generation complete: /tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/output/dose_10000/patched.npz

[Stage 4/5] Splitting train/test on y-axis...
  ✓ Split complete:
    Train: /tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/output/dose_10000/patched_train.npz
    Test:  /tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/output/dose_10000/patched_test.npz

[Stage 5/5] Validating DATA-001 compliance...
  Validating train...
    ✓ train validation passed
  Validating test...
    ✓ test validation passed

============================================================
Dataset generation complete for dose=1e+04
============================================================

=========================== short test summary info ============================
FAILED tests/study/test_dose_overlap_generation.py::test_generate_dataset_config_construction - AssertionError: assert None == 100
 +  where None = TrainingConfig(model=ModelConfig(N=128, gridsize=1, n_filters_scale=2, model_type='pinn', amp_activation='sigmoid', object_big=True, probe_big=True, probe_mask=False, pad_object=True, probe_scale=4.0, gaussian_smoothing_sigma=0.0), train_data_file='/tmp/pytest-of-ollie/pytest-283/test_generate_dataset_config_c0/base.npz', test_data_file=None, batch_size=16, nepochs=50, mae_weight=0.0, nll_weight=1.0, realspace_mae_weight=0.0, realspace_weight=0.0, nphotons=10000, n_groups=100, n_images=None, n_subsample=None, subsample_seed=None, neighbor_count=4, positions_provided=True, probe_trainable=False, intensity_scale_trainable=True, output_dir=PosixPath('training_outputs'), sequential_sampling=False, backend='tensorflow').n_images
============================== 1 failed in 4.04s ===============================
