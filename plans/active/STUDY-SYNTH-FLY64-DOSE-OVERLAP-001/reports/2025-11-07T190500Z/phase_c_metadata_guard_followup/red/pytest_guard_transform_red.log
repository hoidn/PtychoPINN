============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_phase_g_dense_orchestrator.py::test_validate_phase_c_metadata_requires_canonical_transform FAILED [100%]

=================================== FAILURES ===================================
_________ test_validate_phase_c_metadata_requires_canonical_transform __________

tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-307/test_validate_phase_c_metadata0')

    def test_validate_phase_c_metadata_requires_canonical_transform(tmp_path: Path) -> None:
        """
        Test that validate_phase_c_metadata() raises RuntimeError when Phase C NPZ outputs have _metadata but missing transpose_rename_convert transformation.
    
        Acceptance:
        - Normalizes hub path via TYPE-PATH-001
        - Checks both train/test splits exist under phase_c_root
        - Loads NPZ files via MetadataManager.load_with_metadata
        - Checks metadata["data_transformations"] for "transpose_rename_convert" (case-sensitive list membership)
        - Raises RuntimeError mentioning both '_metadata' and 'transpose_rename_convert' if transformation is missing
        - Does not mutate or delete Phase C outputs (read-only)
    
        Follows TYPE-PATH-001 (Path normalization), DATA-001 (NPZ contract).
        """
        # Import the function under test
        validate_phase_c_metadata = _import_validate_phase_c_metadata()
    
        # Setup: Create fake Phase C outputs with _metadata but missing canonical transformation
        hub = tmp_path / "phase_c_hub"
        phase_c_root = hub / "data" / "phase_c"
        phase_c_root.mkdir(parents=True)
    
        # Create NPZ files for train and test splits WITH _metadata but WITHOUT transpose_rename_convert
        import numpy as np
        from ptycho.metadata import MetadataManager
    
        for split in ["train", "test"]:
            split_dir = phase_c_root / f"dose_1000_{split}"
            split_dir.mkdir(parents=True)
    
            npz_path = split_dir / f"fly64_{split}_simulated.npz"
    
            # Create minimal NPZ data
            data_dict = {
                'diffraction': np.random.rand(10, 64, 64).astype(np.float32),
                'objectGuess': np.random.rand(128, 128).astype(np.complex64),
                'probeGuess': np.random.rand(64, 64).astype(np.complex64),
            }
    
            # Create metadata with a DIFFERENT transformation (not transpose_rename_convert)
            metadata = {
                "schema_version": "1.0",
                "data_transformations": [
                    {
                        "tool": "some_other_tool",
                        "timestamp": "2025-11-07T19:00:00Z",
                        "operation": "other_operation",
                        "parameters": {}
                    }
                ]
            }
    
            # Save with metadata but missing the required transformation
            MetadataManager.save_with_metadata(str(npz_path), data_dict, metadata)
    
        # Execute: Call the guard (should raise RuntimeError mentioning both '_metadata' and 'transpose_rename_convert')
>       with pytest.raises(RuntimeError, match=r"transpose_rename_convert"):
E       Failed: DID NOT RAISE <class 'RuntimeError'>

tests/study/test_phase_g_dense_orchestrator.py:317: Failed
----------------------------- Captured stdout call -----------------------------
[validate_phase_c_metadata] ✓ fly64_train_simulated.npz contains _metadata
[validate_phase_c_metadata] ✓ fly64_test_simulated.npz contains _metadata
[validate_phase_c_metadata] SUCCESS: All Phase C NPZ files contain required _metadata
=========================== short test summary info ============================
FAILED tests/study/test_phase_g_dense_orchestrator.py::test_validate_phase_c_metadata_requires_canonical_transform - Failed: DID NOT RAISE <class 'RuntimeError'>
============================== 1 failed in 0.91s ===============================
