============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/scripts/test_ptychi_reconstruct_tike.py::test_main_uses_cli_arguments FAILED [100%]

=================================== FAILURES ===================================
_________________________ test_main_uses_cli_arguments _________________________

    def test_main_uses_cli_arguments():
        """
        Test that main() honors CLI arguments for input/output paths and parameters.
    
        This test stubs pty-chi modules and verifies that CLI overrides propagate
        to load_and_convert_tike_data and save_results helpers.
        """
        # Import the script module
        # We need to mock ptychi before importing the script
        mock_ptychi_api = MagicMock()
        mock_ptychi_utils = MagicMock()
    
        # Mock the ptychi modules
        with patch.dict('sys.modules', {
            'ptychi': MagicMock(),
            'ptychi.api': mock_ptychi_api,
            'ptychi.api.task': MagicMock(),
            'ptychi.utils': mock_ptychi_utils,
        }):
            # Mock the necessary ptychi API components
            mock_ptychi_api.DMOptions = MagicMock
            mock_ptychi_api.LSQMLOptions = MagicMock
            mock_ptychi_api.PIEOptions = MagicMock
            mock_ptychi_api.NoiseModels = MagicMock()
            mock_ptychi_api.Devices = MagicMock()
            mock_ptychi_api.task.PtychographyTask = MagicMock
    
            mock_ptychi_utils.get_suggested_object_size = MagicMock(return_value=(256, 256))
            mock_ptychi_utils.get_default_complex_dtype = MagicMock()
    
            # Now import the script
            import importlib.util
            spec = importlib.util.spec_from_file_location(
                "ptychi_reconstruct_tike",
                "/home/ollie/Documents/PtychoPINN2/scripts/reconstruction/ptychi_reconstruct_tike.py"
            )
            script_module = importlib.util.module_from_spec(spec)
    
            # Execute the script's module code to populate functions
            spec.loader.exec_module(script_module)
    
            # Now mock the helper functions we want to track
            with patch.object(script_module, 'load_and_convert_tike_data') as mock_load, \
                 patch.object(script_module, 'configure_reconstruction') as mock_configure, \
                 patch.object(script_module, 'run_reconstruction') as mock_run, \
                 patch.object(script_module, 'save_results') as mock_save:
    
                # Setup return values
                mock_load.return_value = {'n_images': 100, 'intensity': MagicMock()}
                mock_configure.return_value = MagicMock()
                mock_run.return_value = MagicMock()
                mock_save.return_value = Path("/fake/output.npz")
    
                # Now call main with CLI arguments
                test_args = [
                    "--input-npz", "test_input.npz",
                    "--output-dir", "test_output",
                    "--algorithm", "LSQML",
                    "--num-epochs", "50",
                    "--n-images", "256"
                ]
    
>               result = script_module.main(test_args)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E               TypeError: main() takes 0 positional arguments but 1 was given

tests/scripts/test_ptychi_reconstruct_tike.py:74: TypeError
=========================== short test summary info ============================
FAILED tests/scripts/test_ptychi_reconstruct_tike.py::test_main_uses_cli_arguments - TypeError: main() takes 0 positional arguments but 1 was given
============================== 1 failed in 1.01s ===============================
