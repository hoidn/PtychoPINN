============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/study/test_dose_overlap_comparison.py::test_execute_comparison_jobs_appends_tike_recon_path FAILED [100%]

=================================== FAILURES ===================================
_____________ test_execute_comparison_jobs_appends_tike_recon_path _____________

fake_phase_artifacts = {'phase_c_root': PosixPath('/tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_c'), 'phase_e_root':...obs_a0/phase_e'), 'phase_f_root': PosixPath('/tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_f')}
tmp_path = PosixPath('/tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x753cb179dd10>

    def test_execute_comparison_jobs_appends_tike_recon_path(fake_phase_artifacts, tmp_path, monkeypatch):
        """
        Test execute_comparison_jobs reads Phase F manifest and appends --tike_recon_path.
    
        Exit criteria (AT-G2.1):
        - execute_comparison_jobs reads manifest.json from phase_f_manifest path
        - Manifest must contain output_dir field (or similar reconstruction location pointer)
        - Function constructs ptychi_reconstruction.npz path from manifest output_dir
        - --tike_recon_path <path> is appended to subprocess command
        - Path is normalized using Path objects (TYPE-PATH-001)
        - Function fails fast with clear error if ptychi_reconstruction.npz missing
    
        Background:
        Prior code at comparison.py:169-186 never passed Phase F reconstruction data to
        scripts.compare_models, limiting comparisons to PINN vs baseline (two-way).
        This test validates manifest-driven three-way comparison wiring.
    
        Test structure:
        - RED: Assert execute_comparison_jobs currently lacks --tike_recon_path in command
        - GREEN: After implementation, assert --tike_recon_path present with correct path
        """
        from studies.fly64_dose_overlap.comparison import build_comparison_jobs, execute_comparison_jobs
        import json
    
        # Update Phase F manifest to include reconstruction output path
        phase_f_manifest_dir = fake_phase_artifacts['phase_f_root'] / 'dose_1000_dense_train'
        manifest_data = {
            'dose': 1000,
            'view': 'dense',
            'split': 'train',
            'output_dir': str(phase_f_manifest_dir / 'dose_1000' / 'dense' / 'train'),
        }
        (phase_f_manifest_dir / 'manifest.json').write_text(json.dumps(manifest_data, indent=2))
    
        # Verify ptychi_reconstruction.npz exists in expected location
        recon_path = phase_f_manifest_dir / 'dose_1000' / 'dense' / 'train' / 'ptychi_reconstruction.npz'
        assert recon_path.exists(), f"Test fixture error: reconstruction NPZ missing at {recon_path}"
    
        # Track subprocess calls
        subprocess_calls = []
    
        def mock_subprocess_run(cmd, **kwargs):
            subprocess_calls.append({'cmd': cmd, 'kwargs': kwargs})
            from unittest.mock import Mock
            result = Mock()
            result.returncode = 0
            result.stdout = "comparison complete"
            result.stderr = ""
            return result
    
        monkeypatch.setattr('subprocess.run', mock_subprocess_run)
    
        # Build job for dose=1000, view=dense, split=train
        jobs = build_comparison_jobs(
            phase_c_root=fake_phase_artifacts['phase_c_root'],
            phase_e_root=fake_phase_artifacts['phase_e_root'],
            phase_f_root=fake_phase_artifacts['phase_f_root'],
            dose_filter=1000,
            view_filter='dense',
            split_filter='train',
        )
    
        assert len(jobs) == 1, f"Expected 1 job, got {len(jobs)}"
    
        # Execute comparison
        artifact_root = tmp_path / 'phase_g_tike_recon'
        manifest = execute_comparison_jobs(
            jobs=jobs,
            artifact_root=artifact_root,
        )
    
        # Verify subprocess invoked once
        assert len(subprocess_calls) == 1, f"Expected 1 subprocess call, got {len(subprocess_calls)}"
    
        # Extract command
        cmd = subprocess_calls[0]['cmd']
        cmd_str = ' '.join(str(arg) for arg in cmd)
    
        # RED assertion: --tike_recon_path must be present in command
>       assert '--tike_recon_path' in cmd_str, (
            f"Missing --tike_recon_path in comparison command.\n"
            f"Command: {cmd_str}\n"
            f"Expected path: {recon_path}"
        )
E       AssertionError: Missing --tike_recon_path in comparison command.
E         Command: /home/ollie/miniconda3/envs/ptycho311/bin/python3.11 -m scripts.compare_models --pinn_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/dense/gs2 --baseline_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/baseline/gs1 --test_data /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_c/dose_1000/patched_train.npz --output_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_g_tike_recon/dose_1000/dense/train --ms-ssim-sigma 1.0 --register-ptychi-only
E         Expected path: /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_f/dose_1000_dense_train/dose_1000/dense/train/ptychi_reconstruction.npz
E       assert '--tike_recon_path' in '/home/ollie/miniconda3/envs/ptycho311/bin/python3.11 -m scripts.compare_models --pinn_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/dense/gs2 --baseline_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/baseline/gs1 --test_data /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_c/dose_1000/patched_train.npz --output_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_g_tike_recon/dose_1000/dense/train --ms-ssim-sigma 1.0 --register-ptychi-only'

tests/study/test_dose_overlap_comparison.py:412: AssertionError
----------------------------- Captured stdout call -----------------------------

Executing comparison for dose=1000, view=dense, split=train
  Output: /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_g_tike_recon/dose_1000/dense/train
  Log: /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_g_tike_recon/dose_1000/dense/train/comparison.log
  SUCCESS (returncode=0)
=========================== short test summary info ============================
FAILED tests/study/test_dose_overlap_comparison.py::test_execute_comparison_jobs_appends_tike_recon_path - AssertionError: Missing --tike_recon_path in comparison command.
  Command: /home/ollie/miniconda3/envs/ptycho311/bin/python3.11 -m scripts.compare_models --pinn_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/dense/gs2 --baseline_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/baseline/gs1 --test_data /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_c/dose_1000/patched_train.npz --output_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_g_tike_recon/dose_1000/dense/train --ms-ssim-sigma 1.0 --register-ptychi-only
  Expected path: /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_f/dose_1000_dense_train/dose_1000/dense/train/ptychi_reconstruction.npz
assert '--tike_recon_path' in '/home/ollie/miniconda3/envs/ptycho311/bin/python3.11 -m scripts.compare_models --pinn_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/dense/gs2 --baseline_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_e/dose_1000/baseline/gs1 --test_data /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_c/dose_1000/patched_train.npz --output_dir /tmp/pytest-of-ollie/pytest-272/test_execute_comparison_jobs_a0/phase_g_tike_recon/dose_1000/dense/train --ms-ssim-sigma 1.0 --register-ptychi-only'
============================== 1 failed in 1.73s ===============================
