============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 343 items / 2 skipped

tests/image/test_cropping.py::TestCroppingAlignment::test_align_for_evaluation_bounding_box PASSED [  0%]
tests/image/test_cropping.py::TestCroppingAlignment::test_align_for_evaluation_coordinates_format PASSED [  0%]
tests/image/test_cropping.py::TestCroppingAlignment::test_align_for_evaluation_shapes PASSED [  0%]
tests/image/test_cropping.py::TestCroppingAlignment::test_align_for_evaluation_with_squeeze PASSED [  1%]
tests/image/test_cropping.py::TestCroppingAlignment::test_center_crop_exact_size PASSED [  1%]
tests/image/test_registration.py::TestRegistration::test_apply_shift_and_crop_basic PASSED [  1%]
tests/image/test_registration.py::TestRegistration::test_apply_shift_and_crop_zero_offset PASSED [  2%]
tests/image/test_registration.py::TestRegistration::test_different_image_content PASSED [  2%]
tests/image/test_registration.py::TestRegistration::test_edge_case_maximum_shift PASSED [  2%]
tests/image/test_registration.py::TestRegistration::test_edge_case_single_pixel_shift PASSED [  2%]
tests/image/test_registration.py::TestRegistration::test_find_offset_known_shift_complex PASSED [  3%]
tests/image/test_registration.py::TestRegistration::test_find_offset_known_shift_real PASSED [  3%]
tests/image/test_registration.py::TestRegistration::test_input_validation_2d_requirement PASSED [  3%]
tests/image/test_registration.py::TestRegistration::test_input_validation_excessive_offset PASSED [  4%]
tests/image/test_registration.py::TestRegistration::test_input_validation_shape_matching PASSED [  4%]
tests/image/test_registration.py::TestRegistration::test_noise_robustness PASSED [  4%]
tests/image/test_registration.py::TestRegistration::test_register_and_align_convenience PASSED [  4%]
tests/image/test_registration.py::TestRegistration::test_registration_sign_verification PASSED [  5%]
tests/image/test_registration.py::TestRegistration::test_round_trip_registration PASSED [  5%]
tests/image/test_registration.py::TestRegistration::test_shift_and_crop_preserves_data_type PASSED [  5%]
tests/test_baselines.py::TestBaselines::test_build_model_always_creates_single_channel_output PASSED [  6%]
tests/test_cli_args.py::TestCliArgs::test_add_logging_arguments PASSED   [  6%]
tests/test_cli_args.py::TestCliArgs::test_console_level_choices PASSED   [  6%]
tests/test_cli_args.py::TestCliArgs::test_get_logging_config_custom_level PASSED [  6%]
tests/test_cli_args.py::TestCliArgs::test_get_logging_config_defaults PASSED [  7%]
tests/test_cli_args.py::TestCliArgs::test_get_logging_config_quiet PASSED [  7%]
tests/test_cli_args.py::TestCliArgs::test_get_logging_config_verbose PASSED [  7%]
tests/test_cli_args.py::TestCliArgs::test_quiet_verbose_mutually_exclusive PASSED [  8%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_backward_compatibility PASSED [  8%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_different_seeds_produce_different_results PASSED [  8%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_edge_case_k_less_than_c PASSED [  9%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_edge_case_more_samples_than_points PASSED [  9%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_edge_case_small_dataset PASSED [  9%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_efficient_grouping_output_shape PASSED [  9%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_efficient_grouping_spatial_coherence PASSED [ 10%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_efficient_grouping_valid_indices PASSED [ 10%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_generate_grouped_data_gridsize_1 PASSED [ 10%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_generate_grouped_data_integration PASSED [ 11%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_memory_efficiency PASSED [ 11%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_no_cache_files_created PASSED [ 11%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_performance_improvement PASSED [ 11%]
tests/test_coordinate_grouping.py::TestCoordinateGrouping::test_reproducibility_with_seed PASSED [ 12%]
tests/test_coordinate_grouping.py::TestIntegrationWithExistingCode::test_existing_tests_still_pass PASSED [ 12%]
tests/test_generic_loader.py::TestGenericLoader::test_generic_loader_roundtrip SKIPPED [ 12%]
tests/test_generic_loader.py::test_generic_loader PASSED                 [ 13%]
tests/test_integration_baseline_gs2.py::TestBaselineGridsize2Integration::test_baseline_gridsize2_end_to_end SKIPPED [ 13%]
tests/test_integration_workflow.py::TestFullWorkflow::test_train_save_load_infer_cycle PASSED [ 13%]
tests/test_log_config.py::TestLogConfig::test_backward_compatibility PASSED [ 13%]
tests/test_log_config.py::TestLogConfig::test_conflicting_flags_verbose_overrides PASSED [ 14%]
tests/test_log_config.py::TestLogConfig::test_custom_console_level PASSED [ 14%]
tests/test_log_config.py::TestLogConfig::test_default_setup_logging_creates_log_directory_and_file PASSED [ 14%]
tests/test_log_config.py::TestLogConfig::test_quiet_flag_overrides_console_level PASSED [ 15%]
tests/test_log_config.py::TestLogConfig::test_quiet_mode_disables_console PASSED [ 15%]
tests/test_log_config.py::TestLogConfig::test_setup_logging_clears_existing_handlers PASSED [ 15%]
tests/test_log_config.py::TestLogConfig::test_string_path_support PASSED [ 16%]
tests/test_log_config.py::TestLogConfig::test_verbose_mode_enables_debug_console PASSED [ 16%]
tests/test_misc.py::test_memoize_simulated_data SKIPPED (Deprecated:...) [ 16%]
tests/test_nphotons_metadata_integration.py::TestNphotonsMetadataIntegration::test_configuration_mismatch_warnings PASSED [ 16%]
tests/test_nphotons_metadata_integration.py::TestNphotonsMetadataIntegration::test_end_to_end_workflow_consistency PASSED [ 17%]
tests/test_nphotons_metadata_integration.py::TestNphotonsMetadataIntegration::test_metadata_backward_compatibility PASSED [ 17%]
tests/test_nphotons_metadata_integration.py::TestNphotonsMetadataIntegration::test_metadata_persistence_single_nphotons PASSED [ 17%]
tests/test_nphotons_metadata_integration.py::TestNphotonsMetadataIntegration::test_multiple_nphotons_metadata_consistency PASSED [ 18%]
tests/test_nphotons_metadata_integration.py::TestNphotonsMetadataIntegration::test_training_with_mismatched_config_warns_but_continues PASSED [ 18%]
tests/test_oversampling.py::TestAutomaticOversampling::test_automatic_oversampling_triggers PASSED [ 18%]
tests/test_oversampling.py::TestAutomaticOversampling::test_gridsize_1_no_oversampling PASSED [ 18%]
tests/test_oversampling.py::TestAutomaticOversampling::test_oversampling_with_different_k_values PASSED [ 19%]
tests/test_oversampling.py::TestAutomaticOversampling::test_reproducibility_with_seed PASSED [ 19%]
tests/test_oversampling.py::TestAutomaticOversampling::test_standard_sampling_no_oversampling PASSED [ 19%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_batch_processing PASSED [ 20%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_complex128_dtype PASSED [ 20%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_complex64_dtype PASSED [ 20%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_fill_modes PASSED [ 20%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_float32_dtype PASSED [ 21%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_float64_dtype PASSED [ 21%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_float64_with_translation PASSED [ 21%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_interpolation_modes PASSED [ 22%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_jit_compilation_float32 PASSED [ 22%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_jit_compilation_float64 PASSED [ 22%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_mixed_precision_translation PASSED [ 23%]
tests/test_projective_warp_xla.py::TestProjectiveWarpXLA::test_tfa_params_conversion PASSED [ 23%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_content_validity PASSED [ 23%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_edge_case_k_less_than_c PASSED [ 23%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_edge_case_more_samples_than_points PASSED [ 24%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_edge_case_small_dataset PASSED [ 24%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_memory_efficiency PASSED [ 24%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_output_shape PASSED [ 25%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_performance_improvement PASSED [ 25%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_reproducibility PASSED [ 25%]
tests/test_raw_data_grouping.py::TestRawDataGrouping::test_uniform_sampling PASSED [ 25%]
tests/test_scaling_regression.py::TestScalingRegression::test_both_arrays_scaled_identically PASSED [ 26%]
tests/test_scaling_regression.py::TestScalingRegression::test_different_nphotons_produce_proportional_scaling PASSED [ 26%]
tests/test_scaling_regression.py::TestScalingRegression::test_intensity_scale_is_valid PASSED [ 26%]
tests/test_scaling_regression.py::TestScalingRegression::test_phase_is_not_scaled PASSED [ 27%]
tests/test_scaling_regression.py::TestScalingRegression::test_scaling_is_reversible PASSED [ 27%]
tests/test_scaling_regression.py::TestScalingRegression::test_scaling_preserves_physics PASSED [ 27%]
tests/test_scaling_regression.py::TestScalingAssertions::test_assertions_catch_invalid_intensity_scale PASSED [ 27%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_default_behavior_is_random PASSED [ 28%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_sampling_handles_edge_cases PASSED [ 28%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_sampling_is_deterministic PASSED [ 28%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_sampling_order PASSED [ 29%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_sampling_uses_first_n_points PASSED [ 29%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_sampling_with_gridsize_greater_than_1 PASSED [ 29%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_sampling_with_seed_parameter PASSED [ 30%]
tests/test_sequential_sampling.py::TestSequentialSampling::test_sequential_vs_random_coverage PASSED [ 30%]
tests/test_sequential_sampling.py::TestIntegrationWithWorkflow::test_cli_argument_parsing PASSED [ 30%]
tests/test_sequential_sampling.py::TestIntegrationWithWorkflow::test_config_flag_exists PASSED [ 30%]
tests/test_subsampling.py::TestSubsampling::test_different_seeds_produce_different_results PASSED [ 31%]
tests/test_subsampling.py::TestSubsampling::test_interaction_with_config_dataclass PASSED [ 31%]
tests/test_subsampling.py::TestSubsampling::test_legacy_n_images_behavior PASSED [ 31%]
tests/test_subsampling.py::TestSubsampling::test_n_subsample_overrides_n_images PASSED [ 32%]
tests/test_subsampling.py::TestSubsampling::test_no_subsample_uses_full_dataset PASSED [ 32%]
tests/test_subsampling.py::TestSubsampling::test_reproducible_subsampling_with_seed PASSED [ 32%]
tests/test_subsampling.py::TestSubsampling::test_sorted_indices_for_consistency PASSED [ 32%]
tests/test_subsampling.py::TestSubsampling::test_subsample_larger_than_dataset PASSED [ 33%]
tests/test_subsampling.py::TestSubsampling::test_subsample_with_n_subsample PASSED [ 33%]
tests/test_subsampling.py::TestSubsampling::test_subsample_zero_edge_case PASSED [ 33%]
tests/test_subsampling.py::TestSubsampling::test_y_patches_subsampled_consistently PASSED [ 34%]
tests/test_tf_helper.py::TestReassemblePosition::test_basic_functionality PASSED [ 34%]
tests/test_tf_helper.py::TestReassemblePosition::test_different_patch_values_blend PASSED [ 34%]
tests/test_tf_helper.py::TestReassemblePosition::test_identical_patches_single_vs_double PASSED [ 34%]
tests/test_tf_helper.py::TestReassemblePosition::test_perfect_overlap_averages_to_identity PASSED [ 35%]
tests/test_tf_helper.py::TestTranslateFunction::test_batch_translation PASSED [ 35%]
tests/test_tf_helper.py::TestTranslateFunction::test_complex_tensor_translation PASSED [ 35%]
tests/test_tf_helper.py::TestTranslateFunction::test_edge_cases PASSED   [ 36%]
tests/test_tf_helper.py::TestTranslateFunction::test_integer_translation PASSED [ 36%]
tests/test_tf_helper.py::TestTranslateFunction::test_subpixel_translation PASSED [ 36%]
tests/test_tf_helper.py::TestTranslateFunction::test_translate_core_matches_addons SKIPPED [ 37%]
tests/test_tf_helper.py::TestTranslateFunction::test_zero_translation PASSED [ 37%]
tests/test_tf_helper_edge_aware.py::TestTranslateSmoothPatterns::test_complex_smooth_translation PASSED [ 37%]
tests/test_tf_helper_edge_aware.py::TestTranslateSmoothPatterns::test_gaussian_probe_translation SKIPPED [ 37%]
tests/test_tf_helper_edge_aware.py::TestTranslateSmoothPatterns::test_smooth_object_translation SKIPPED [ 38%]
tests/test_tf_helper_edge_aware.py::TestTranslateEdgeCases::test_boundary_behavior SKIPPED [ 38%]
tests/test_tf_helper_edge_aware.py::TestTranslateEdgeCases::test_document_edge_differences SKIPPED [ 38%]
tests/test_tf_helper_edge_aware.py::TestPtychoPINNRelevantCases::test_batch_smooth_patterns SKIPPED [ 39%]
tests/test_tf_helper_edge_aware.py::TestPtychoPINNRelevantCases::test_typical_probe_sizes SKIPPED [ 39%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_exception_propagation PASSED [ 39%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_load_valid_model_directory PASSED [ 39%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_missing_diffraction_model PASSED [ 40%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_missing_model_archive PASSED [ 40%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_nonexistent_directory PASSED [ 40%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_not_a_directory PASSED [ 41%]
tests/test_workflow_components.py::TestLoadInferenceBundle::test_path_conversion PASSED [ 41%]
tests/tools/test_generate_test_index.py::GenerateTestIndexTests::test_get_module_docstring_handles_missing_docstring PASSED [ 41%]
tests/tools/test_generate_test_index.py::GenerateTestIndexTests::test_get_module_docstring_reads_existing_docstring PASSED [ 41%]
tests/tools/test_generate_test_index.py::GenerateTestIndexTests::test_get_test_functions_lists_key_tests PASSED [ 42%]
tests/tools/test_update_tool.py::TestUpdateTool::test_update_function PASSED [ 42%]
tests/tools/test_update_tool.py::test_update_function PASSED             [ 42%]
tests/torch/test_backend_selection.py::TestBackendSelection::test_defaults_to_tensorflow_backend PASSED [ 43%]
tests/torch/test_backend_selection.py::TestBackendSelection::test_selects_pytorch_backend PASSED [ 43%]
tests/torch/test_backend_selection.py::TestBackendSelection::test_pytorch_backend_calls_update_legacy_dict PASSED [ 43%]
tests/torch/test_backend_selection.py::TestBackendSelection::test_pytorch_unavailable_raises_error PASSED [ 44%]
tests/torch/test_backend_selection.py::TestBackendSelection::test_inference_config_supports_backend_selection PASSED [ 44%]
tests/torch/test_backend_selection.py::TestBackendSelection::test_backend_selection_preserves_api_parity PASSED [ 44%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_accelerator_flag_roundtrip PASSED [ 44%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_num_workers_flag_roundtrip PASSED [ 45%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_inference_batch_size_flag_roundtrip PASSED [ 45%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_multiple_execution_config_flags PASSED [ 45%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_validate_paths PASSED [ 46%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_helper_for_data_loading PASSED [ 46%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_inference_helper PASSED [ 46%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_calls_save_individual_reconstructions PASSED [ 46%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_quiet_flag_suppresses_progress_output PASSED [ 47%]
tests/torch/test_cli_shared.py::TestResolveAccelerator::test_default_no_device PASSED [ 47%]
tests/torch/test_cli_shared.py::TestResolveAccelerator::test_legacy_device_cpu PASSED [ 47%]
tests/torch/test_cli_shared.py::TestResolveAccelerator::test_legacy_device_cuda_maps_to_gpu PASSED [ 48%]
tests/torch/test_cli_shared.py::TestResolveAccelerator::test_conflict_accelerator_wins PASSED [ 48%]
tests/torch/test_cli_shared.py::TestResolveAccelerator::test_all_accelerator_values_passthrough PASSED [ 48%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_training_mode_defaults PASSED [ 48%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_training_mode_custom_values PASSED [ 49%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_inference_mode PASSED [ 49%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_emits_deterministic_warning PASSED [ 49%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_handles_quiet_flag PASSED [ 50%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_handles_disable_mlflow_flag PASSED [ 50%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_quiet_or_disable_mlflow_both_true PASSED [ 50%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_invalid_mode_raises_value_error PASSED [ 51%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfig::test_resolves_accelerator_from_device_flag PASSED [ 51%]
tests/torch/test_cli_shared.py::TestValidatePaths::test_creates_output_dir PASSED [ 51%]
tests/torch/test_cli_shared.py::TestValidatePaths::test_raises_if_train_file_missing PASSED [ 51%]
tests/torch/test_cli_shared.py::TestValidatePaths::test_raises_if_test_file_missing PASSED [ 52%]
tests/torch/test_cli_shared.py::TestValidatePaths::test_accepts_none_test_file PASSED [ 52%]
tests/torch/test_cli_shared.py::TestValidatePaths::test_works_with_pathlib_path_objects PASSED [ 52%]
tests/torch/test_cli_shared.py::TestValidatePaths::test_accepts_none_train_file_for_inference_mode PASSED [ 53%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfigInferenceMode::test_inference_mode_defaults PASSED [ 53%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfigInferenceMode::test_inference_mode_custom_batch_size PASSED [ 53%]
tests/torch/test_cli_shared.py::TestBuildExecutionConfigInferenceMode::test_inference_mode_respects_quiet PASSED [ 53%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_accelerator_flag_roundtrip PASSED [ 54%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_deterministic_flag_roundtrip PASSED [ 54%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_no_deterministic_flag_roundtrip PASSED [ 54%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_num_workers_flag_roundtrip PASSED [ 55%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_learning_rate_flag_roundtrip PASSED [ 55%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_multiple_execution_config_flags PASSED [ 55%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_bundle_persistence PASSED [ 55%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_enable_checkpointing_flag PASSED [ 56%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_checkpoint_save_top_k_flag PASSED [ 56%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_checkpoint_monitor_flag PASSED [ 56%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_checkpoint_mode_flag PASSED [ 57%]
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_early_stop_patience_flag PASSED [ 57%]
tests/torch/test_config_bridge.py::TestConfigBridgeMVP::test_mvp_config_bridge_populates_params_cfg PASSED [ 57%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_direct_fields[N-direct] PASSED [ 58%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_direct_fields[n_filters_scale-direct] PASSED [ 58%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_direct_fields[object_big-direct] PASSED [ 58%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_direct_fields[probe_big-direct] PASSED [ 58%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_direct_fields[batch_size-direct] PASSED [ 59%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_transform_fields[gridsize-tuple-to-int] PASSED [ 59%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_transform_fields[model_type-unsupervised] PASSED [ 59%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_transform_fields[model_type-supervised] PASSED [ 60%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_transform_fields[amp_activation-silu] PASSED [ 60%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_transform_fields[amp_activation-SiLU] PASSED [ 60%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_transform_fields[amp_activation-passthrough] PASSED [ 60%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_transform_fields[nepochs-rename] PASSED [ 61%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_transform_fields[nll_weight-true] PASSED [ 61%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_transform_fields[nll_weight-false] PASSED [ 61%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_override_fields[pad_object-default] PASSED [ 62%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_override_fields[pad_object-override] PASSED [ 62%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_override_fields[gaussian_smoothing_sigma-default] PASSED [ 62%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_override_fields[gaussian_smoothing_sigma-override] PASSED [ 62%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[mae_weight-default] PASSED [ 63%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[mae_weight-override] PASSED [ 63%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[realspace_mae_weight-default] PASSED [ 63%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[realspace_weight-default] PASSED [ 64%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[positions_provided-default] PASSED [ 64%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[probe_trainable-default] PASSED [ 64%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[sequential_sampling-default] PASSED [ 65%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_inference_config_override_fields[debug-default] PASSED [ 65%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_inference_config_override_fields[debug-override] PASSED [ 65%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_probe_mask_translation[probe_mask-default] PASSED [ 65%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_config_probe_mask_override PASSED [ 66%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_default_divergence_detection[nphotons-divergence] PASSED [ 66%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_default_divergence_detection[probe_scale-divergence] PASSED [ 66%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_gridsize_error_handling[gridsize-non-square] PASSED [ 67%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_type_error_handling[model_type-invalid-enum] PASSED [ 67%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_activation_error_handling[amp_activation-unknown] PASSED [ 67%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_train_data_file_required_error PASSED [ 67%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_model_path_required_error PASSED [ 68%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_nphotons_default_divergence_error PASSED [ 68%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_nphotons_override_passes_validation PASSED [ 68%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_n_subsample_missing_override_uses_none PASSED [ 69%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_n_subsample_explicit_override PASSED [ 69%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_inference_config_n_subsample_missing_override_uses_none PASSED [ 69%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_inference_config_n_subsample_explicit_override PASSED [ 69%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_n_groups_missing_override_warning PASSED [ 70%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_test_data_file_training_missing_warning PASSED [ 70%]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_params_cfg_matches_baseline PASSED [ 70%]
tests/torch/test_config_factory.py::TestTrainingPayloadStructure::test_training_payload_returns_dataclass PASSED [ 71%]
tests/torch/test_config_factory.py::TestTrainingPayloadStructure::test_training_payload_contains_tf_config PASSED [ 71%]
tests/torch/test_config_factory.py::TestTrainingPayloadStructure::test_training_payload_contains_pytorch_configs PASSED [ 71%]
tests/torch/test_config_factory.py::TestTrainingPayloadStructure::test_training_payload_contains_overrides_dict PASSED [ 72%]
tests/torch/test_config_factory.py::TestTrainingPayloadStructure::test_gridsize_sets_channel_count PASSED [ 72%]
tests/torch/test_config_factory.py::TestInferencePayloadStructure::test_inference_payload_returns_dataclass PASSED [ 72%]
tests/torch/test_config_factory.py::TestInferencePayloadStructure::test_inference_payload_contains_tf_config PASSED [ 72%]
tests/torch/test_config_factory.py::TestInferencePayloadStructure::test_inference_payload_contains_pytorch_configs PASSED [ 73%]
tests/torch/test_config_factory.py::TestConfigBridgeTranslation::test_grid_size_tuple_to_gridsize_int PASSED [ 73%]
tests/torch/test_config_factory.py::TestConfigBridgeTranslation::test_epochs_to_nepochs_conversion PASSED [ 73%]
tests/torch/test_config_factory.py::TestConfigBridgeTranslation::test_k_to_neighbor_count_conversion PASSED [ 74%]
tests/torch/test_config_factory.py::TestLegacyParamsPopulation::test_factory_populates_params_cfg PASSED [ 74%]
tests/torch/test_config_factory.py::TestLegacyParamsPopulation::test_populate_legacy_params_helper PASSED [ 74%]
tests/torch/test_config_factory.py::TestOverridePrecedence::test_override_dict_wins_over_defaults PASSED [ 74%]
tests/torch/test_config_factory.py::TestOverridePrecedence::test_probe_size_override_wins_over_inference PASSED [ 75%]
tests/torch/test_config_factory.py::TestFactoryValidation::test_missing_n_groups_raises_error PASSED [ 75%]
tests/torch/test_config_factory.py::TestFactoryValidation::test_nonexistent_train_data_file_raises_error PASSED [ 75%]
tests/torch/test_config_factory.py::TestFactoryValidation::test_missing_checkpoint_raises_error PASSED [ 76%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_training_payload_execution_config_not_none PASSED [ 76%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_inference_payload_execution_config_not_none PASSED [ 76%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_execution_config_defaults_applied PASSED [ 76%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_execution_config_explicit_instance_propagates PASSED [ 77%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_execution_config_fields_accessible PASSED [ 77%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_overrides_applied_records_execution_knobs PASSED [ 77%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_checkpoint_knobs_propagate_through_factory PASSED [ 78%]
tests/torch/test_config_factory.py::TestExecutionConfigOverrides::test_checkpoint_defaults_respected PASSED [ 78%]
tests/torch/test_config_factory.py::TestProbeSizeInference::test_infer_probe_size_from_npz PASSED [ 78%]
tests/torch/test_config_factory.py::TestProbeSizeInference::test_infer_probe_size_missing_file_fallback PASSED [ 79%]
tests/torch/test_data_pipeline.py::TestRawDataTorchAdapter::test_raw_data_torch_matches_tensorflow PASSED [ 79%]
tests/torch/test_data_pipeline.py::TestDataContainerParity::test_data_container_shapes_and_dtypes PASSED [ 79%]
tests/torch/test_data_pipeline.py::TestGroundTruthLoading::test_y_patches_are_complex64 PASSED [ 79%]
tests/torch/test_data_pipeline.py::TestMemmapBridgeParity::test_memmap_loader_matches_raw_data_torch PASSED [ 80%]
tests/torch/test_data_pipeline.py::TestMemmapBridgeParity::test_deterministic_generation_validation PASSED [ 80%]
tests/torch/test_dataloader.py::TestDataloaderCanonicalKeySupport::test_backward_compat_legacy_diff3d PASSED [ 80%]
tests/torch/test_dataloader.py::TestDataloaderCanonicalKeySupport::test_error_when_no_diffraction_key PASSED [ 81%]
tests/torch/test_dataloader.py::TestDataloaderCanonicalKeySupport::test_loads_canonical_diffraction PASSED [ 81%]
tests/torch/test_dataloader.py::TestDataloaderFormatAutoTranspose::test_auto_transposes_legacy_hwn_format PASSED [ 81%]
tests/torch/test_dataloader.py::TestDataloaderFormatAutoTranspose::test_handles_edge_case_square_dataset PASSED [ 81%]
tests/torch/test_dataloader.py::TestDataloaderFormatAutoTranspose::test_npz_headers_also_transposes_shape PASSED [ 82%]
tests/torch/test_dataloader.py::TestDataloaderFormatAutoTranspose::test_preserves_canonical_nwh_format PASSED [ 82%]
tests/torch/test_dataloader.py::TestDataloaderFormatAutoTranspose::test_real_dataset_dimensions PASSED [ 82%]
tests/torch/test_dataloader.py::TestDataloaderFormatAutoTranspose::test_works_with_diff3d_legacy_key PASSED [ 83%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureContract::test_fixture_file_exists PASSED [ 83%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureContract::test_fixture_outputs_match_contract PASSED [ 83%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureContract::test_metadata_sidecar_exists PASSED [ 83%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureContract::test_metadata_content_valid PASSED [ 84%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureContract::test_coordinate_coverage PASSED [ 84%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureIntegrationSmoke::test_fixture_loads_with_rawdata PASSED [ 84%]
tests/torch/test_fixture_pytorch_integration.py::TestFixtureIntegrationSmoke::test_fixture_compatible_with_pytorch_dataloader PASSED [ 85%]
tests/torch/test_integration_workflow_torch.py::test_bundle_loader_returns_modules FAILED [ 85%]
tests/torch/test_integration_workflow_torch.py::test_run_pytorch_train_save_load_infer FAILED [ 85%]
tests/torch/test_integration_workflow_torch.py::TestPyTorchIntegrationWorkflow::test_pytorch_train_save_load_infer_cycle_legacy SKIPPED [ 86%]
tests/torch/test_integration_workflow_torch.py::TestPyTorchIntegrationWorkflow::test_pytorch_tf_output_parity SKIPPED [ 86%]
tests/torch/test_lightning_checkpoint.py::TestLightningCheckpointSerialization::test_checkpoint_contains_hyperparameters PASSED [ 86%]
tests/torch/test_lightning_checkpoint.py::TestLightningCheckpointSerialization::test_load_from_checkpoint_without_kwargs PASSED [ 86%]
tests/torch/test_lightning_checkpoint.py::TestLightningCheckpointSerialization::test_checkpoint_configs_are_serializable PASSED [ 87%]
tests/torch/test_model_manager.py::TestSaveTorchBundle::test_archive_structure PASSED [ 87%]
tests/torch/test_model_manager.py::TestSaveTorchBundle::test_params_snapshot PASSED [ 87%]
tests/torch/test_model_manager.py::TestLoadTorchBundle::test_load_round_trip_updates_params_cfg PASSED [ 88%]
tests/torch/test_model_manager.py::TestLoadTorchBundle::test_missing_params_raises_value_error PASSED [ 88%]
tests/torch/test_model_manager.py::TestLoadTorchBundle::test_load_round_trip_returns_model_stub PASSED [ 88%]
tests/torch/test_model_manager.py::TestLoadTorchBundle::test_reconstructs_models_from_bundle PASSED [ 88%]
tests/torch/test_tf_helper.py::TestTorchTFHelper::test_combine_complex SKIPPED [ 89%]
tests/torch/test_tf_helper.py::TestTorchTFHelper::test_get_mask SKIPPED  [ 89%]
tests/torch/test_tf_helper.py::TestTorchTFHelper::test_placeholder_torch_functions SKIPPED [ 89%]
tests/torch/test_train_probe_size.py::TestNPZProbeSizeExtraction::test_infer_probe_size_128 PASSED [ 90%]
tests/torch/test_train_probe_size.py::TestNPZProbeSizeExtraction::test_infer_probe_size_from_npz PASSED [ 90%]
tests/torch/test_train_probe_size.py::TestNPZProbeSizeExtraction::test_infer_probe_size_missing_probe PASSED [ 90%]
tests/torch/test_train_probe_size.py::TestNPZProbeSizeExtraction::test_infer_probe_size_real_dataset PASSED [ 90%]
tests/torch/test_train_probe_size.py::TestNPZProbeSizeExtraction::test_infer_probe_size_rectangular PASSED [ 91%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsScaffold::test_run_cdi_example_calls_update_legacy_dict PASSED [ 91%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_train_cdi_model_torch_invokes_lightning PASSED [ 91%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_dataloader_tensor_dict_structure PASSED [ 92%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_poisson_count_contract PASSED [ 92%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_training_respects_gridsize FAILED [ 92%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_coords_relative_layout PASSED [ 93%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsRun::test_run_cdi_example_invokes_training PASSED [ 93%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsRun::test_run_cdi_example_persists_models PASSED [ 93%]
tests/torch/test_workflows_components.py::TestWorkflowsComponentsRun::test_load_inference_bundle_handles_bundle PASSED [ 93%]
tests/torch/test_workflows_components.py::TestTrainWithLightningRed::test_train_with_lightning_instantiates_module FAILED [ 94%]
tests/torch/test_workflows_components.py::TestTrainWithLightningRed::test_train_with_lightning_runs_trainer_fit FAILED [ 94%]
tests/torch/test_workflows_components.py::TestTrainWithLightningRed::test_train_with_lightning_returns_models_dict FAILED [ 94%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_guard_without_train_results PASSED [ 95%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_flip_transpose_contract[False-False-False] PASSED [ 95%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_flip_transpose_contract[True-False-False] PASSED [ 95%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_flip_transpose_contract[False-True-False] PASSED [ 95%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_flip_transpose_contract[False-False-True] PASSED [ 96%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_flip_transpose_contract[True-True-True] PASSED [ 96%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_run_cdi_example_torch_do_stitching_delegates_to_reassemble PASSED [ 96%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchGreen::test_reassemble_cdi_image_torch_return_contract PASSED [ 97%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchFloat32::test_batches_remain_float32 PASSED [ 97%]
tests/torch/test_workflows_components.py::TestReassembleCdiImageTorchFloat32::test_dataloader_casts_float64_to_float32 PASSED [ 97%]
tests/torch/test_workflows_components.py::TestDecoderLastShapeParity::test_probe_big_shape_alignment PASSED [ 97%]
tests/torch/test_workflows_components.py::TestDecoderLastShapeParity::test_probe_big_false_no_mismatch PASSED [ 98%]
tests/torch/test_workflows_components.py::TestTrainWithLightningGreen::test_execution_config_overrides_trainer FAILED [ 98%]
tests/torch/test_workflows_components.py::TestTrainWithLightningGreen::test_execution_config_controls_determinism FAILED [ 98%]
tests/torch/test_workflows_components.py::TestInferenceExecutionConfig::test_inference_uses_execution_batch_size PASSED [ 99%]
tests/torch/test_workflows_components.py::TestLightningCheckpointCallbacks::test_model_checkpoint_callback_configured FAILED [ 99%]
tests/torch/test_workflows_components.py::TestLightningCheckpointCallbacks::test_early_stopping_callback_configured FAILED [ 99%]
tests/torch/test_workflows_components.py::TestLightningCheckpointCallbacks::test_disable_checkpointing_skips_callbacks PASSED [100%]

=================================== FAILURES ===================================
______________________ test_bundle_loader_returns_modules ______________________
tests/torch/test_integration_workflow_torch.py:216: in test_bundle_loader_returns_modules
    pytest.fail(f"Training failed:\n{train_result.stderr}")
E   Failed: Training failed:
E   2025-10-20 08:50:47.946997: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
E   WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E   E0000 00:00:1760975447.957940 1798469 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
E   E0000 00:00:1760975447.961605 1798469 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
E   W0000 00:00:1760975447.972547 1798469 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   W0000 00:00:1760975447.972559 1798469 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   W0000 00:00:1760975447.972560 1798469 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   W0000 00:00:1760975447.972562 1798469 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   2025-10-20 08:50:49.935603: E external/local_xla/xla/stream_executor/cuda/cuda_platform.cc:51] failed call to cuInit: INTERNAL: CUDA error: Failed call to cuInit: CUDA_ERROR_NO_DEVICE: no CUDA-capable device is detected
E   /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:608: UserWarning: params.cfg already populated. Set force=True to overwrite existing values.
E     warnings.warn(
E   WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E   I0000 00:00:1760975452.404973 1798469 service.cc:152] XLA service 0x4cf696a0 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
E   I0000 00:00:1760975452.405005 1798469 service.cc:160]   StreamExecutor device (0): Host, Default Version
E   I0000 00:00:1760975452.522140 1798469 device_compiler.h:188] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.
E   /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:257: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
E     tf_training_config = to_training_config(
E   Seed set to 42
E   INFO:pytorch_lightning.utilities.rank_zero:GPU available: False, used: False
E   INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
E   INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
E   
E     | Name  | Type        | Params | Mode 
E   ----------------------------------------------
E   0 | model | PtychoPINN  | 2.3 M  | train
E   1 | Loss  | PoissonLoss | 0      | train
E   ----------------------------------------------
E   2.3 M     Trainable params
E   0         Non-trainable params
E   2.3 M     Total params
E   9.345     Total estimated model params size (MB)
E   73        Modules in train mode
E   0         Modules in eval mode
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:433: The 'val_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/core/module.py:520: You called `self.log('poisson_val_loss', ..., logger=True)` but have no logger configured. You can enable one by doing `Trainer(logger=ALogger(...))`
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:433: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/core/module.py:520: You called `self.log('poisson_train_loss', ..., logger=True)` but have no logger configured. You can enable one by doing `Trainer(logger=ALogger(...))`
E   ERROR:ptycho_torch.workflows.components:Lightning training failed: Early stopping conditioned on metric `val_loss` which is not available. Pass in or modify your `EarlyStopping` callback to use any of the following: `training_stage`, `training_stage_step`, `physics_weight`, `physics_weight_step`, `poisson_train_loss`, `poisson_train_loss_step`, `training_stage_epoch`, `physics_weight_epoch`, `poisson_val_loss`, `learning_rate`, `poisson_train_loss_epoch`
E   Traceback (most recent call last):
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 739, in _train_with_lightning
E       trainer.fit(model, train_dataloaders=train_loader, val_dataloaders=val_loader)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 560, in fit
E       call._call_and_handle_interrupt(
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py", line 49, in _call_and_handle_interrupt
E       return trainer_fn(*args, **kwargs)
E              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 598, in _fit_impl
E       self._run(model, ckpt_path=ckpt_path)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 1011, in _run
E       results = self._run_stage()
E                 ^^^^^^^^^^^^^^^^^
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 1055, in _run_stage
E       self.fit_loop.run()
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py", line 217, in run
E       self.on_advance_end()
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py", line 473, in on_advance_end
E       call._call_callback_hooks(trainer, "on_train_epoch_end", monitoring_callbacks=True)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py", line 228, in _call_callback_hooks
E       fn(trainer, trainer.lightning_module, *args, **kwargs)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py", line 190, in on_train_epoch_end
E       self._run_early_stopping_check(trainer)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py", line 202, in _run_early_stopping_check
E       if trainer.fast_dev_run or not self._validate_condition_metric(  # disable early_stopping with fast_dev_run
E                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py", line 153, in _validate_condition_metric
E       raise RuntimeError(error_msg)
E   RuntimeError: Early stopping conditioned on metric `val_loss` which is not available. Pass in or modify your `EarlyStopping` callback to use any of the following: `training_stage`, `training_stage_step`, `physics_weight`, `physics_weight_step`, `poisson_train_loss`, `poisson_train_loss_step`, `training_stage_epoch`, `physics_weight_epoch`, `poisson_val_loss`, `learning_rate`, `poisson_train_loss_epoch`
E   
E   The above exception was the direct cause of the following exception:
E   
E   Traceback (most recent call last):
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/train.py", line 671, in cli_main
E       amplitude, phase, results = run_cdi_example_torch(
E                                   ^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 155, in run_cdi_example_torch
E       train_results = train_cdi_model_torch(train_data, test_data, config)
E                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 989, in train_cdi_model_torch
E       results = _train_with_lightning(train_container, test_container, config)
E                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 742, in _train_with_lightning
E       raise RuntimeError(f"Lightning training failed. See logs for details.") from e
E   RuntimeError: Lightning training failed. See logs for details.
____________________ test_run_pytorch_train_save_load_infer ____________________
tests/torch/test_integration_workflow_torch.py:262: in test_run_pytorch_train_save_load_infer
    result = _run_pytorch_workflow(tmp_path, data_file, cuda_cpu_env)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/torch/test_integration_workflow_torch.py:120: in _run_pytorch_workflow
    raise RuntimeError(
E   RuntimeError: PyTorch training failed with return code 1
E   STDOUT:
E   No GPU found, using CPU instead.
E   Using new CLI interface with factory-based config (ADR-003)
E   Creating configuration via factory (CONFIG-001 compliance)...
E   ✓ Factory created configs: N=64, gridsize=(1, 1), epochs=2
E   ✓ Execution config: accelerator=cpu, deterministic=True, learning_rate=0.001
E   Starting training with 2 epochs...
E   diff3d shape: (64, 64, 64)
E   probeGuess shape: (64, 64)
E   scan_index shape: (64,)
E   objectGuess shape: (227, 226)
E   xcoords shape: (64,)
E   ycoords shape: (64,)
E   xcoords_start shape: (64,)
E   ycoords_start shape: (64,)
E   diff3d shape: (64, 64, 64)
E   probeGuess shape: (64, 64)
E   scan_index shape: (64,)
E   objectGuess shape: (227, 226)
E   xcoords shape: (64,)
E   ycoords shape: (64,)
E   xcoords_start shape: (64,)
E   ycoords_start shape: (64,)
E   diff3d shape: (64, 64, 64)
E   probeGuess shape: (64, 64)
E   scan_index shape: (64,)
E   objectGuess shape: (227, 226)
E   xcoords shape: (64,)
E   ycoords shape: (64,)
E   xcoords_start shape: (64,)
E   ycoords_start shape: (64,)
E   DEBUG: nsamples: 64, gridsize: 1 (using efficient random sample-then-group strategy)
E   INFO: 'Y' array not found. Generating ground truth patches from 'objectGuess' as a fallback.
E   neighbor-sampled diffraction shape (64, 64, 64, 1)
E   diff3d shape: (64, 64, 64)
E   probeGuess shape: (64, 64)
E   scan_index shape: (64,)
E   objectGuess shape: (227, 226)
E   xcoords shape: (64,)
E   ycoords shape: (64,)
E   xcoords_start shape: (64,)
E   ycoords_start shape: (64,)
E   DEBUG: nsamples: 64, gridsize: 1 (using efficient random sample-then-group strategy)
E   INFO: 'Y' array not found. Generating ground truth patches from 'objectGuess' as a fallback.
E   neighbor-sampled diffraction shape (64, 64, 64, 1)
E   Decoder Block 1: No attention module added.
E   Decoder Block 2: No attention module added.
E   Decoder Block 1: No attention module added.
E   Decoder Block 2: No attention module added.
E   Training failed: Lightning training failed. See logs for details.
E   
E   STDERR:
E   2025-10-20 08:50:55.632328: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
E   WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E   E0000 00:00:1760975455.643245 1798784 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
E   E0000 00:00:1760975455.646902 1798784 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
E   W0000 00:00:1760975455.657217 1798784 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   W0000 00:00:1760975455.657228 1798784 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   W0000 00:00:1760975455.657229 1798784 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   W0000 00:00:1760975455.657231 1798784 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
E   2025-10-20 08:50:57.628793: E external/local_xla/xla/stream_executor/cuda/cuda_platform.cc:51] failed call to cuInit: INTERNAL: CUDA error: Failed call to cuInit: CUDA_ERROR_NO_DEVICE: no CUDA-capable device is detected
E   /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:608: UserWarning: params.cfg already populated. Set force=True to overwrite existing values.
E     warnings.warn(
E   WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E   I0000 00:00:1760975460.098939 1798784 service.cc:152] XLA service 0x1909f270 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
E   I0000 00:00:1760975460.098969 1798784 service.cc:160]   StreamExecutor device (0): Host, Default Version
E   I0000 00:00:1760975460.214825 1798784 device_compiler.h:188] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.
E   /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:257: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
E     tf_training_config = to_training_config(
E   Seed set to 42
E   INFO:pytorch_lightning.utilities.rank_zero:GPU available: False, used: False
E   INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
E   INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
E   
E     | Name  | Type        | Params | Mode 
E   ----------------------------------------------
E   0 | model | PtychoPINN  | 2.3 M  | train
E   1 | Loss  | PoissonLoss | 0      | train
E   ----------------------------------------------
E   2.3 M     Trainable params
E   0         Non-trainable params
E   2.3 M     Total params
E   9.345     Total estimated model params size (MB)
E   73        Modules in train mode
E   0         Modules in eval mode
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:433: The 'val_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/core/module.py:520: You called `self.log('poisson_val_loss', ..., logger=True)` but have no logger configured. You can enable one by doing `Trainer(logger=ALogger(...))`
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:433: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
E   /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/core/module.py:520: You called `self.log('poisson_train_loss', ..., logger=True)` but have no logger configured. You can enable one by doing `Trainer(logger=ALogger(...))`
E   ERROR:ptycho_torch.workflows.components:Lightning training failed: Early stopping conditioned on metric `val_loss` which is not available. Pass in or modify your `EarlyStopping` callback to use any of the following: `training_stage`, `training_stage_step`, `physics_weight`, `physics_weight_step`, `poisson_train_loss`, `poisson_train_loss_step`, `training_stage_epoch`, `physics_weight_epoch`, `poisson_val_loss`, `learning_rate`, `poisson_train_loss_epoch`
E   Traceback (most recent call last):
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 739, in _train_with_lightning
E       trainer.fit(model, train_dataloaders=train_loader, val_dataloaders=val_loader)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 560, in fit
E       call._call_and_handle_interrupt(
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py", line 49, in _call_and_handle_interrupt
E       return trainer_fn(*args, **kwargs)
E              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 598, in _fit_impl
E       self._run(model, ckpt_path=ckpt_path)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 1011, in _run
E       results = self._run_stage()
E                 ^^^^^^^^^^^^^^^^^
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py", line 1055, in _run_stage
E       self.fit_loop.run()
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py", line 217, in run
E       self.on_advance_end()
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py", line 473, in on_advance_end
E       call._call_callback_hooks(trainer, "on_train_epoch_end", monitoring_callbacks=True)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py", line 228, in _call_callback_hooks
E       fn(trainer, trainer.lightning_module, *args, **kwargs)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py", line 190, in on_train_epoch_end
E       self._run_early_stopping_check(trainer)
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py", line 202, in _run_early_stopping_check
E       if trainer.fast_dev_run or not self._validate_condition_metric(  # disable early_stopping with fast_dev_run
E                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py", line 153, in _validate_condition_metric
E       raise RuntimeError(error_msg)
E   RuntimeError: Early stopping conditioned on metric `val_loss` which is not available. Pass in or modify your `EarlyStopping` callback to use any of the following: `training_stage`, `training_stage_step`, `physics_weight`, `physics_weight_step`, `poisson_train_loss`, `poisson_train_loss_step`, `training_stage_epoch`, `physics_weight_epoch`, `poisson_val_loss`, `learning_rate`, `poisson_train_loss_epoch`
E   
E   The above exception was the direct cause of the following exception:
E   
E   Traceback (most recent call last):
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/train.py", line 671, in cli_main
E       amplitude, phase, results = run_cdi_example_torch(
E                                   ^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 155, in run_cdi_example_torch
E       train_results = train_cdi_model_torch(train_data, test_data, config)
E                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 989, in train_cdi_model_torch
E       results = _train_with_lightning(train_container, test_container, config)
E                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E     File "/home/ollie/Documents/PtychoPINN2/ptycho_torch/workflows/components.py", line 742, in _train_with_lightning
E       raise RuntimeError(f"Lightning training failed. See logs for details.") from e
E   RuntimeError: Lightning training failed. See logs for details.
__ TestWorkflowsComponentsTraining.test_lightning_training_respects_gridsize ___
ptycho_torch/workflows/components.py:739: in _train_with_lightning
    trainer.fit(model, train_dataloaders=train_loader, val_dataloaders=val_loader)
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py:560: in fit
    call._call_and_handle_interrupt(
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py:49: in _call_and_handle_interrupt
    return trainer_fn(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py:598: in _fit_impl
    self._run(model, ckpt_path=ckpt_path)
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py:1011: in _run
    results = self._run_stage()
              ^^^^^^^^^^^^^^^^^
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/trainer.py:1055: in _run_stage
    self.fit_loop.run()
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py:217: in run
    self.on_advance_end()
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/loops/fit_loop.py:473: in on_advance_end
    call._call_callback_hooks(trainer, "on_train_epoch_end", monitoring_callbacks=True)
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py:228: in _call_callback_hooks
    fn(trainer, trainer.lightning_module, *args, **kwargs)
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py:190: in on_train_epoch_end
    self._run_early_stopping_check(trainer)
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py:202: in _run_early_stopping_check
    if trainer.fast_dev_run or not self._validate_condition_metric(  # disable early_stopping with fast_dev_run
../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/early_stopping.py:153: in _validate_condition_metric
    raise RuntimeError(error_msg)
E   RuntimeError: Early stopping conditioned on metric `val_loss` which is not available. Pass in or modify your `EarlyStopping` callback to use any of the following: ``

The above exception was the direct cause of the following exception:
tests/torch/test_workflows_components.py:694: in test_lightning_training_respects_gridsize
    results = torch_components._train_with_lightning(
ptycho_torch/workflows/components.py:742: in _train_with_lightning
    raise RuntimeError(f"Lightning training failed. See logs for details.") from e
E   RuntimeError: Lightning training failed. See logs for details.
---------------------------- Captured stdout setup -----------------------------
diff3d shape: (10, 64, 64)
probeGuess shape: (64, 64)
scan_index shape: (10,)
xcoords shape: (10,)
ycoords shape: (10,)
xcoords_start shape: (10,)
ycoords_start shape: (10,)
----------------------------- Captured stdout call -----------------------------
Decoder Block 1: No attention module added.
Decoder Block 2: No attention module added.
Decoder Block 1: No attention module added.
Decoder Block 2: No attention module added.
----------------------------- Captured stderr call -----------------------------
INFO: Seed set to 42
INFO: 
  | Name         | Type | Params | Mode
---------------------------------------------
  | other params | n/a  | 1      | n/a 
---------------------------------------------
1         Trainable params
0         Non-trainable params
1         Total params
0.000     Total estimated model params size (MB)
0         Modules in train mode
0         Modules in eval mode
------------------------------ Captured log call -------------------------------
INFO     lightning.fabric.utilities.seed:seed.py:57 Seed set to 42
INFO     pytorch_lightning.utilities.rank_zero:setup.py:156 GPU available: True (cuda), used: False
INFO     pytorch_lightning.utilities.rank_zero:setup.py:159 TPU available: False, using: 0 TPU cores
INFO     pytorch_lightning.utilities.rank_zero:setup.py:169 HPU available: False, using: 0 HPUs
INFO     lightning.pytorch.callbacks.model_summary:model_summary.py:104 
  | Name         | Type | Params | Mode
---------------------------------------------
  | other params | n/a  | 1      | n/a 
---------------------------------------------
1         Trainable params
0         Non-trainable params
1         Total params
0.000     Total estimated model params size (MB)
0         Modules in train mode
0         Modules in eval mode
ERROR    ptycho_torch.workflows.components:components.py:741 Lightning training failed: Early stopping conditioned on metric `val_loss` which is not available. Pass in or modify your `EarlyStopping` callback to use any of the following: ``
___ TestTrainWithLightningRed.test_train_with_lightning_instantiates_module ____
tests/torch/test_workflows_components.py:1332: in test_train_with_lightning_instantiates_module
    results = torch_components._train_with_lightning(
ptycho_torch/workflows/components.py:649: in _train_with_lightning
    payload = create_training_payload(
ptycho_torch/config_factory.py:180: in create_training_payload
    raise FileNotFoundError(f"Training data file not found: {train_data_file}")
E   FileNotFoundError: Training data file not found: /tmp/dummy_train.npz
---------------------------- Captured stdout setup -----------------------------
diff3d shape: (10, 64, 64)
probeGuess shape: (64, 64)
scan_index shape: (10,)
xcoords shape: (10,)
ycoords shape: (10,)
xcoords_start shape: (10,)
ycoords_start shape: (10,)
_____ TestTrainWithLightningRed.test_train_with_lightning_runs_trainer_fit _____
tests/torch/test_workflows_components.py:1433: in test_train_with_lightning_runs_trainer_fit
    results = torch_components._train_with_lightning(
ptycho_torch/workflows/components.py:649: in _train_with_lightning
    payload = create_training_payload(
ptycho_torch/config_factory.py:180: in create_training_payload
    raise FileNotFoundError(f"Training data file not found: {train_data_file}")
E   FileNotFoundError: Training data file not found: /tmp/dummy_train.npz
---------------------------- Captured stdout setup -----------------------------
diff3d shape: (10, 64, 64)
probeGuess shape: (64, 64)
scan_index shape: (10,)
xcoords shape: (10,)
ycoords shape: (10,)
xcoords_start shape: (10,)
ycoords_start shape: (10,)
___ TestTrainWithLightningRed.test_train_with_lightning_returns_models_dict ____
tests/torch/test_workflows_components.py:1513: in test_train_with_lightning_returns_models_dict
    results = torch_components._train_with_lightning(
ptycho_torch/workflows/components.py:649: in _train_with_lightning
    payload = create_training_payload(
ptycho_torch/config_factory.py:180: in create_training_payload
    raise FileNotFoundError(f"Training data file not found: {train_data_file}")
E   FileNotFoundError: Training data file not found: /tmp/dummy_train.npz
---------------------------- Captured stdout setup -----------------------------
diff3d shape: (10, 64, 64)
probeGuess shape: (64, 64)
scan_index shape: (10,)
xcoords shape: (10,)
ycoords shape: (10,)
xcoords_start shape: (10,)
ycoords_start shape: (10,)
_____ TestTrainWithLightningGreen.test_execution_config_overrides_trainer ______
tests/torch/test_workflows_components.py:2535: in test_execution_config_overrides_trainer
    results = torch_components._train_with_lightning(
ptycho_torch/workflows/components.py:649: in _train_with_lightning
    payload = create_training_payload(
ptycho_torch/config_factory.py:180: in create_training_payload
    raise FileNotFoundError(f"Training data file not found: {train_data_file}")
E   FileNotFoundError: Training data file not found: /tmp/dummy_train.npz
---------------------------- Captured stdout setup -----------------------------
diff3d shape: (10, 64, 64)
probeGuess shape: (64, 64)
scan_index shape: (10,)
xcoords shape: (10,)
ycoords shape: (10,)
xcoords_start shape: (10,)
ycoords_start shape: (10,)
____ TestTrainWithLightningGreen.test_execution_config_controls_determinism ____
tests/torch/test_workflows_components.py:2629: in test_execution_config_controls_determinism
    results = torch_components._train_with_lightning(
ptycho_torch/workflows/components.py:649: in _train_with_lightning
    payload = create_training_payload(
ptycho_torch/config_factory.py:180: in create_training_payload
    raise FileNotFoundError(f"Training data file not found: {train_data_file}")
E   FileNotFoundError: Training data file not found: /tmp/dummy_train.npz
---------------------------- Captured stdout setup -----------------------------
diff3d shape: (10, 64, 64)
probeGuess shape: (64, 64)
scan_index shape: (10,)
xcoords shape: (10,)
ycoords shape: (10,)
xcoords_start shape: (10,)
ycoords_start shape: (10,)
__ TestLightningCheckpointCallbacks.test_model_checkpoint_callback_configured __
tests/torch/test_workflows_components.py:2851: in test_model_checkpoint_callback_configured
    assert mock_checkpoint_cls.called, \
E   AssertionError: ModelCheckpoint not instantiated (_train_with_lightning does not wire checkpoint callback)
E   assert False
E    +  where False = <MagicMock spec='ModelCheckpoint' id='132529744809168'>.called
___ TestLightningCheckpointCallbacks.test_early_stopping_callback_configured ___
tests/torch/test_workflows_components.py:2920: in test_early_stopping_callback_configured
    assert mock_early_stop_cls.called, \
E   AssertionError: EarlyStopping not instantiated (_train_with_lightning does not wire early stopping callback)
E   assert False
E    +  where False = <MagicMock spec='EarlyStopping' id='132527530443984'>.called
=============================== warnings summary ===============================
tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_num_workers_flag_roundtrip
  /home/ollie/Documents/PtychoPINN2/ptycho_torch/train.py:607: UserWarning: Deterministic mode with num_workers=4 may cause performance degradation. Consider setting --num-workers 0 for reproducibility.
    execution_config = build_execution_config_from_args(args, mode='training')

tests/torch/test_cli_train_torch.py::TestExecutionConfigCLI::test_bundle_persistence
  /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:547: UserWarning: Error reading probeGuess from /tmp/pytest-of-ollie/pytest-781/test_bundle_persistence0/train.npz: No data left in file. Using fallback N=64.
    warnings.warn(

tests/torch/test_cli_train_torch.py: 1 warning
tests/torch/test_config_factory.py: 18 warnings
tests/torch/test_workflows_components.py: 1 warning
  /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:257: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_training_config = to_training_config(

tests/torch/test_cli_train_torch.py: 1 warning
tests/torch/test_config_factory.py: 21 warnings
tests/torch/test_workflows_components.py: 1 warning
  /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:608: UserWarning: params.cfg already populated. Set force=True to overwrite existing values.
    warnings.warn(

tests/torch/test_config_bridge.py::TestConfigBridgeMVP::test_mvp_config_bridge_populates_params_cfg
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:100: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    spec_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_direct_fields[batch_size-direct]
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:235: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_transform_fields[nepochs-rename]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_transform_fields[nll_weight-true]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_transform_fields[nll_weight-false]
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:298: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[mae_weight-default]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[mae_weight-override]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[realspace_mae_weight-default]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[realspace_weight-default]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[positions_provided-default]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[probe_trainable-default]
tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_override_fields[sequential_sampling-default]
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:366: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_default_divergence_detection[nphotons-divergence]
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:493: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_train_data_file_required_error
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:575: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_nphotons_override_passes_validation
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:666: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_n_subsample_missing_override_uses_none
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:707: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_bridge.py::TestConfigBridgeParity::test_training_config_n_subsample_explicit_override
  /home/ollie/Documents/PtychoPINN2/tests/torch/test_config_bridge.py:742: UserWarning: test_data_file not provided in TrainingConfig overrides. Evaluation workflows require test_data_file to be set during inference update. Consider providing: overrides=dict(..., test_data_file=Path('test.npz'))
    tf_train = config_bridge.to_training_config(

tests/torch/test_config_factory.py::TestProbeSizeInference::test_infer_probe_size_missing_file_fallback
  /home/ollie/Documents/PtychoPINN2/ptycho_torch/config_factory.py:541: UserWarning: Data file /nonexistent/data.npz not found. Using fallback N=64.
    warnings.warn(

tests/torch/test_lightning_checkpoint.py::TestLightningCheckpointSerialization::test_checkpoint_contains_hyperparameters
tests/torch/test_lightning_checkpoint.py::TestLightningCheckpointSerialization::test_load_from_checkpoint_without_kwargs
tests/torch/test_lightning_checkpoint.py::TestLightningCheckpointSerialization::test_checkpoint_configs_are_serializable
tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_training_respects_gridsize
  /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/setup.py:177: GPU available but not used. You can set it by doing `Trainer(accelerator='gpu')`.

tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_poisson_count_contract
  /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/core/module.py:449: You are trying to `self.log()` but the `self.trainer` reference is not registered on the model yet. This is most likely because the model hasn't been passed to the `Trainer`

tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_training_respects_gridsize
  /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/callbacks/model_checkpoint.py:751: Checkpoint directory /home/ollie/Documents/PtychoPINN2/training_outputs/checkpoints exists and is not empty.

tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_training_respects_gridsize
  /home/ollie/miniconda3/envs/ptycho311/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:433: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
SKIPPED [1] tests/test_benchmark_throughput.py:11: scripts/benchmark_inference_throughput.py not found. This is a pre-existing broken test dependency. Add to fix_plan.md for future resolution.
SKIPPED [1] tests/test_run_baseline.py:4: tests/test_utilities.py not found. This is a pre-existing broken test dependency. Add to fix_plan.md for future resolution.
SKIPPED [1] tests/test_generic_loader.py:46: Data loading failed:
SKIPPED [1] tests/test_integration_baseline_gs2.py:27: Test data not found at /home/ollie/Documents/PtychoPINN2/datasets/fly/fly001_transposed.npz
SKIPPED [1] ../../miniconda3/envs/ptycho311/lib/python3.11/site-packages/_pytest/unittest.py:385: Deprecated: generate_simulated_data API changed from (obj,probe,nimages) to (config,obj,probe) and memoization disabled
SKIPPED [1] tests/test_tf_helper.py:199: TensorFlow Addons removed in TF 2.19 migration
SKIPPED [1] tests/test_tf_helper_edge_aware.py:47: tensorflow_addons not available
SKIPPED [1] tests/test_tf_helper_edge_aware.py:86: tensorflow_addons not available
SKIPPED [1] tests/test_tf_helper_edge_aware.py:198: tensorflow_addons not available
SKIPPED [1] tests/test_tf_helper_edge_aware.py:169: tensorflow_addons not available
SKIPPED [1] tests/test_tf_helper_edge_aware.py:257: tensorflow_addons not available
SKIPPED [1] tests/test_tf_helper_edge_aware.py:227: tensorflow_addons not available
SKIPPED [2] tests/torch/test_integration_workflow_torch.py: Migrated to pytest-native test_run_pytorch_train_save_load_infer
SKIPPED [1] tests/torch/test_tf_helper.py:64: torch tf_helper module not available
SKIPPED [1] tests/torch/test_tf_helper.py:57: torch tf_helper module not available
SKIPPED [1] tests/torch/test_tf_helper.py:74: torch tf_helper module not available - tests would fail
FAILED tests/torch/test_integration_workflow_torch.py::test_bundle_loader_returns_modules
FAILED tests/torch/test_integration_workflow_torch.py::test_run_pytorch_train_save_load_infer
FAILED tests/torch/test_workflows_components.py::TestWorkflowsComponentsTraining::test_lightning_training_respects_gridsize
FAILED tests/torch/test_workflows_components.py::TestTrainWithLightningRed::test_train_with_lightning_instantiates_module
FAILED tests/torch/test_workflows_components.py::TestTrainWithLightningRed::test_train_with_lightning_runs_trainer_fit
FAILED tests/torch/test_workflows_components.py::TestTrainWithLightningRed::test_train_with_lightning_returns_models_dict
FAILED tests/torch/test_workflows_components.py::TestTrainWithLightningGreen::test_execution_config_overrides_trainer
FAILED tests/torch/test_workflows_components.py::TestTrainWithLightningGreen::test_execution_config_controls_determinism
FAILED tests/torch/test_workflows_components.py::TestLightningCheckpointCallbacks::test_model_checkpoint_callback_configured
FAILED tests/torch/test_workflows_components.py::TestLightningCheckpointCallbacks::test_early_stopping_callback_configured
===== 10 failed, 318 passed, 17 skipped, 70 warnings in 236.05s (0:03:56) ======
