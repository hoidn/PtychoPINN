============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 2 items

<Dir PtychoPINN2>
  <Package tests>
    <Dir torch>
      <Module test_api_deprecation.py>
        Test suite for ptycho_torch.api deprecation warnings per ADR-003 Phase E.C1.
        
        Validates that legacy API entry points emit DeprecationWarning with migration
        guidance steering users toward factory-driven workflows documented in
        docs/workflows/pytorch.md.
        
        Reference:
        - SPEC: specs/ptychodus_api_spec.md (no explicit deprecation contract, but
          follows CLI logger deprecation semantics at ยง4.9)
        - ARCH: plans/active/ADR-003-BACKEND-API/reports/2025-10-20T134500Z/
                phase_e_governance_adr_addendum/adr_addendum.md:295-334
          (defers legacy API decision to Phase E.C1)
        - WORKFLOW: docs/workflows/pytorch.md:188-196 flags ptycho_torch/api as
                    deprecated surface needing migration instructions
        
        Test Strategy:
        - RED Phase: Import legacy modules expecting DeprecationWarning via
          warnings.catch_warnings context manager (stacklevel=2 ensures caller sees
          accurate origin).
        - GREEN Phase: After warn_legacy_api_import implementation, validate warning
          message content includes migration keywords (ptycho_train_torch, config_factory).
        - No behavior changes: legacy modules remain functional; only messaging added.
        <Class TestLegacyAPIDeprecation>
          Validate DeprecationWarning emission for ptycho_torch.api legacy entry points.
          
          Per input.md guidance:
          - Use warnings.warn(..., DeprecationWarning, stacklevel=2) for accurate stack origin
          - Ensure tests clear sys.modules or use importlib.reload for reliable warning capture
          - Keep warning message consistent across modules (centralized in __init__.py)
          <Function test_example_train_import_emits_deprecation_warning>
            Test that importing ptycho_torch.api package emits DeprecationWarning.
            
            RED Expectation:
            - AssertionError or no warning captured (warn_legacy_api_import not yet implemented)
            
            GREEN Expectation:
            - Exactly one DeprecationWarning captured
            - Warning message contains migration guidance keywords:
              * 'ptycho_train_torch' or 'CLI'
              * 'config_factory' or 'factory'
              * 'deprecated' or 'legacy'
            
            Evidence Parameter Validation:
            - Source: ptycho_torch/api/__init__.py (legacy API package init)
            - Mechanism: import triggers __init__.py module-level warn_legacy_api_import() call
            - Validation: stacklevel=2 ensures warning points to test frame, not __init__.py
            
            Note: We import the package (not example_train.py) to avoid executing
            hardcoded training logic that expects GPU and specific data paths.
          <Function test_api_package_import_is_idempotent>
            Test that repeated imports of ptycho_torch.api emit warning only once.
            
            Validates that DeprecationWarning is not suppressed by Python's warning
            filter after first emission, ensuring users see the message on first use.
            
            Strategy: Import package twice without clearing sys.modules between imports.
            Expected: Warning fires on first import, not on second (Python default behavior).

========================== 2 tests collected in 0.80s ==========================
