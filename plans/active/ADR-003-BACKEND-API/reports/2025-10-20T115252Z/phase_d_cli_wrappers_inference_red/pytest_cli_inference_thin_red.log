============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0 -- /home/ollie/miniconda3/envs/ptycho311/bin/python3.11
cachedir: .pytest_cache
PyTorch: available
PyTorch version: 2.8.0+cu128
rootdir: /home/ollie/Documents/PtychoPINN2
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 9 items

tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_accelerator_flag_roundtrip PASSED [ 11%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_num_workers_flag_roundtrip PASSED [ 22%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_inference_batch_size_flag_roundtrip PASSED [ 33%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLI::test_multiple_execution_config_flags PASSED [ 44%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_validate_paths FAILED [ 55%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_helper_for_data_loading FAILED [ 66%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_inference_helper FAILED [ 77%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_calls_save_individual_reconstructions FAILED [ 88%]
tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_quiet_flag_suppresses_progress_output FAILED [100%]

=================================== FAILURES ===================================
_______ TestInferenceCLIThinWrapper.test_cli_delegates_to_validate_paths _______

self = <test_cli_inference_torch.TestInferenceCLIThinWrapper object at 0x75937f84a450>
minimal_inference_args = ['--model_path', '/tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_validate0/model', '--test_data', '/tmp/pytest-...e0/test.npz', '--output_dir', '/tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_validate0/inference_outputs', ...]
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7592aecd1a90>

    def test_cli_delegates_to_validate_paths(self, minimal_inference_args, monkeypatch):
        """
        RED Test: CLI calls validate_paths() before factory invocation.
    
        Expected RED Failure:
        - AssertionError: validate_paths() not called (inline validation still present)
    
        Success Criteria (GREEN):
        - validate_paths() called exactly once with (train_file=None, test_file, output_dir)
        - Called BEFORE create_inference_payload (CONFIG-001 ordering)
        """
        from unittest.mock import MagicMock, patch, call
    
        mock_validate_paths = MagicMock()
        mock_factory = MagicMock()
        mock_factory.return_value = MagicMock(
            tf_inference_config=MagicMock(n_groups=32),
            pt_data_config=MagicMock(),
            execution_config=MagicMock(accelerator='cpu'),
        )
        mock_bundle_loader = MagicMock(return_value=({}, {}))
        mock_raw_data = MagicMock()
    
        with patch('ptycho_torch.cli.shared.validate_paths', mock_validate_paths), \
             patch('ptycho_torch.config_factory.create_inference_payload', mock_factory), \
             patch('ptycho_torch.workflows.components.load_inference_bundle_torch', mock_bundle_loader), \
             patch('ptycho.raw_data.RawData.from_file', return_value=mock_raw_data):
    
            from ptycho_torch.inference import cli_main
            monkeypatch.setattr('sys.argv', ['inference.py'] + minimal_inference_args)
    
            try:
                cli_main()
            except (SystemExit, Exception):
                pass  # Expected to fail after helper calls
    
        # Assert validate_paths was called
>       assert mock_validate_paths.called, \
            "validate_paths() was not called - CLI still using inline validation"
E       AssertionError: validate_paths() was not called - CLI still using inline validation
E       assert False
E        +  where False = <MagicMock id='129272858352400'>.called

tests/torch/test_cli_inference_torch.py:274: AssertionError
----------------------------- Captured stdout call -----------------------------
Loaded configuration from model checkpoint
Test data: /tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_validate0/test.npz
Output directory: /tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_validate0/inference_outputs
N groups: 32
Execution config: accelerator=cpu, num_workers=<MagicMock name='mock().execution_config.num_workers' id='129272858454480'>
__ TestInferenceCLIThinWrapper.test_cli_delegates_to_helper_for_data_loading ___

self = <test_cli_inference_torch.TestInferenceCLIThinWrapper object at 0x75937f84b190>
minimal_inference_args = ['--model_path', '/tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_helper_f0/model', '--test_data', '/tmp/pytest-...f0/test.npz', '--output_dir', '/tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_helper_f0/inference_outputs', ...]
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7592aecaaed0>

    def test_cli_delegates_to_helper_for_data_loading(self, minimal_inference_args, monkeypatch):
        """
        RED Test: CLI calls RawData.from_file() for test data loading.
    
        Expected RED Failure:
        - May pass if current CLI already loads RawData (Option A decision)
        - OR may fail if workflow is expected to load data (Option B)
    
        Success Criteria (GREEN):
        - RawData.from_file() called exactly once with test_data path
        - Called AFTER factory invocation (CONFIG-001 already satisfied)
        """
        from unittest.mock import MagicMock, patch
    
        mock_validate_paths = MagicMock()
        mock_factory = MagicMock()
        mock_factory.return_value = MagicMock(
            tf_inference_config=MagicMock(n_groups=32),
            pt_data_config=MagicMock(),
            execution_config=MagicMock(accelerator='cpu'),
        )
        mock_bundle_loader = MagicMock(return_value=({}, {}))
        mock_raw_data_from_file = MagicMock(return_value=MagicMock())
    
        with patch('ptycho_torch.cli.shared.validate_paths', mock_validate_paths), \
             patch('ptycho_torch.config_factory.create_inference_payload', mock_factory), \
             patch('ptycho_torch.workflows.components.load_inference_bundle_torch', mock_bundle_loader), \
             patch('ptycho.raw_data.RawData.from_file', mock_raw_data_from_file):
    
            from ptycho_torch.inference import cli_main
            monkeypatch.setattr('sys.argv', ['inference.py'] + minimal_inference_args)
    
            try:
                cli_main()
            except (SystemExit, Exception):
                pass
    
        # Assert RawData.from_file() was called
>       assert mock_raw_data_from_file.called, \
            "RawData.from_file() was not called - data loading delegation broken"
E       AssertionError: RawData.from_file() was not called - data loading delegation broken
E       assert False
E        +  where False = <MagicMock id='129272856946832'>.called

tests/torch/test_cli_inference_torch.py:321: AssertionError
----------------------------- Captured stdout call -----------------------------
Loaded configuration from model checkpoint
Test data: /tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_helper_f0/test.npz
Output directory: /tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_helper_f0/inference_outputs
N groups: 32
Execution config: accelerator=cpu, num_workers=<MagicMock name='mock().execution_config.num_workers' id='129272858483728'>
______ TestInferenceCLIThinWrapper.test_cli_delegates_to_inference_helper ______

self = <test_cli_inference_torch.TestInferenceCLIThinWrapper object at 0x75937f84b610>
minimal_inference_args = ['--model_path', '/tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_inferenc0/model', '--test_data', '/tmp/pytest-...c0/test.npz', '--output_dir', '/tmp/pytest-of-ollie/pytest-771/test_cli_delegates_to_inferenc0/inference_outputs', ...]
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7592aeb04190>

    def test_cli_delegates_to_inference_helper(self, minimal_inference_args, monkeypatch):
        """
        RED Test: CLI calls _run_inference_and_reconstruct() helper.
    
        Expected RED Failure:
        - AttributeError: module 'ptycho_torch.inference' has no attribute '_run_inference_and_reconstruct'
    
        Success Criteria (GREEN):
        - _run_inference_and_reconstruct() called with (model, raw_data, config, execution_config, device, quiet)
        - Returns (amplitude, phase) tuple
        """
        from unittest.mock import MagicMock, patch
    
        mock_validate_paths = MagicMock()
        mock_factory = MagicMock()
        mock_factory.return_value = MagicMock(
            tf_inference_config=MagicMock(n_groups=32),
            pt_data_config=MagicMock(),
            execution_config=MagicMock(accelerator='cpu'),
        )
        mock_bundle_loader = MagicMock(return_value=({'diffraction_to_obj': MagicMock()}, {}))
        mock_raw_data = MagicMock()
        mock_helper = MagicMock(return_value=(MagicMock(), MagicMock()))  # (amplitude, phase)
    
>       with patch('ptycho_torch.cli.shared.validate_paths', mock_validate_paths), \
             patch('ptycho_torch.config_factory.create_inference_payload', mock_factory), \
             patch('ptycho_torch.workflows.components.load_inference_bundle_torch', mock_bundle_loader), \
             patch('ptycho.raw_data.RawData.from_file', return_value=mock_raw_data), \
             patch('ptycho_torch.inference._run_inference_and_reconstruct', mock_helper):

tests/torch/test_cli_inference_torch.py:353: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../miniconda3/envs/ptycho311/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7592aece9950>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'ptycho_torch.inference' from '/home/ollie/Documents/PtychoPINN2/ptycho_torch/inference.py'> does not have the attribute '_run_inference_and_reconstruct'

../../miniconda3/envs/ptycho311/lib/python3.11/unittest/mock.py:1419: AttributeError
__ TestInferenceCLIThinWrapper.test_cli_calls_save_individual_reconstructions __

self = <test_cli_inference_torch.TestInferenceCLIThinWrapper object at 0x75937f84ba50>
minimal_inference_args = ['--model_path', '/tmp/pytest-of-ollie/pytest-771/test_cli_calls_save_individual0/model', '--test_data', '/tmp/pytest-...l0/test.npz', '--output_dir', '/tmp/pytest-of-ollie/pytest-771/test_cli_calls_save_individual0/inference_outputs', ...]
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7592aeb36210>

    def test_cli_calls_save_individual_reconstructions(self, minimal_inference_args, monkeypatch):
        """
        RED Test: CLI calls save_individual_reconstructions() after inference.
    
        Expected RED Failure:
        - May pass if current CLI already calls this function
        - OR assertion fails if call order incorrect
    
        Success Criteria (GREEN):
        - save_individual_reconstructions() called with (amplitude, phase, output_dir)
        - Called AFTER _run_inference_and_reconstruct() helper
        """
        from unittest.mock import MagicMock, patch
        import numpy as np
    
        mock_validate_paths = MagicMock()
        mock_factory = MagicMock()
        mock_factory.return_value = MagicMock(
            tf_inference_config=MagicMock(n_groups=32),
            pt_data_config=MagicMock(),
            execution_config=MagicMock(accelerator='cpu'),
        )
        mock_bundle_loader = MagicMock(return_value=({'diffraction_to_obj': MagicMock()}, {}))
        mock_raw_data = MagicMock()
        mock_amplitude = np.random.rand(64, 64)
        mock_phase = np.random.rand(64, 64)
        mock_helper = MagicMock(return_value=(mock_amplitude, mock_phase))
        mock_save_fn = MagicMock()
    
>       with patch('ptycho_torch.cli.shared.validate_paths', mock_validate_paths), \
             patch('ptycho_torch.config_factory.create_inference_payload', mock_factory), \
             patch('ptycho_torch.workflows.components.load_inference_bundle_torch', mock_bundle_loader), \
             patch('ptycho.raw_data.RawData.from_file', return_value=mock_raw_data), \
             patch('ptycho_torch.inference._run_inference_and_reconstruct', mock_helper), \
             patch('ptycho_torch.inference.save_individual_reconstructions', mock_save_fn):

tests/torch/test_cli_inference_torch.py:409: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../miniconda3/envs/ptycho311/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7592aeb01e50>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'ptycho_torch.inference' from '/home/ollie/Documents/PtychoPINN2/ptycho_torch/inference.py'> does not have the attribute '_run_inference_and_reconstruct'

../../miniconda3/envs/ptycho311/lib/python3.11/unittest/mock.py:1419: AttributeError
____ TestInferenceCLIThinWrapper.test_quiet_flag_suppresses_progress_output ____

self = <test_cli_inference_torch.TestInferenceCLIThinWrapper object at 0x75937f8483d0>
minimal_inference_args = ['--model_path', '/tmp/pytest-of-ollie/pytest-771/test_quiet_flag_suppresses_pro0/model', '--test_data', '/tmp/pytest-...o0/test.npz', '--output_dir', '/tmp/pytest-of-ollie/pytest-771/test_quiet_flag_suppresses_pro0/inference_outputs', ...]
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7592aeb02110>
capsys = <_pytest.capture.CaptureFixture object at 0x7592aeb02b50>

    def test_quiet_flag_suppresses_progress_output(self, minimal_inference_args, monkeypatch, capsys):
        """
        RED Test: --quiet flag suppresses CLI progress print statements.
    
        Expected RED Failure:
        - AssertionError: Progress output still printed when --quiet specified
    
        Success Criteria (GREEN):
        - No progress messages in stdout when --quiet flag present
        - enable_progress_bar=False passed to execution config
        """
        from unittest.mock import MagicMock, patch
    
        mock_validate_paths = MagicMock()
        mock_factory = MagicMock()
        mock_factory.return_value = MagicMock(
            tf_inference_config=MagicMock(n_groups=32),
            pt_data_config=MagicMock(),
            execution_config=MagicMock(accelerator='cpu', enable_progress_bar=False),
        )
        mock_bundle_loader = MagicMock(return_value=({'diffraction_to_obj': MagicMock()}, {}))
        mock_raw_data = MagicMock()
        mock_helper = MagicMock(return_value=(MagicMock(), MagicMock()))
    
>       with patch('ptycho_torch.cli.shared.validate_paths', mock_validate_paths), \
             patch('ptycho_torch.config_factory.create_inference_payload', mock_factory), \
             patch('ptycho_torch.workflows.components.load_inference_bundle_torch', mock_bundle_loader), \
             patch('ptycho.raw_data.RawData.from_file', return_value=mock_raw_data), \
             patch('ptycho_torch.inference._run_inference_and_reconstruct', mock_helper), \
             patch('ptycho_torch.inference.save_individual_reconstructions', MagicMock()):

tests/torch/test_cli_inference_torch.py:457: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../miniconda3/envs/ptycho311/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7592aebe8150>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'ptycho_torch.inference' from '/home/ollie/Documents/PtychoPINN2/ptycho_torch/inference.py'> does not have the attribute '_run_inference_and_reconstruct'

../../miniconda3/envs/ptycho311/lib/python3.11/unittest/mock.py:1419: AttributeError
=========================== short test summary info ============================
FAILED tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_validate_paths - AssertionError: validate_paths() was not called - CLI still using inline validation
assert False
 +  where False = <MagicMock id='129272858352400'>.called
FAILED tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_helper_for_data_loading - AssertionError: RawData.from_file() was not called - data loading delegation broken
assert False
 +  where False = <MagicMock id='129272856946832'>.called
FAILED tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_delegates_to_inference_helper - AttributeError: <module 'ptycho_torch.inference' from '/home/ollie/Documents/PtychoPINN2/ptycho_torch/inference.py'> does not have the attribute '_run_inference_and_reconstruct'
FAILED tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_cli_calls_save_individual_reconstructions - AttributeError: <module 'ptycho_torch.inference' from '/home/ollie/Documents/PtychoPINN2/ptycho_torch/inference.py'> does not have the attribute '_run_inference_and_reconstruct'
FAILED tests/torch/test_cli_inference_torch.py::TestInferenceCLIThinWrapper::test_quiet_flag_suppresses_progress_output - AttributeError: <module 'ptycho_torch.inference' from '/home/ollie/Documents/PtychoPINN2/ptycho_torch/inference.py'> does not have the attribute '_run_inference_and_reconstruct'
========================= 5 failed, 4 passed in 4.62s ==========================
