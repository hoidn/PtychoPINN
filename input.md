Summary: Build the reusable ssim_grid helper plus a smoke pytest so we can gate dense Phase G runs on fast preview-phase validation evidence.
Mode: TDD
Focus: STUDY-SYNTH-FLY64-DOSE-OVERLAP-001 — Phase G comparison & analysis (dense real evidence + automated report)
Branch: feature/torchapi-newprompt
Mapped tests: pytest tests/study/test_ssim_grid.py::test_smoke_ssim_grid -vv
Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-11T013612Z/ssim_grid_mvp/

Do Now (hard validity contract)
- Implement: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/bin/ssim_grid.py::main — new Tier-2 CLI that loads `<hub>/analysis/metrics_delta_summary.json`, enforces preview-phase-only content from `metrics_delta_highlights_preview.txt`, and writes `<hub>/analysis/ssim_grid_summary.md` with MS-SSIM ±0.000 and MAE ±0.000000 tables for vs_Baseline / vs_PtyChi.
- Implement: tests/study/test_ssim_grid.py::test_smoke_ssim_grid — tmp_path-based RED/GREEN coverage that first fails when preview text includes "amplitude" and then passes once the helper emits the markdown table and phase-only guard metadata.
- Validate: pytest tests/study/test_ssim_grid.py::test_smoke_ssim_grid -vv (capture RED log to `$HUB`/red/pytest_ssim_grid_smoke.log before implementation, then GREEN log to `$HUB`/green/pytest_ssim_grid_smoke.log) so PREVIEW-PHASE-001 has executable proof.
- Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-11T013612Z/ssim_grid_mvp/ (store summary.md plus pytest logs under red/ and green/).

How-To Map
1. export AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md; export HUB=$PWD/plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-11T013612Z/ssim_grid_mvp
2. mkdir -p "$HUB"/{analysis,collect,green,red,summary} and keep all helper outputs under these dirs (no repo-root log files).
3. Create the helper scaffold at plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/bin/ssim_grid.py using the Tier-2 template (argparse + docstring) and implement `main()` to: parse `--hub/--output`, read `<hub>/analysis/metrics_delta_summary.json`, render a markdown table (phase/amplitude, signed precision), and reject previews containing `amplitude` while surfacing offending lines.
4. Author tests/study/test_ssim_grid.py with pytest tmp_path fixtures: synthesize `metrics_delta_summary.json` + `metrics_delta_highlights_preview.txt`, run the helper via `subprocess.run([sys.executable, path_to_script, "--hub", hub])`, assert RED failure when preview includes `amplitude`, then write a phase-only preview and assert the script succeeds and the output markdown contains ± formatted numbers.
5. Run pytest tests/study/test_ssim_grid.py::test_smoke_ssim_grid -vv || true and tee stdout/stderr into "$HUB"/red/pytest_ssim_grid_smoke.log to capture the expected RED failure (preview amplitude guard) before implementation passes.
6. Finish implementing the helper until the test passes, then rerun pytest tests/study/test_ssim_grid.py::test_smoke_ssim_grid -vv | tee "$HUB"/green/pytest_ssim_grid_smoke.log and confirm exit code 0.
7. Run pytest --collect-only tests/study/test_ssim_grid.py -vv | tee "$HUB"/collect/pytest_collect_ssim_grid.log to prove the selector collects (>0) after the helper lands.
8. Copy a sample `analysis/ssim_grid_summary.md` (generated by the test hub) into "$HUB"/analysis/ for reference and summarize outcomes (preview guard status, precision formatting) inside "$HUB"/summary/summary.md along with references to PREVIEW-PHASE-001 / TYPE-PATH-001.

Pitfalls To Avoid
- Do not touch core modules under ptycho/* — new helper lives in plans/active bin only.
- Keep preview guard logic device/dtype agnostic; treat files as UTF-8 text and avoid numpy imports.
- Maintain TYPE-PATH-001: when writing JSON/markdown metadata, use POSIX-style relative paths (analysis/...); no absolute paths in artifacts.
- Ensure MS-SSIM remains ±0.000 while MAE is ±0.000000; do not regress formatting documented in docs/TESTING_GUIDE.md.
- Capture both RED and GREEN pytest logs; a missing RED log makes PREVIEW-PHASE-001 unverifiable.
- Use subprocess.run with `check=False` in the test to assert on exit codes manually; do not rely on global state.
- Avoid creating new evidence hubs until this one contains a counted run; stall-autonomy guard is in effect.
- No environment changes (pip install, etc.); if imports fail, record the signature and stop.

If Blocked
- If helper spec is unclear, halt implementation, record the ambiguity plus repro steps in `$HUB`/summary/summary.md, and update docs/fix_plan.md Attempts History as blocked.
- If pytest cannot locate the new selector, capture the `pytest --collect-only` output under `$HUB`/collect/` and stop; do not proceed to implementation until the test harness is recognized.
- If preview precision expectations conflict with docs/TESTING_GUIDE.md, note the discrepancy in docs/findings.md draft section and page Ralph for clarification before modifying specs.

Findings Applied (Mandatory)
- POLICY-001 — PyTorch dependency already satisfied; no optional downgrades permitted.
- CONFIG-001 — Always export AUTHORITATIVE_CMDS_DOC before touching helpers that depend on params.cfg bridge logic.
- DATA-001 — Test fixtures must honor official NPZ/JSON schema (keys/dtypes) even for tmp hubs.
- TYPE-PATH-001 — Ensure helper emits POSIX-relative paths in reports/markdown tables.
- STUDY-001 — Report MS-SSIM/MAE deltas with explicit ± signs and phase emphasis in the new summary table.
- TEST-CLI-001 — Capture real CLI/test logs per selector (red/green) under the hub so CLI validation remains reproducible.
- PREVIEW-PHASE-001 — Preview guard must fail whenever `amplitude` shows up; new helper/test enforce the policy.

Pointers
- docs/fix_plan.md:27 — Latest retrospective + SSIM grid MVP context.
- plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-11T213000Z/retrospective/analysis.md — stall/autonomy findings for this focus.
- plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/bin/verify_dense_pipeline_artifacts.py:309 — existing preview guard logic to align with.
- tests/study/test_phase_g_dense_artifacts_verifier.py:1921 — sample RED preview test references for parity of messaging.
- docs/TESTING_GUIDE.md:333 — current (stale) delta precision language to update once helper tables land.

Next Up (optional)
1. After helper/test pass, rerun `bin/run_phase_g_dense.py` once and use the new ssim_grid summary to publish MS-SSIM/MAE deltas.
2. Refresh docs/TESTING_GUIDE.md and docs/development/TEST_SUITE_INDEX.md to document the preview guard + helper workflow.

Doc Sync Plan (Conditional)
- After the helper/test pass, update docs/TESTING_GUIDE.md §2 (Phase G Delta Metrics Persistence) and docs/development/TEST_SUITE_INDEX.md (Phase G section) to reference `ssim_grid.py` and the new test selector; capture diffs plus a short note inside `$HUB`/summary/summary.md.
- Run pytest --collect-only tests/study/test_ssim_grid.py -vv (already in How-To Map) and store the log in `$HUB`/collect/pytest_collect_ssim_grid.log as evidence that the new selector registers.

Mapped Tests Guardrail
- Active selector `pytest tests/study/test_ssim_grid.py::test_smoke_ssim_grid -vv` must collect exactly one test; confirm via the collect-only step above before concluding the loop.

Hard Gate
- Do not mark this loop complete until the GREEN pytest log demonstrates the preview guard passing and `analysis/ssim_grid_summary.md` is archived in `$HUB`.
