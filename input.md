Summary: Fix Phase G dense comparisons by correcting job builder paths and regenerating dose_1000 assets so train/test executions can finish with real evidence.
Mode: TDD
Focus: STUDY-SYNTH-FLY64-DOSE-OVERLAP-001 — Phase G comparison & analysis (G2.1 dense execution)
Branch: feature/torchapi-newprompt
Mapped tests: pytest tests/study/test_dose_overlap_comparison.py -vv
Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/

Do Now:
- STUDY-SYNTH-FLY64-DOSE-OVERLAP-001 — G2.1 dense comparisons
  - Implement: studies/fly64_dose_overlap/comparison.py::build_comparison_jobs — point PINN/baseline references to dose-specific Phase E artifact directories (`dose_1000/{baseline|dense}/gs{1|2}`), ensure required bundles/baseline weights exist, and update ComparisonJob+executor wiring accordingly.
  - Validate: AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md pytest tests/study/test_dose_overlap_comparison.py -vv | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/green/pytest_phase_g_path_green.log
  - Generate Phase C dose=1000 datasets: AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.generation --base-npz tike_outputs/fly001_reconstructed_final_prepared/fly001_reconstructed_interp_smooth_both.npz --output-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/phase_c_generation.log
  - Build dense overlap views: AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.overlap --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --output-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --doses 1000 --views dense --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/analysis | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/phase_d_overlap.log
  - Run Phase E training (baseline): AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.training --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --dose 1000 --view baseline --gridsize 1 | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/training_baseline.log
  - Run Phase E training (dense gs2): AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.training --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --dose 1000 --view dense --gridsize 2 | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/training_dense.log
  - Run Phase F LSQML recon (dense/train): AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.reconstruction --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --dose 1000 --view dense --split train | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/reconstruction_dense_train.log
  - Run Phase F LSQML recon (dense/test): AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.reconstruction --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --dose 1000 --view dense --split test | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/reconstruction_dense_test.log
  - Execute dense/train comparison: AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.comparison --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-e-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --phase-f-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_train --dose 1000 --view dense --split train | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_train/comparison.log
  - Execute dense/test comparison: AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md python -m studies.fly64_dose_overlap.comparison --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-e-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --phase-f-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_test --dose 1000 --view dense --split test | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_test/comparison.log
  - Summarize: Update plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/analysis/summary.md with asset locations, comparison outcomes, and any anomalies; refresh docs/fix_plan.md attempts for this loop.
  - Artifacts: plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/

How-To Map:
- export AUTHORITATIVE_CMDS_DOC=./docs/TESTING_GUIDE.md
- pytest tests/study/test_dose_overlap_comparison.py -vv | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/green/pytest_phase_g_path_green.log
- python -m studies.fly64_dose_overlap.generation --base-npz tike_outputs/fly001_reconstructed_final_prepared/fly001_reconstructed_interp_smooth_both.npz --output-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/phase_c_generation.log
- python -m studies.fly64_dose_overlap.overlap --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --output-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --doses 1000 --views dense --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/analysis | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/phase_d_overlap.log
- python -m studies.fly64_dose_overlap.training --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --dose 1000 --view baseline --gridsize 1 | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/training_baseline.log
- python -m studies.fly64_dose_overlap.training --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --dose 1000 --view dense --gridsize 2 | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/training_dense.log
- python -m studies.fly64_dose_overlap.reconstruction --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --dose 1000 --view dense --split train | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/reconstruction_dense_train.log
- python -m studies.fly64_dose_overlap.reconstruction --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-d-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_d --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --dose 1000 --view dense --split test | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/reconstruction_dense_test.log
- python -m studies.fly64_dose_overlap.comparison --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-e-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --phase-f-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_train --dose 1000 --view dense --split train | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_train/comparison.log
- python -m studies.fly64_dose_overlap.comparison --phase-c-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/phase_c --phase-e-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/training --phase-f-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/data/reconstruction --artifact-root plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_test --dose 1000 --view dense --split test | tee plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/cli/dose1000_dense_test/comparison.log

Pitfalls To Avoid:
- Do not leave comparisons pointing at `tmp/phase_e_training_gs2/pinn`; new builder must target dose-specific directories with `wts.h5.zip` and `baseline_model.h5` present.
- Ensure Phase C/D regenerations use the same hub root as comparisons; mixing tmp paths will reintroduce FileNotFoundError during job validation.
- Confirm training CLI succeeds before running comparisons; abort if bundle archives or baseline weights are missing.
- Keep CLI runs CPU-bound by omitting unsupported flags (`--accelerator`, `--deterministic`, etc.).
- Capture all stdout via tee into the hub to preserve evidence; avoid overwriting prior logs.
- Preserve OVERSAMPLING-001 guarantees by rerunning overlap for the target dose rather than copying stale NPZs.
- Verify reconstruction outputs include `ptychi_reconstruction.npz`; comparisons rely on that artifact.

If Blocked:
- Tee failing command output to plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/reports/2025-11-07T010500Z/phase_g_execution_real_runs/analysis/blocker.log, mark Attempt as blocked in docs/fix_plan.md, and capture the error summary in analysis/summary.md before exiting.

Findings Applied (Mandatory):
- POLICY-001 — Comparisons call PyTorch-based LSQML; keep torch available and record environment assumptions.
- CONFIG-001 — Training/Comparison CLIs rely on update_legacy_dict internally; verify logs show the bridge before proceeding.
- DATA-001 — Regenerated NPZs must honour data_contracts.md; rerun validators implicitly via generation pipeline.
- OVERSAMPLING-001 — Dense view retains K≥C properties; avoid modifying overlap spacing thresholds.
- TYPE-PATH-001 — Use pathlib.Path consistently in new builder logic to prevent string path regressions.

Pointers:
- plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/implementation.md:189 — Phase G scope and deliverables.
- plans/active/STUDY-SYNTH-FLY64-DOSE-OVERLAP-001/test_strategy.md:250 — Phase G evidence checklist and selectors.
- docs/findings.md:8 — POLICY-001 PyTorch mandate.
- docs/findings.md:10 — CONFIG-001 initialization requirement.
- specs/ptychodus_api_spec.md:220 — Bundle manifest expectations for Phase E outputs.
- docs/TESTING_GUIDE.md:183 — Authoritative reconstruction CLI usage.

Next Up (optional):
- G2.2 sparse/train comparison once LSQML succeeds with regenerated sparse artifacts.
