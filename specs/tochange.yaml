files_requiring_updates:
  - path: "./ptycho/loader.py"
    reason: "Core data container needs to be modified to support multiple probes"
    changes_needed:
      - "Create new MultiPtychoDataContainer class extending PtychoDataContainer"
      - "Add probe_indices attribute to track probe assignments per sample"
      - "Add probe_list attribute to store multiple probes"
      - "Add method to merge multiple PtychoDataContainers with shuffling for training"
      - "Modify load() function to handle probe indices"
    dependencies:
      - "data_preprocessing.py"
      - "train_pinn.py"
      - "components.py"

  - path: "./ptycho/model.py" 
    reason: "Model needs to handle per-sample probe inputs"
    changes_needed:
      - "Modify ProbeIllumination layer to accept probe indices input"
      - "Update model input structure to accept probe indices"
      - "Change probe tensor handling from global variable to input-based"
    dependencies:
      - "tf_helper.py"
      - "train_pinn.py"

  - path: "./ptycho/data_preprocessing.py"
    reason: "Data generation and preprocessing needs to handle multiple probes"
    changes_needed:
      - "Update create_ptycho_dataset() to handle multiple probes"
      - "Modify data loading functions to track probe associations"
      - "Add probe index tracking in shuffle_data()"
    dependencies:
      - "loader.py"
      - "train_pinn.py"

  - path: "./ptycho/train_pinn.py"
    reason: "Training pipeline needs to handle datasets with multiple probes"
    changes_needed:
      - "Update train() to handle MultiPtychoDataContainer"
      - "Modify prepare_inputs() to include probe indices"
      - "Update train_eval() to handle multiple probe datasets"
    dependencies:
      - "model.py"
      - "loader.py"

architectural_impact:
  data_flow:
    - "Change from global probe tensor to per-sample probe tensors"
    - "New data structure for managing multiple probe datasets"
    - "Modified training pipeline to handle probe indices"
  
  api_changes:
    - "New MultiPtychoDataContainer class API"
    - "Modified model input interface"
    - "Changes to data preparation functions"

  performance_considerations:
    - "Memory usage for storing multiple probes"
    - "Impact of shuffling large datasets with probe tracking"
    - "Potential batch processing modifications"

questions_for_clarification:
  - "Should MultiPtychoDataContainer inherit from PtychoDataContainer or be a separate class?"
  - "How should probe switching be handled during batch processing?"
  - "What metadata should be preserved about probe-dataset relationships?"
  - "Should there be validation to ensure probe shapes match within a merged dataset?"
  - "How should probe indices be initialized when merging datasets?"
  - "Should there be a mechanism to track original dataset boundaries after merging?"